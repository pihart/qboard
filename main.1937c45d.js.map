{"version":3,"sources":["webpack:///./src/lib/action.ts","webpack:///./src/lib/keyboard.ts","webpack:///./src/components/Icon.tsx","webpack:///./src/components/OverlayButton.tsx","webpack:///./src/components/Pagination.tsx","webpack:///./src/components/UndoRedo.tsx","webpack:///./src/components/Toolbar.tsx","webpack:///./src/components/ButtonRow.tsx","webpack:///./src/components/StyleMenu.tsx","webpack:///./src/components/Stylebar.tsx","webpack:///./src/components/BindingModal.tsx","webpack:///./src/components/Bindings.tsx","webpack:///./src/components/HelpModal.tsx","webpack:///./src/components/ContextMenu.tsx","webpack:///./src/components/Overlay.tsx","webpack:///./src/lib/tools.ts","webpack:///./src/lib/page.ts","webpack:///./src/lib/files.ts","webpack:///./src/lib/pages.ts","webpack:///./src/lib/history.ts","webpack:///./src/lib/clipboard.ts","webpack:///./src/lib/styles.ts","webpack:///./src/index.js","webpack:///./src/lib/qboard.ts"],"names":["Action","nameMap","previousPage","nextPage","addPage","selectAll","duplicate","eraser","rectangle","transparent","halfFilled","resetStyles","fullScreen","enterFullScreen","exitFullScreen","actionName","action","name","toUpperCase","slice","switchTool","currentStyle","pages","files","history","clipboard","setStyle","doAction","async","this","actionMap","setDash","dash","setStroke","stroke","setFill","fill","canvas","nextOrNewPage","undo","redo","open","openFile","save","saveFile","export","cut","copy","paste","deselect","discardActiveObject","requestRenderAll","setActiveObject","fabric","ActiveSelection","getObjects","then","move","pen","laser","line","ellipse","dotted","dashed","solid","blue","green","yellow","orange","black","filled","document","fullscreenElement","ExitFullScreen","EnterFullScreen","documentElement","requestFullscreen","exitFullscreen","defaultKeys","q","Laser","w","Copy","e","Blue","esc","Deselect","r","Green","a","PreviousPage","s","NextPage","d","Pen","f","Undo","g","Paste","z","ResetStyles","x","Eraser","c","Line","v","Move","Dotted","Transparent","Ellipse","Rectangle","Dashed","HalfFilled","Black","Redo","Solid","Filled","Yellow","Orange","SelectAll","Save","Duplicate","Cut","mirrorMap","tab","t","shift","b","mirror","key","setStrict","updateState","keyMap","window","localStorage","setItem","JSON","stringify","bindAll","value","Object","entries","bind","unbind","reset","keys","getItem","parse","fasIcon","iconName","style","className","close","transform","file","color","viewBox","width","height","marginRight","position","left","opacity","top","props","undefined","onClick","callback","backgroundColor","effect","id","place","textColor","setValue","setWidth","currentPage","toString","length","navigate","page","Number","totalPages","loadPage","visibility","onSubmit","preventDefault","onChange","target","type","tabIndex","AddPage","canUndo","canRedo","tools","map","tool","index","currentTool","cName","outerButton","actions","i","DashStyle","dashes","button","dashStyle","inContext","StrokeStyle","strokes","strokeMap","strokeStyle","FillStyle","fills","fillStyle","fileInputRef","fileButton","fileActions","Open","Export","otherActions","mobileActions","isMobile","FullScreen","isFullscreen","setIsFullscreen","Boolean","addEventListener","accept","acceptFile","multiple","ref","current","click","setAppElement","nonBinding","overlayClassName","isOpen","letter","values","includes","HeaderKey","leftHanded","label","Key","bindingModalKeys","setBindingModalKeys","bindingModalAction","setBindingModalAction","rows","header","letters","split","getModified","modifier","keyHandler","reverse","keyModifier","setKeyModifier","setLeftHanded","toggleOpen","fontSize","fontWeight","marginLeft","wasLeftHanded","href","toggleMobility","coords","setCoords","oldCoords","clientX","clientY","qboard","setVisibility","helpModalOpen","setHelpModalOpen","setMobility","state","setState","dragActive","wasOpen","currentVisibility","execute","keyboard","wasMobile","rectify","dirs","y","x2","y2","ox","oy","vx","vy","side","sq","Math","abs","project","reduce","acc","cur","Handlers","isBrush","setBrush","brush","options","strokeDashArray","strokeWidth","draw","Promise","resolve","perPixelTargetFind","resize","object","strict","set","Rect","originX","originY","rx","ry","Canvas","latestId","modified","fitToWindow","canvasWidth","canvasHeight","widthRatio","innerWidth","heightRatio","innerHeight","setZoom","min","getZoom","setHeight","deactivateSelection","isDrawingMode","selection","forEachObject","selectable","activateSelection","getNextId","getObjectByIds","ids","filter","serialize","objects","getActiveObjects","reselect","some","obj","res","toObject","apply","newObjects","oldObjects","remove","addObjects","forEach","add","util","enlivenObjects","loadFromJSONAsync","json","super","loadFromJSON","placeObject","cursor","_objects","id_","AsyncReader","readAsText","reject","reader","FileReader","onload","result","onerror","readAsDataURL","readParsed","isValidQboardFile","JSONWriter","pagesJSON","stringified","sourceJSON","toBlob","Blob","toURL","url","URL","createObjectURL","revokeObjectURL","processFiles","images","all","startsWith","push","handleImage","handleJSON","flat","clear","savePage","overwritePages","read","Image","fromURL","insertPages","currentIndex","defaultPageJSON","version","background","timeString","offset","Date","getTimezoneOffset","now","toISOString","replace","fromFile","force","newPage","splice","content","currentIndexCopy","svg","toSVG","docDefinition","pageSize","pageMargins","createPdf","download","fileURL","revokeURL","elt","createElement","display","body","appendChild","parentElement","removeChild","every","confirm","HistoryHandler","redoStack","locked","command","clearRedo","store","modify","basis","from","to","isUndo","last","pop","ClipboardHandler","getActiveObject","clone","pasteExternal","historyCommand","clipboardData","dashMap","StyleHandler","drawerOptions","freeDrawingBrush","canvasElement","baseCanvasElement","handlers","strokeUniform","isDown","baseCanvas","windowResize","clearTimeout","resizeCooldown","setTimeout","mouseDown","getPointer","currentObject","mouseMove","mouseUp","setDragActive","drop","iEvent","stopPropagation","updateCursor","dataTransfer","pathCreated","path","intersectsWithObject","selectionCreated","selected","objectModified","queryParams","URLSearchParams","location","search","renderOnAddRemove","targetFindTolerance","get","loadJSON","catch","console","error","onresize","onbeforeunload","on","querySelector","ReactDOM","render"],"mappings":"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","file":"main.1937c45d.js","sourcesContent":["import { fabric } from \"fabric\";\r\n\r\nimport { Tool } from \"./tools\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport HistoryHandler from \"./history\";\r\nimport { Dash, Fill, Stroke, Style } from \"./styles\";\r\n\r\nexport enum Action {\r\n  PreviousPage = \"previousPage\",\r\n  NextPage = \"nextPage\",\r\n  AddPage = \"addPage\",\r\n\r\n  Undo = \"undo\",\r\n  Redo = \"redo\",\r\n\r\n  Open = \"open\",\r\n  Save = \"save\",\r\n  Export = \"export\",\r\n  Cut = \"cut\",\r\n  Copy = \"copy\",\r\n  Paste = \"paste\",\r\n\r\n  Deselect = \"deselect\",\r\n  SelectAll = \"selectAll\",\r\n  Duplicate = \"duplicate\",\r\n\r\n  Move = \"move\",\r\n  Pen = \"pen\",\r\n  Eraser = \"eraser\",\r\n  Laser = \"laser\",\r\n  Line = \"line\",\r\n  Ellipse = \"ellipse\",\r\n  Rectangle = \"rectangle\",\r\n\r\n  Dotted = \"dotted\",\r\n  Dashed = \"dashed\",\r\n  Solid = \"solid\",\r\n\r\n  Black = \"black\",\r\n  Blue = \"blue\",\r\n  Green = \"green\",\r\n  Orange = \"orange\",\r\n  Yellow = \"yellow\",\r\n\r\n  Transparent = \"transparent\",\r\n  HalfFilled = \"halfFilled\",\r\n  Filled = \"filled\",\r\n\r\n  ResetStyles = \"resetStyles\",\r\n  FullScreen = \"fullScreen\",\r\n  EnterFullScreen = \"enterFullScreen\",\r\n  ExitFullScreen = \"exitFullScreen\",\r\n}\r\n\r\nconst nameMap = {\r\n  previousPage: \"–Page\",\r\n  nextPage: \"+Page\",\r\n  addPage: \"+Page\",\r\n  selectAll: \"Select All\",\r\n  duplicate: \"Clone\",\r\n  eraser: \"Cut / Eraser\",\r\n  rectangle: \"Rect.\",\r\n  transparent: \"Unfilled\",\r\n  halfFilled: \"Half Fill\",\r\n  resetStyles: \"Reset Styles\",\r\n  fullScreen: \"Full Screen\",\r\n  enterFullScreen: \"Enter Full Screen\",\r\n  exitFullScreen: \"Exit Full Screen\",\r\n};\r\n\r\nexport const actionName = (action: Action): string => {\r\n  const name = nameMap[action] || action;\r\n  return name && name[0].toUpperCase() + name.slice(1);\r\n};\r\n\r\nexport default class ActionHandler {\r\n  canvas: fabric.Canvas;\r\n  actionMap: unknown;\r\n\r\n  constructor(\r\n    public switchTool: (tool: Tool) => Promise<void>,\r\n    public currentStyle: Style,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public clipboard: ClipboardHandler,\r\n    public setStyle: (\r\n      dash: Dash | null,\r\n      stroke: Stroke | null,\r\n      fill: Fill | null\r\n    ) => void\r\n  ) {\r\n    this.canvas = this.pages.canvas;\r\n\r\n    this.actionMap = {\r\n      previousPage: pages.previousPage,\r\n      nextPage: pages.nextOrNewPage,\r\n      addPage: pages.nextOrNewPage,\r\n\r\n      undo: history.undo,\r\n      redo: history.redo,\r\n\r\n      open: files.openFile,\r\n      save: pages.saveFile,\r\n      export: pages.export,\r\n      cut: clipboard.cut,\r\n      copy: clipboard.copy,\r\n      paste: clipboard.paste,\r\n\r\n      deselect: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      selectAll: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.setActiveObject(\r\n          new fabric.ActiveSelection(this.canvas.getObjects(), {\r\n            canvas: this.canvas,\r\n          })\r\n        );\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      duplicate: () => this.clipboard.copy().then(() => this.clipboard.paste()),\r\n\r\n      move: () => this.switchTool(Tool.Move),\r\n      pen: () => this.switchTool(Tool.Pen),\r\n      eraser: () => this.switchTool(Tool.Eraser),\r\n      laser: () => this.switchTool(Tool.Laser),\r\n      line: () => this.switchTool(Tool.Line),\r\n      ellipse: () => this.switchTool(Tool.Ellipse),\r\n      rectangle: () => this.switchTool(Tool.Rectangle),\r\n\r\n      dotted: () => this.setDash(Dash.Dotted),\r\n      dashed: () => this.setDash(Dash.Dashed),\r\n      solid: () => this.setDash(Dash.Solid),\r\n\r\n      blue: () => this.setStroke(Stroke.Blue),\r\n      green: () => this.setStroke(Stroke.Green),\r\n      yellow: () => this.setStroke(Stroke.Yellow),\r\n      orange: () => this.setStroke(Stroke.Orange),\r\n      black: () => this.setStroke(Stroke.Black),\r\n\r\n      transparent: () => this.setFill(Fill.Transparent),\r\n      halfFilled: () => this.setFill(Fill.HalfSolid),\r\n      filled: () => this.setFill(Fill.Solid),\r\n\r\n      resetStyles: () =>\r\n        this.setStyle(Dash.Solid, Stroke.Black, Fill.Transparent),\r\n      fullScreen: () =>\r\n        this.doAction(\r\n          !document.fullscreenElement\r\n            ? Action.EnterFullScreen\r\n            : Action.ExitFullScreen\r\n        ),\r\n      enterFullScreen: () => document.documentElement.requestFullscreen(),\r\n      exitFullScreen: () => document.exitFullscreen(),\r\n    };\r\n  }\r\n\r\n  doAction = async (action: Action): Promise<void> => this.actionMap[action]();\r\n\r\n  setDash = async (dash: Dash): Promise<void> => {\r\n    if (dash === this.currentStyle.dash) {\r\n      this.setStyle(Dash.Solid, null, null);\r\n    } else {\r\n      this.setStyle(dash, null, null);\r\n    }\r\n  };\r\n\r\n  setStroke = async (stroke: Stroke): Promise<void> => {\r\n    if (stroke === this.currentStyle.stroke) {\r\n      this.setStyle(null, Stroke.Black, null);\r\n    } else {\r\n      this.setStyle(null, stroke, null);\r\n    }\r\n  };\r\n\r\n  setFill = async (fill: Fill): Promise<void> => {\r\n    if (fill === this.currentStyle.fill) {\r\n      this.setStyle(null, null, Fill.Transparent);\r\n    } else {\r\n      this.setStyle(null, null, fill);\r\n    }\r\n  };\r\n}\r\n","import keyboardJS from \"keyboardjs\";\r\n\r\nimport { Action } from \"./action\";\r\n\r\nexport type KeyMap = {\r\n  [key: string]: Action;\r\n};\r\n\r\nexport type MirrorMap = {\r\n  [key: string]: string;\r\n};\r\n\r\nexport const defaultKeys: KeyMap = {\r\n  q: Action.Laser,\r\n  w: Action.Copy,\r\n  e: Action.Blue,\r\n  esc: Action.Deselect,\r\n  r: Action.Green,\r\n  a: Action.PreviousPage,\r\n  s: Action.NextPage,\r\n  d: Action.Pen,\r\n  f: Action.Undo,\r\n  g: Action.Paste,\r\n  z: Action.ResetStyles,\r\n  x: Action.Eraser,\r\n  c: Action.Line,\r\n  v: Action.Move,\r\n\r\n  \"shift + q\": Action.Dotted,\r\n  \"shift + w\": Action.Transparent,\r\n  \"shift + e\": Action.Ellipse,\r\n  \"shift + r\": Action.Rectangle,\r\n  \"shift + a\": Action.Dashed,\r\n  \"shift + s\": Action.HalfFilled,\r\n  \"shift + d\": Action.Black,\r\n  \"shift + f\": Action.Redo,\r\n  \"shift + z\": Action.Solid,\r\n  \"shift + x\": Action.Filled,\r\n  \"shift + c\": Action.Yellow,\r\n  \"shift + v\": Action.Orange,\r\n\r\n  \"ctrl + a\": Action.SelectAll,\r\n  \"ctrl + s\": Action.Save,\r\n  \"ctrl + d\": Action.Duplicate,\r\n  \"ctrl + z\": Action.Undo,\r\n  \"ctrl + x\": Action.Cut,\r\n  \"ctrl + c\": Action.Copy,\r\n};\r\n\r\nconst mirrorMap: MirrorMap = {\r\n  tab: \"[\",\r\n  q: \"p\",\r\n  w: \"o\",\r\n  e: \"i\",\r\n  r: \"u\",\r\n  t: \"y\",\r\n  esc: \"'\",\r\n  a: \";\",\r\n  s: \"l\",\r\n  d: \"k\",\r\n  f: \"j\",\r\n  g: \"h\",\r\n  shift: \"shift\",\r\n  z: \"/\",\r\n  x: \".\",\r\n  c: \",\",\r\n  v: \"m\",\r\n  b: \"n\",\r\n};\r\n\r\nexport const mirror = (key: string): string => {\r\n  return mirrorMap[key] || key.slice(0, -1) + mirrorMap[key.slice(-1)];\r\n};\r\n\r\nexport default class KeyboardHandler {\r\n  keyMap: KeyMap = {};\r\n\r\n  constructor(\r\n    public doAction: (action: Action) => Promise<void>,\r\n    public setStrict: (strict: boolean) => void,\r\n    public updateState: () => void\r\n  ) {\r\n    keyboardJS.bind(\r\n      \"shift\",\r\n      () => {\r\n        this.setStrict(true);\r\n      },\r\n      () => {\r\n        this.setStrict(false);\r\n      }\r\n    );\r\n\r\n    if (!window.localStorage.getItem(\"keyMap\")) {\r\n      this.reset();\r\n    } else {\r\n      this.keyMap = JSON.parse(window.localStorage.getItem(\"keyMap\"));\r\n      this.bindAll();\r\n    }\r\n  }\r\n\r\n  save = (): void => {\r\n    window.localStorage.setItem(\"keyMap\", JSON.stringify(this.keyMap));\r\n  };\r\n\r\n  bindAll = (): void => {\r\n    for (const [key, value] of Object.entries(this.keyMap)) {\r\n      this.bind(key, value);\r\n    }\r\n    this.updateState();\r\n  };\r\n\r\n  unbind = (key: string): void => {\r\n    delete this.keyMap[key];\r\n    keyboardJS.unbind(key);\r\n    keyboardJS.unbind(mirror(key));\r\n    this.updateState();\r\n    this.save();\r\n  };\r\n\r\n  bind = (key: string, action: Action): void => {\r\n    this.keyMap[key] = action;\r\n    keyboardJS.bind(key, () => this.doAction(this.keyMap[key]));\r\n    keyboardJS.bind(mirror(key), () => this.doAction(this.keyMap[key]));\r\n    this.updateState();\r\n    this.save();\r\n  };\r\n\r\n  reset = (): void => {\r\n    for (const key of Object.keys(this.keyMap)) {\r\n      keyboardJS.unbind(key);\r\n      keyboardJS.unbind(mirror(key));\r\n    }\r\n    this.keyMap = { ...defaultKeys };\r\n    this.bindAll();\r\n    this.save();\r\n  };\r\n}\r\n","import React from \"react\";\r\n\r\nimport { Stroke } from \"../lib/styles\";\r\n\r\nconst fasIcon = (iconName: string, style?: unknown) => (\r\n  <i className={`fas fa-${iconName}`} style={style} />\r\n);\r\n\r\nconst Icon = {\r\n  close: fasIcon(\"times-circle\"),\r\n\r\n  previousPage: fasIcon(\"caret-left\"),\r\n  nextPage: fasIcon(\"caret-right\"),\r\n  addPage: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\r\n\r\n  undo: fasIcon(\"undo\"),\r\n  redo: fasIcon(\"redo\"),\r\n\r\n  move: fasIcon(\"mouse-pointer\"),\r\n  pen: fasIcon(\"pen\"),\r\n  eraser: fasIcon(\"eraser\"),\r\n  laser: fasIcon(\"asterisk\"),\r\n  line: fasIcon(\"minus\", { transform: \"rotate(-45deg)\" }),\r\n  ellipse: fasIcon(\"circle\"),\r\n  rectangle: fasIcon(\"square\"),\r\n\r\n  file: fasIcon(\"file\"),\r\n  open: fasIcon(\"folder-open\"),\r\n  save: fasIcon(\"save\"),\r\n  export: fasIcon(\"file-export\"),\r\n  cut: fasIcon(\"cut\"),\r\n  copy: fasIcon(\"copy\"),\r\n  paste: fasIcon(\"paste\"),\r\n\r\n  duplicate: fasIcon(\"clone\"),\r\n\r\n  fullScreen: fasIcon(\"expand\"),\r\n  enterFullScreen: fasIcon(\"expand\"),\r\n  exitFullScreen: fasIcon(\"compress\"),\r\n\r\n  black: fasIcon(\"circle\", { color: Stroke.Black }),\r\n  blue: fasIcon(\"circle\", { color: Stroke.Blue }),\r\n  green: fasIcon(\"circle\", { color: Stroke.Green }),\r\n  orange: fasIcon(\"circle\", { color: Stroke.Orange }),\r\n  yellow: fasIcon(\"circle\", { color: Stroke.Yellow }),\r\n\r\n  dotted: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  dashed: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M101,1176.92v2.021c1.735-0.192,3.319-0.878,4.613-1.913l-1.43-1.43C103.269,1176.284,102.183,1176.75,101,1176.92z\" />\r\n          <path d=\"M93.08,1171h-2.021c0.191,1.735,0.879,3.319,1.914,4.614l1.43-1.43C93.716,1173.269,93.25,1172.183,93.08,1171z\" />\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M106.92,1169h2.021c-0.191-1.735-0.879-3.319-1.914-4.614l-1.43,1.43C106.284,1166.731,106.75,1167.817,106.92,1169z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M99,1163.08v-2.021c-1.735,0.192-3.319,0.878-4.613,1.913l1.43,1.43C96.731,1163.716,97.817,1163.25,99,1163.08z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  solid: <i className=\"far fa-circle\" />,\r\n\r\n  transparent: <i className=\"far fa-circle\" />,\r\n  halfFilled: (\r\n    <div style={{ height: \"0.7em\", marginRight: \"1em\", position: \"relative\" }}>\r\n      <i\r\n        className=\"fas fa-circle\"\r\n        style={{ left: \"50%\", opacity: 0.3, position: \"absolute\", top: 0 }}\r\n      />\r\n      <i\r\n        className=\"far fa-circle\"\r\n        style={{ left: \"50%\", position: \"absolute\", top: 0 }}\r\n      />\r\n    </div>\r\n  ),\r\n  filled: fasIcon(\"circle\"),\r\n\r\n  resetStyles: null,\r\n};\r\n\r\nexport default Icon;\r\n","import React from \"react\";\r\nimport ReactTooltip from \"react-tooltip\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\n\r\nconst OverlayButton = (props: {\r\n  action: Action;\r\n  callback: (action: Action) => Promise<void>;\r\n  className?: string;\r\n}): JSX.Element => {\r\n  return (\r\n    <>\r\n      <button\r\n        className={props.className || undefined}\r\n        data-tip\r\n        data-for={props.action}\r\n        onClick={() => props.callback(props.action)}\r\n      >\r\n        {Icon[props.action]}\r\n      </button>\r\n      <ReactTooltip\r\n        backgroundColor=\"#ddd\"\r\n        effect=\"solid\"\r\n        id={props.action}\r\n        place=\"right\"\r\n        textColor=\"#262626\"\r\n      >\r\n        {actionName(props.action)}\r\n      </ReactTooltip>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default OverlayButton;\r\n","import React, { useEffect, useState } from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst Pagination = (props: {\r\n  loadPage: (index: number) => Promise<void | number>;\r\n  currentPage: number;\r\n  totalPages: number;\r\n  doAction: (action: Action) => Promise<void>;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  const [value, setValue] = useState(0);\r\n  const [width, setWidth] = useState(\"0.6em\");\r\n\r\n  useEffect(() => {\r\n    setValue(props.currentPage);\r\n    setWidth(`${0.6 * props.currentPage.toString().length}em`);\r\n  }, [props]);\r\n\r\n  const navigate = async () => {\r\n    if (!value) return;\r\n    const page = Number(value);\r\n    if (!page || page > props.totalPages) {\r\n      setValue(props.currentPage);\r\n    } else {\r\n      await props.loadPage(page - 1);\r\n    }\r\n  };\r\n\r\n  useEffect(() => void navigate(), [value]);\r\n\r\n  const onSubmit: (e) => Promise<void> = (e) => {\r\n    e?.preventDefault();\r\n    return navigate();\r\n  };\r\n\r\n  const onChange = (e) => setValue(e.target.value);\r\n\r\n  return (\r\n    <div className={`pagination visibility-${props.visibility}`}>\r\n      <OverlayButton\r\n        className={props.currentPage === 1 ? \"disabled\" : undefined}\r\n        action={Action.PreviousPage}\r\n        callback={props.doAction}\r\n      />\r\n      <form onSubmit={onSubmit}>\r\n        <input\r\n          onChange={onChange}\r\n          type=\"text\"\r\n          value={value}\r\n          style={{ width }}\r\n          tabIndex={-1}\r\n        />\r\n      </form>\r\n      <span className=\"total-pages\"> / {props.totalPages}</span>\r\n      {props.currentPage === props.totalPages ? (\r\n        <OverlayButton action={Action.AddPage} callback={props.doAction} />\r\n      ) : (\r\n        <OverlayButton action={Action.NextPage} callback={props.doAction} />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Pagination;\r\n","import React from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst UndoRedo = (props: {\r\n  canUndo: boolean;\r\n  canRedo: boolean;\r\n  doAction: (action: Action) => Promise<void>;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  return (\r\n    <div className={`undoredo visibility-${props.visibility}`}>\r\n      <OverlayButton\r\n        action={Action.Undo}\r\n        callback={props.doAction}\r\n        className={props.canUndo ? undefined : \"disabled\"}\r\n      />\r\n      <OverlayButton\r\n        action={Action.Redo}\r\n        callback={props.doAction}\r\n        className={props.canRedo ? undefined : \"disabled\"}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default UndoRedo;\r\n","import React from \"react\";\r\n\r\nimport { Tool } from \"../lib/tools\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst Toolbar = (props: {\r\n  currentTool: Tool;\r\n  doAction: (action: Action) => Promise<void>;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  const tools = [\r\n    Action.Move,\r\n    Action.Pen,\r\n    Action.Eraser,\r\n    Action.Laser,\r\n    Action.Line,\r\n    Action.Rectangle,\r\n    Action.Ellipse,\r\n  ];\r\n\r\n  return (\r\n    <div className={`toolbar visibility-${props.visibility}`}>\r\n      {tools.map((tool, index) => (\r\n        <OverlayButton\r\n          action={tool}\r\n          callback={props.doAction}\r\n          className={index === props.currentTool ? \"active\" : undefined}\r\n          key={tool}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Toolbar;\r\n","import React, { ReactNode } from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst ButtonRow = (props: {\r\n  actions: Action[];\r\n  callback: (action: Action) => Promise<void>;\r\n  className?: (action: Action, i?: number) => null | string;\r\n  cName?: string;\r\n  outerButton?: boolean | ReactNode;\r\n}): JSX.Element => {\r\n  return (\r\n    <div\r\n      className={`button-row ${props.cName} ${\r\n        props.outerButton ? \"button-row-hover\" : \"\"\r\n      }`}\r\n    >\r\n      {props.outerButton}\r\n      <div className=\"button-row-inner\">\r\n        {props.actions.map((action, i) => (\r\n          <OverlayButton\r\n            action={action}\r\n            className={props.className?.(action, i)}\r\n            callback={props.callback}\r\n            key={action}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ButtonRow;\r\n","import React from \"react\";\r\n\r\nimport { Dash, Fill, Stroke, Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\nimport ButtonRow from \"./ButtonRow\";\r\n\r\nconst DashStyle = (props: {\r\n  dashStyle: Dash;\r\n  callback: (action: Action) => Promise<void>;\r\n  inContext: boolean;\r\n}) => {\r\n  const dashes = [Action.Solid, Action.Dashed, Action.Dotted];\r\n  const button = (\r\n    <button className=\"inactive\">{Icon[dashes[props.dashStyle]]}</button>\r\n  );\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={dashes}\r\n      className={(action, i) =>\r\n        props.inContext && props.dashStyle === i && \"active\"\r\n      }\r\n      callback={props.callback}\r\n      outerButton={!props.inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst StrokeStyle = (props: {\r\n  strokeStyle: string;\r\n  callback: (action: Action) => Promise<void>;\r\n  inContext: boolean;\r\n}): JSX.Element => {\r\n  const strokes = [\r\n    Action.Black,\r\n    Action.Blue,\r\n    Action.Green,\r\n    Action.Yellow,\r\n    Action.Orange,\r\n  ];\r\n  const strokeMap = [\r\n    Stroke.Black,\r\n    Stroke.Blue,\r\n    Stroke.Green,\r\n    Stroke.Yellow,\r\n    Stroke.Orange,\r\n  ];\r\n  const button = (\r\n    <button className=\"inactive\">\r\n      <i className=\"fas fa-circle\" style={{ color: props.strokeStyle }} />\r\n    </button>\r\n  );\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={strokes}\r\n      className={(action, i) =>\r\n        props.inContext && props.strokeStyle === strokeMap[i] && \"active\"\r\n      }\r\n      callback={props.callback}\r\n      outerButton={!props.inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst FillStyle = (props: {\r\n  fillStyle: Fill;\r\n  callback: (action: Action) => Promise<void>;\r\n  inContext: boolean;\r\n}): JSX.Element => {\r\n  const fills = [Action.Transparent, Action.Filled, Action.HalfFilled];\r\n  const button = (\r\n    <button className=\"inactive\">{Icon[fills[props.fillStyle]]}</button>\r\n  );\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={fills}\r\n      className={(action, i) =>\r\n        props.inContext && props.fillStyle === i && \"active\"\r\n      }\r\n      callback={props.callback}\r\n      outerButton={!props.inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst StyleMenu = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => Promise<void>;\r\n  inContext?: boolean;\r\n}): JSX.Element => {\r\n  return (\r\n    <>\r\n      <DashStyle\r\n        dashStyle={props.currentStyle ? props.currentStyle.dash : null}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n      <StrokeStyle\r\n        strokeStyle={props.currentStyle ? props.currentStyle.stroke : null}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n      <FillStyle\r\n        fillStyle={props.currentStyle ? props.currentStyle.fill : null}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default StyleMenu;\r\n","import React, { useEffect, useRef, useState } from \"react\";\r\n\r\nimport { Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport ButtonRow from \"./ButtonRow\";\r\nimport Icon from \"./Icon\";\r\nimport StyleMenu from \"./StyleMenu\";\r\n\r\nconst Stylebar = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => Promise<void>;\r\n  acceptFile: (files: FileList) => Promise<void | void[]>;\r\n  visibility: Visibility;\r\n  isMobile: boolean;\r\n}): JSX.Element => {\r\n  const fileInputRef = useRef(null);\r\n  const fileButton = <button className=\"inactive\">{Icon.file}</button>;\r\n  const fileActions = [Action.Open, Action.Save, Action.Export];\r\n\r\n  const otherActions = [Action.Copy, Action.Paste];\r\n  const mobileActions = props.isMobile ? [Action.FullScreen] : [];\r\n\r\n  const [isFullscreen, setIsFullscreen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setIsFullscreen(Boolean(document.fullscreenElement));\r\n    document.addEventListener(\"fullscreenchange\", () =>\r\n      setIsFullscreen(Boolean(document.fullscreenElement))\r\n    );\r\n  }, []);\r\n\r\n  return (\r\n    <div className={`stylebar visibility-${props.visibility}`}>\r\n      <input\r\n        accept=\"\"\r\n        onChange={(e) => props.acceptFile(e.target.files)}\r\n        multiple={false}\r\n        ref={fileInputRef}\r\n        type=\"file\"\r\n      />\r\n      <ButtonRow\r\n        actions={fileActions}\r\n        callback={async (action) => {\r\n          if (action === Action.Open) {\r\n            fileInputRef.current.click();\r\n          } else {\r\n            await props.doAction(action);\r\n          }\r\n        }}\r\n        cName=\"file-actions\"\r\n        outerButton={fileButton}\r\n      />\r\n      <ButtonRow\r\n        actions={otherActions}\r\n        cName=\"other-actions vertical\"\r\n        callback={props.doAction}\r\n      />\r\n      <StyleMenu currentStyle={props.currentStyle} doAction={props.doAction} />\r\n      <ButtonRow\r\n        actions={mobileActions.map((action) =>\r\n          action === Action.FullScreen\r\n            ? !isFullscreen\r\n              ? Action.EnterFullScreen\r\n              : Action.ExitFullScreen\r\n            : action\r\n        )}\r\n        callback={props.doAction}\r\n        cName=\"mobile-actions vertical\"\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Stylebar;\r\n","import React from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst nonBinding: Action[] = [\r\n  Action.AddPage,\r\n  Action.EnterFullScreen,\r\n  Action.ExitFullScreen,\r\n];\r\n\r\nconst BindingModal = (props: {\r\n  letter: string;\r\n  action: Action | null;\r\n  close: () => void;\r\n  callback: (action: Action | null) => void;\r\n}): Modal => {\r\n  return (\r\n    <Modal\r\n      className=\"modal\"\r\n      overlayClassName=\"modal-overlay binding-modal\"\r\n      isOpen={props.letter !== \"\"}\r\n    >\r\n      <button className=\"close\" onClick={() => props.close()}>\r\n        {Icon.close}\r\n      </button>\r\n      <p>\r\n        Changing <span className=\"binding\">{props.letter}</span> binding…\r\n      </p>\r\n      <div className=\"tools\">\r\n        <button\r\n          className={props.action === undefined ? \"active\" : undefined}\r\n          onClick={() => props.callback(null)}\r\n        >\r\n          <span style={{ left: \"0.25em\" }}>none</span>\r\n        </button>\r\n        {Object.values(Action).map(\r\n          (action) =>\r\n            !nonBinding.includes(action) && (\r\n              <button\r\n                key={action}\r\n                className={props.action === action ? \"active\" : undefined}\r\n                onClick={() => props.callback(action)}\r\n              >\r\n                {Icon[action]}\r\n                <span style={Icon[action] ? {} : { left: \"0.25em\" }}>\r\n                  {actionName(action)}\r\n                </span>\r\n              </button>\r\n            )\r\n        )}\r\n      </div>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default BindingModal;\r\n","import React, { useState } from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\nimport { KeyMap, mirror } from \"../lib/keyboard\";\r\n\r\nimport Icon from \"./Icon\";\r\nimport BindingModal from \"./BindingModal\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst HeaderKey = (props: {\r\n  letter: string;\r\n  label?: string;\r\n  width: string;\r\n  leftHanded: boolean;\r\n}) => {\r\n  return (\r\n    <div className=\"key\" style={{ width: props.width }}>\r\n      <span className=\"letter\">\r\n        {props.leftHanded ? mirror(props.letter) : props.letter}\r\n      </span>\r\n      <div className=\"action\">\r\n        <span className=\"unassigned\">{props.label || \"\"}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst Key = (props: {\r\n  letter: string;\r\n  action?: Action;\r\n  callback: (key: string) => void;\r\n  leftHanded: boolean;\r\n}) => {\r\n  return (\r\n    <button className=\"key\" onClick={() => props.callback(props.letter)}>\r\n      <div className=\"action\">\r\n        {props.action && Icon[props.action]}\r\n        <span className={props.action ? undefined : \"unassigned\"}>\r\n          {actionName(props.action) || \"none\"}\r\n        </span>\r\n      </div>\r\n      <span className=\"letter\">\r\n        {props.leftHanded ? mirror(props.letter) : props.letter}\r\n      </span>\r\n    </button>\r\n  );\r\n};\r\n\r\nconst Bindings = (props: {\r\n  bind: (key: string, action: Action) => void;\r\n  unbind: (key: string) => void;\r\n  keyMap: KeyMap;\r\n  modifier: string;\r\n  leftHanded: boolean;\r\n}): JSX.Element => {\r\n  const [bindingModalKeys, setBindingModalKeys]: [\r\n    string,\r\n    React.Dispatch<React.SetStateAction<string>>\r\n  ] = useState<string>(\"\");\r\n  const [bindingModalAction, setBindingModalAction] = useState(undefined);\r\n\r\n  const rows = [\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"tab\"\r\n          label=\"Hide Toolbar\"\r\n          width=\"4.5em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"qwert\".split(\"\"),\r\n    },\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"esc\"\r\n          label=\"Deselect\"\r\n          width=\"6em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"asdfg\".split(\"\"),\r\n    },\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"shift\"\r\n          label=\"Snap\"\r\n          width=\"7.5em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"zxcvb\".split(\"\"),\r\n    },\r\n  ];\r\n\r\n  const getModified = (letter: string): string =>\r\n    props.modifier === \"\" ? letter : `${props.modifier} + ${letter}`;\r\n\r\n  const keyHandler = (letter: string): void => {\r\n    setBindingModalKeys(getModified(letter));\r\n    setBindingModalAction(props.keyMap[getModified(letter)]);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div className=\"bindings\">\r\n        {rows.map(({ header, letters }, index) => (\r\n          <div className={`row ${props.leftHanded ? \"left\" : \"\"}`} key={index}>\r\n            {!props.leftHanded && header}\r\n            {(props.leftHanded ? letters.reverse() : letters).map((letter) => (\r\n              <Key\r\n                key={letter}\r\n                letter={letter}\r\n                action={props.keyMap[getModified(letter)]}\r\n                callback={keyHandler}\r\n                leftHanded={props.leftHanded}\r\n              />\r\n            ))}\r\n            {props.leftHanded && header}\r\n          </div>\r\n        ))}\r\n      </div>\r\n      <BindingModal\r\n        letter={bindingModalKeys}\r\n        action={bindingModalAction}\r\n        close={() => setBindingModalKeys(\"\")}\r\n        callback={(action) => {\r\n          props.unbind(bindingModalKeys);\r\n          if (action) props.bind(bindingModalKeys, action);\r\n          setBindingModalKeys(\"\");\r\n        }}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default Bindings;\r\n","import React, { useEffect, useState } from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action } from \"../lib/action\";\r\nimport { KeyMap } from \"../lib/keyboard\";\r\n\r\nimport Bindings from \"./Bindings\";\r\nimport Icon from \"./Icon\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst HelpModal = (props: {\r\n  bind: (key: string, action: Action) => void;\r\n  unbind: (key: string) => void;\r\n  reset: () => void;\r\n  keyMap: KeyMap;\r\n  isOpen: boolean;\r\n  toggleOpen: () => void;\r\n  isMobile: boolean;\r\n  toggleMobility: () => void;\r\n}): JSX.Element => {\r\n  const [keyModifier, setKeyModifier] = useState(\"\");\r\n  const [leftHanded, setLeftHanded] = useState(false);\r\n\r\n  const toggleHand = (): void => {\r\n    setLeftHanded((wasLeftHanded: boolean) => {\r\n      window.localStorage.setItem(\r\n        \"leftHanded\",\r\n        wasLeftHanded ? \"false\" : \"true\"\r\n      );\r\n\r\n      return !wasLeftHanded;\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (window.localStorage.getItem(\"leftHanded\") === \"true\") {\r\n      setLeftHanded(true);\r\n    }\r\n  }, []);\r\n\r\n  return (\r\n    <Modal\r\n      className=\"modal\"\r\n      overlayClassName=\"modal-overlay help-modal\"\r\n      isOpen={props.isOpen}\r\n    >\r\n      <button className=\"close\" onClick={() => props.toggleOpen()}>\r\n        {Icon.close}\r\n      </button>\r\n      <p>\r\n        <span style={{ fontSize: \"1.5em\", fontWeight: \"bold\" }}>qboard</span>{\" \"}\r\n        <span style={{ color: \"#666\", marginLeft: \"0.2em\" }}>\r\n          The efficient digital whiteboard.\r\n        </span>\r\n      </p>\r\n      <p>\r\n        Press <b>{leftHanded ? \"0\" : \"1\"}</b> to show or hide this screen.\r\n      </p>\r\n      <p>\r\n        <button\r\n          className={keyModifier === \"\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"\")}\r\n        >\r\n          unmodified\r\n        </button>\r\n        <button\r\n          className={keyModifier === \"shift\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"shift\")}\r\n        >\r\n          with shift\r\n        </button>\r\n        <button\r\n          className={keyModifier === \"ctrl\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"ctrl\")}\r\n        >\r\n          with ctrl\r\n        </button>\r\n        <button onClick={() => toggleHand()}>\r\n          {leftHanded ? \"show left side\" : \"show right side\"}\r\n        </button>\r\n      </p>\r\n      <Bindings\r\n        bind={props.bind}\r\n        unbind={props.unbind}\r\n        keyMap={props.keyMap}\r\n        modifier={keyModifier}\r\n        leftHanded={leftHanded}\r\n      />\r\n      <p>\r\n        Click a key to change the binding.{\" \"}\r\n        <button onClick={() => props.reset()}>reset to default</button>\r\n      </p>\r\n      <p style={{ color: \"#666\" }}>\r\n        By <a href=\"https://cjquines.com/\">CJ Quines</a>. View on{\" \"}\r\n        <a href=\"https://github.com/cjquines/qboard\">Github</a>. Use{\" \"}\r\n        <a onClick={() => props.toggleMobility()} tabIndex={0}>\r\n          {props.isMobile ? \"desktop\" : \"mobile\"} site\r\n        </a>\r\n        .\r\n      </p>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default HelpModal;\r\n","import React, { useEffect, useState } from \"react\";\r\n\r\nimport { Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport StyleMenu from \"./StyleMenu\";\r\n\r\nconst ContextMenu = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => Promise<void>;\r\n}): JSX.Element => {\r\n  const [coords, setCoords] = useState<[number, number] | null>(null);\r\n\r\n  useEffect(() => {\r\n    document.addEventListener(\"contextmenu\", (e: MouseEvent) => {\r\n      e.preventDefault();\r\n      setCoords((oldCoords) => (oldCoords ? null : [e.clientX, e.clientY]));\r\n    });\r\n    document.addEventListener(\"click\", () => setCoords(null));\r\n  }, []);\r\n\r\n  return coords ? (\r\n    <div\r\n      className=\"context-menu\"\r\n      style={{\r\n        top: `calc(${coords[1]}px - 2.8em)`,\r\n        left: `calc(${coords[0]}px - 1.1em)`,\r\n      }}\r\n    >\r\n      <StyleMenu\r\n        currentStyle={props.currentStyle}\r\n        doAction={(action: Action) => props.doAction(action)}\r\n        inContext={true}\r\n      />\r\n    </div>\r\n  ) : null;\r\n};\r\n\r\nexport default ContextMenu;\r\n","import React, { useEffect, useState } from \"react\";\nimport keyboardJS from \"keyboardjs\";\n\nimport QBoard, { QBoardState } from \"../lib/qboard\";\nimport { Tool } from \"../lib/tools\";\nimport { Dash, Fill, Stroke } from \"../lib/styles\";\nimport { defaultKeys } from \"../lib/keyboard\";\n\nimport Pagination from \"./Pagination\";\nimport UndoRedo from \"./UndoRedo\";\nimport Toolbar from \"./Toolbar\";\nimport Stylebar from \"./Stylebar\";\nimport HelpModal from \"./HelpModal\";\nimport ContextMenu from \"./ContextMenu\";\n\nexport const enum Visibility {\n  None,\n  Condensed,\n  Full,\n}\n\nconst Overlay = (props: { qboard: QBoard }): JSX.Element => {\n  const { qboard } = props;\n\n  const [visibility, setVisibility] = useState<Visibility>(Visibility.Full);\n  const [helpModalOpen, setHelpModalOpen] = useState<boolean>(false);\n  const [isMobile, setMobility] = useState<boolean>(false);\n\n  const [state, setState]: [\n    QBoardState,\n    React.Dispatch<React.SetStateAction<QBoardState>>\n  ] = useState<QBoardState>({\n    dragActive: false,\n    currentPage: 0,\n    totalPages: 0,\n    currentTool: Tool.Move,\n    currentStyle: {\n      dash: Dash.Solid,\n      stroke: Stroke.Black,\n      fill: Fill.Transparent,\n    },\n    canUndo: false,\n    canRedo: false,\n    keyMap: defaultKeys,\n  });\n\n  const toggleOpen = (): void => {\n    setHelpModalOpen((wasOpen) => {\n      window.localStorage.setItem(\"helpModalOpen\", wasOpen ? \"false\" : \"true\");\n      return !wasOpen;\n    });\n  };\n\n  const toggleMobility = (): void => {\n    setMobility((wasMobile) => {\n      window.localStorage.setItem(\"isMobile\", wasMobile ? \"false\" : \"true\");\n      return !wasMobile;\n    });\n  };\n\n  useEffect(() => {\n    if (window.localStorage.getItem(\"helpModalOpen\") !== \"false\") {\n      setHelpModalOpen(true);\n    }\n    if (window.localStorage.getItem(\"isMobile\") !== \"false\") {\n      setMobility(true);\n    }\n\n    qboard.callback = setState;\n    qboard.updateState();\n\n    keyboardJS.bind(\"tab\", () => {\n      setVisibility((currentVisibility) => (currentVisibility + 2) % 3);\n    });\n\n    keyboardJS.bind(\"1\", () => toggleOpen());\n    keyboardJS.bind(\"0\", () => toggleOpen());\n  }, []);\n\n  return (\n    <>\n      <div className={`drop-area ${state.dragActive ? \"active\" : \"\"}`} />\n      <div className={`overlay visibility-${visibility}`}>\n        <Pagination\n          loadPage={qboard.pages.loadPage}\n          currentPage={state.currentPage}\n          totalPages={state.totalPages}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <UndoRedo\n          canUndo={state.canUndo}\n          canRedo={state.canRedo}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <Toolbar\n          currentTool={state.currentTool}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <Stylebar\n          currentStyle={state.currentStyle}\n          doAction={qboard.action.doAction}\n          acceptFile={async (file) =>\n            qboard.history.execute(\n              (await qboard.files.acceptFile(file)).history\n            )\n          }\n          visibility={visibility}\n          isMobile={isMobile}\n        />\n        <HelpModal\n          bind={qboard.keyboard.bind}\n          unbind={qboard.keyboard.unbind}\n          reset={qboard.keyboard.reset}\n          keyMap={state.keyMap}\n          isOpen={helpModalOpen}\n          toggleOpen={toggleOpen}\n          isMobile={isMobile}\n          toggleMobility={toggleMobility}\n        />\n      </div>\n      <ContextMenu\n        currentStyle={state.currentStyle}\n        doAction={qboard.action.doAction}\n      />\n    </>\n  );\n};\n\nexport default Overlay;\n","import { fabric } from \"fabric\";\r\n\r\n// projects the point x2, y2 to the vector with origin ox, oy and direction vx, vy. returns the square distance and the coordinates of the projection.\r\nconst project = (\r\n  ox: number,\r\n  oy: number,\r\n  vx: number,\r\n  vy: number,\r\n  x2: number,\r\n  y2: number\r\n): number[] => {\r\n  const x = x2 - ox;\r\n  const y = y2 - oy;\r\n  const side = vx * y - vy * x;\r\n  const sq = vx * vx + vy * vy;\r\n  return [\r\n    Math.abs(side) / sq,\r\n    ox + x + (vy * side) / sq,\r\n    oy + y - (vx * side) / sq,\r\n  ];\r\n};\r\n\r\n// given the origin x, y, snaps the point x2, y2 to the nearest vector in dirs\r\nconst rectify = (\r\n  dirs: number[][],\r\n  x: number,\r\n  y: number,\r\n  x2: number,\r\n  y2: number\r\n): number[] => {\r\n  return dirs\r\n    .map((d) => project(x, y, d[0], d[1], x2, y2))\r\n    .reduce((acc, cur) => (acc[0] < cur[0] ? acc : cur));\r\n};\r\n\r\nexport const enum Tool {\r\n  Move,\r\n  Pen,\r\n  Eraser,\r\n  Laser,\r\n  Line,\r\n  Rectangle,\r\n  Ellipse,\r\n}\r\n\r\nexport default interface ToolHandler {\r\n  tool: Tool;\r\n  isBrush: boolean;\r\n\r\n  draw?: (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ) => Promise<fabric.Object>;\r\n\r\n  resize?: (\r\n    object: fabric.Object,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ) => Promise<fabric.Object>;\r\n\r\n  setBrush?: (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ) => Promise<void>;\r\n}\r\n\r\nexport class MoveHandler implements ToolHandler {\r\n  tool: Tool = Tool.Move;\r\n  isBrush = false;\r\n}\r\n\r\nexport class PenHandler implements ToolHandler {\r\n  tool: Tool = Tool.Pen;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = options.stroke;\r\n    brush.strokeDashArray = options.strokeDashArray;\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class EraserHandler implements ToolHandler {\r\n  tool: Tool = Tool.Eraser;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = \"#ff005455\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = 5 * options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class LaserHandler implements ToolHandler {\r\n  tool: Tool = Tool.Laser;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = \"#f23523\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class LineHandler implements ToolHandler {\r\n  tool: Tool = Tool.Line;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 0],\r\n    [1, 1],\r\n    [0, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Line> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Line>((resolve) => {\r\n      resolve(\r\n        new fabric.Line([x, y, x2, y2], {\r\n          ...options,\r\n          perPixelTargetFind: true,\r\n        })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Line,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Line> => {\r\n    let [x, y] = [x2, y2];\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object.set({ x2: x, y2: y }).setCoords();\r\n    return new Promise<fabric.Line>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport class RectangleHandler implements ToolHandler {\r\n  tool: Tool = Tool.Rectangle;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Rect> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Rect>((resolve) => {\r\n      resolve(\r\n        new fabric.Rect({ left: x, top: y, width: x2, height: y2, ...options })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Rect,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Rect> => {\r\n    let [x, y] = [x2, y2];\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        width: Math.abs(this.x - x),\r\n        height: Math.abs(this.y - y),\r\n      })\r\n      .setCoords();\r\n\r\n    return new Promise<fabric.Rect>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport class EllipseHandler implements ToolHandler {\r\n  tool: Tool = Tool.Ellipse;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Ellipse> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Ellipse>((resolve) => {\r\n      resolve(\r\n        new fabric.Ellipse({ left: x, top: y, rx: x2, ry: y2, ...options })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Ellipse,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Ellipse> => {\r\n    let [x, y] = [x2, y2];\r\n\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        rx: Math.abs(x - object.left) / 2,\r\n        ry: Math.abs(y - object.top) / 2,\r\n      })\r\n      .setCoords();\r\n\r\n    return new Promise<fabric.Ellipse>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport const Handlers = [\r\n  new MoveHandler(),\r\n  new PenHandler(),\r\n  new EraserHandler(),\r\n  new LaserHandler(),\r\n  new LineHandler(),\r\n  new RectangleHandler(),\r\n  new EllipseHandler(),\r\n];\r\n","import { fabric } from \"fabric\";\r\n\r\nexport interface ObjectId extends fabric.Object {\r\n  id: number;\r\n}\r\n\r\nexport type Cursor = { x: number; y: number };\r\n\r\nexport default class Page extends fabric.Canvas {\r\n  cursor: Cursor;\r\n  canvasWidth: number;\r\n  canvasHeight: number;\r\n  latestId = 0;\r\n  modified = false;\r\n\r\n  fitToWindow = async (\r\n    canvasWidth: number,\r\n    canvasHeight: number\r\n  ): Promise<void> => {\r\n    const widthRatio = window.innerWidth / canvasWidth;\r\n    const heightRatio = window.innerHeight / canvasHeight;\r\n    this.setZoom(Math.min(widthRatio, heightRatio));\r\n    this.setWidth(canvasWidth * this.getZoom());\r\n    this.setHeight(canvasHeight * this.getZoom());\r\n    this.canvasWidth = canvasWidth;\r\n    this.canvasHeight = canvasHeight;\r\n  };\r\n\r\n  deactivateSelection = async (): Promise<void> => {\r\n    this.isDrawingMode = false;\r\n    this.selection = false;\r\n    this.discardActiveObject();\r\n    this.forEachObject((object) => {\r\n      object.selectable = false;\r\n    });\r\n    this.requestRenderAll();\r\n  };\r\n\r\n  activateSelection = async (): Promise<void> => {\r\n    this.isDrawingMode = false;\r\n    this.selection = true;\r\n    this.forEachObject((object) => {\r\n      object.selectable = true;\r\n    });\r\n  };\r\n\r\n  getNextId = async (): Promise<number> => {\r\n    this.latestId += 1;\r\n    return this.latestId;\r\n  };\r\n\r\n  // kind of inefficient\r\n  getObjectByIds = (ids: number[]): fabric.Object[] =>\r\n    this.getObjects().filter((object) => ids.includes((object as ObjectId).id));\r\n\r\n  serialize = async (objects: fabric.Object[]): Promise<fabric.Object[]> => {\r\n    const selection = this.getActiveObjects();\r\n    const reselect =\r\n      selection.length > 1 && objects.some((obj) => selection.includes(obj));\r\n    reselect && this.discardActiveObject();\r\n    const res = objects.map((object) => object.toObject([\"strokeUniform\"]));\r\n    reselect &&\r\n      this.setActiveObject(\r\n        new fabric.ActiveSelection(selection, { canvas: this })\r\n      );\r\n    return res;\r\n  };\r\n\r\n  apply = (ids: number[], newObjects: fabric.Object[] | null): void => {\r\n    const oldObjects = this.getObjectByIds(ids);\r\n    if (oldObjects.length) {\r\n      this.remove(...oldObjects);\r\n    }\r\n    if (newObjects?.length) {\r\n      const addObjects = (objects) => {\r\n        objects.forEach((object: ObjectId, i) => {\r\n          object.id = ids[i];\r\n        });\r\n        this.add(...objects);\r\n        this.requestRenderAll();\r\n      };\r\n      fabric.util.enlivenObjects(newObjects, addObjects, \"fabric\");\r\n    } else {\r\n      this.requestRenderAll();\r\n    }\r\n  };\r\n\r\n  loadFromJSONAsync = async (json: unknown): Promise<void> =>\r\n    new Promise<void>((resolve) => {\r\n      super.loadFromJSON(json, () => {\r\n        resolve();\r\n      });\r\n    });\r\n\r\n  placeObject = async (\r\n    obj: any,\r\n    cursor: Cursor = this.cursor\r\n  ): Promise<fabric.Object[]> => {\r\n    const { x = this.canvasWidth / 2, y = this.canvasHeight / 2 } =\r\n      cursor || {};\r\n    this.discardActiveObject();\r\n    const id = await this.getNextId();\r\n\r\n    obj.set({\r\n      id,\r\n      left: x,\r\n      top: y,\r\n      originX: \"center\",\r\n      originY: \"center\",\r\n    } as Partial<fabric.ActiveSelection>);\r\n    if (obj._objects) {\r\n      obj.canvas = this;\r\n      obj.forEachObject((object) =>\r\n        this.getNextId().then((id_) => {\r\n          (object as ObjectId).id = id_;\r\n          this.add(object);\r\n        })\r\n      );\r\n      obj.setCoords();\r\n    } else {\r\n      this.add(obj);\r\n    }\r\n    this.setActiveObject(obj);\r\n    this.requestRenderAll();\r\n    return obj._objects || [obj];\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\nimport { Assert, IsSubType } from \"@mehra/ts\";\r\n\r\nimport { HistoryCommand } from \"./history\";\r\nimport Pages, { PageJSON } from \"./pages\";\r\nimport { Cursor } from \"./page\";\r\n\r\nexport class AsyncReader {\r\n  static readAsText = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsText(file);\r\n    });\r\n\r\n  static readAsDataURL = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsDataURL(file);\r\n    });\r\n}\r\n\r\n/**\r\n * Common to _all_ versions of exports\r\n */\r\ninterface QboardFile {\r\n  \"qboard-version\": number;\r\n  pages: PageJSON[];\r\n}\r\n\r\nconst isValidQboardFile = (object: unknown): object is QboardFile => {\r\n  if (object instanceof Object) {\r\n    return \"qboard-version\" in object;\r\n  }\r\n  return false;\r\n};\r\n\r\n/**\r\n * The current qboard file format\r\n */\r\ninterface CurrentQboardFile {\r\n  \"qboard-version\": 1;\r\n  pages: PageJSON[];\r\n}\r\n\r\n/**\r\n * @test Ensure that {@link CurrentQboardFile} is a subtype of {@link QboardFile}\r\n */\r\n{\r\n  // Inline test because ts doesn't let an interface implement another interface\r\n  // Technically outputs to JS but it gets optimized out by both the minifier and the optimizing compiler\r\n  const _test_compatible_file_fmt: IsSubType<\r\n    CurrentQboardFile,\r\n    QboardFile\r\n  > = true;\r\n}\r\n\r\n// manages version compatibility with old document formats\r\n// change the signature and usages to accommodate new data; this will fill in sample data for missing fields\r\nexport class JSONReader {\r\n  static read(json: string | ArrayBuffer): PageJSON[] {\r\n    const object: unknown = JSON.parse(json.toString());\r\n    return JSONReader.readParsed(object);\r\n  }\r\n\r\n  static readParsed(object: unknown): PageJSON[] {\r\n    Assert(isValidQboardFile(object));\r\n    return object.pages;\r\n  }\r\n}\r\n\r\nexport class JSONWriter {\r\n  private readonly sourceJSON: CurrentQboardFile;\r\n  private stringified: string;\r\n\r\n  constructor(pagesJSON: PageJSON[]) {\r\n    this.sourceJSON = {\r\n      \"qboard-version\": 1,\r\n      pages: pagesJSON,\r\n    };\r\n  }\r\n\r\n  toString = (): string => {\r\n    if (this.stringified !== undefined) return this.stringified;\r\n    this.stringified = JSON.stringify(this.sourceJSON);\r\n    return this.stringified;\r\n  };\r\n\r\n  toBlob = (): Blob =>\r\n    new Blob([this.toString()], { type: \"application/json\" });\r\n\r\n  toURL = (): [string, () => void] => {\r\n    const url = window.URL.createObjectURL(this.toBlob());\r\n    const revoke = () => window.URL.revokeObjectURL(url);\r\n    return [url, revoke];\r\n  };\r\n}\r\n\r\nexport type FileHandlerResponse = {\r\n  action: \"none\" | \"image\" | \"json\";\r\n  history?: HistoryCommand;\r\n};\r\n\r\nexport default class FileHandler {\r\n  constructor(public pages: Pages) {}\r\n\r\n  processFiles = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<HistoryCommand> => {\r\n    const images = [];\r\n    await Promise.all(\r\n      [...files].map(async (file) => {\r\n        if (file.type.startsWith(\"image/\")) {\r\n          images.push(await this.handleImage(file, cursor));\r\n        }\r\n        if (file.type === \"application/json\") {\r\n          return this.handleJSON(file);\r\n        }\r\n      })\r\n    );\r\n    return {\r\n      add: images.flat(),\r\n    };\r\n  };\r\n\r\n  acceptFile = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<FileHandlerResponse> => {\r\n    if (!files.length) return { action: \"none\" };\r\n    const [file] = files;\r\n\r\n    if (file.type.startsWith(\"image/\")) {\r\n      return {\r\n        action: \"image\",\r\n        history: { add: await this.handleImage(file, cursor) },\r\n      };\r\n    }\r\n\r\n    if (file.type === \"application/json\") {\r\n      await this.openFile(file);\r\n      return {\r\n        action: \"json\",\r\n        history: { clear: [true] },\r\n      };\r\n    }\r\n\r\n    // unsupported file\r\n    return { action: \"none\" };\r\n  };\r\n\r\n  openFile = async (file: File): Promise<boolean> => {\r\n    this.pages.savePage();\r\n    return this.pages.overwritePages(\r\n      JSONReader.read(await AsyncReader.readAsText(file))\r\n    );\r\n  };\r\n\r\n  private handleImage = async (\r\n    file: File,\r\n    cursor?: Cursor\r\n  ): Promise<fabric.Object[]> =>\r\n    new Promise<fabric.Object[]>((resolve) =>\r\n      AsyncReader.readAsDataURL(file).then((result) =>\r\n        fabric.Image.fromURL(result.toString(), (obj: fabric.Image) => {\r\n          resolve(this.pages.canvas.placeObject(obj, cursor));\r\n        })\r\n      )\r\n    );\r\n\r\n  private handleJSON = async (file: File): Promise<number> => {\r\n    const pages = JSONReader.read(await AsyncReader.readAsText(file));\r\n    return this.pages.insertPages(this.pages.currentIndex + 1, pages);\r\n  };\r\n}\r\n","import pdfMake from \"pdfmake/build/pdfmake.min\";\r\nimport { fabric } from \"fabric\";\r\n\r\nimport Page from \"./page\";\r\nimport { JSONWriter } from \"./files\";\r\n\r\nexport type PageJSON = {\r\n  version: string;\r\n  objects: fabric.Object[];\r\n  background: string;\r\n};\r\n\r\nconst defaultPageJSON: PageJSON = {\r\n  version: \"4.2.0\",\r\n  objects: [],\r\n  background: \"white\",\r\n};\r\n\r\nconst timeString = (): string => {\r\n  const offset = new Date().getTimezoneOffset() * 60000;\r\n  return new Date(Date.now() - offset)\r\n    .toISOString()\r\n    .slice(0, -8)\r\n    .replace(/\\D/g, \"-\");\r\n};\r\n\r\nexport default class Pages {\r\n  currentIndex = 0;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number,\r\n    public updateState: () => void,\r\n    public pagesJSON: PageJSON[] = [defaultPageJSON]\r\n  ) {}\r\n\r\n  savePage = (): void => {\r\n    this.pagesJSON[this.currentIndex] = this.canvas.toObject([\r\n      \"id\",\r\n      \"strokeUniform\",\r\n    ]);\r\n  };\r\n\r\n  loadPage = async (\r\n    index: number,\r\n    fromFile = false,\r\n    force = false\r\n  ): Promise<number> => {\r\n    if (index === this.currentIndex && !force) return index;\r\n    if (!fromFile) this.savePage();\r\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[index]);\r\n    this.currentIndex = index;\r\n    if (!fromFile || force) this.updateState();\r\n    return index;\r\n  };\r\n\r\n  newPage = async (fromFile = false): Promise<number> => {\r\n    this.pagesJSON.splice(this.currentIndex + 1, 0, defaultPageJSON);\r\n    return this.loadPage(this.currentIndex + 1, fromFile);\r\n  };\r\n\r\n  previousPage = async (): Promise<number> => {\r\n    if (this.currentIndex === 0) return 0;\r\n    return this.loadPage(this.currentIndex - 1);\r\n  };\r\n\r\n  nextOrNewPage = async (fromFile = false): Promise<number> => {\r\n    if (this.currentIndex === this.pagesJSON.length - 1) {\r\n      return this.newPage(fromFile);\r\n    }\r\n    return this.loadPage(this.currentIndex + 1, fromFile);\r\n  };\r\n\r\n  export = async (): Promise<void> => {\r\n    this.savePage();\r\n    const ratio = 2;\r\n    const content = [];\r\n    const currentIndexCopy = this.currentIndex;\r\n    for (const page of this.pagesJSON) {\r\n      await this.canvas.loadFromJSONAsync(page);\r\n      content.push({\r\n        svg: this.canvas.toSVG(),\r\n        width: this.canvasWidth / ratio,\r\n      });\r\n    }\r\n\r\n    const docDefinition = {\r\n      pageSize: {\r\n        width: this.canvasWidth / ratio,\r\n        height: this.canvasHeight / ratio,\r\n      },\r\n      pageMargins: [0, 0],\r\n      content,\r\n    };\r\n\r\n    pdfMake.createPdf(docDefinition).download(`qboard-${timeString()}.pdf`);\r\n\r\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[currentIndexCopy]);\r\n  };\r\n\r\n  saveFile = (): void => {\r\n    this.savePage();\r\n    const [fileURL, revokeURL] = new JSONWriter(this.pagesJSON).toURL();\r\n\r\n    const elt = document.createElement(\"a\");\r\n    elt.style.display = \"none\";\r\n    elt.href = fileURL;\r\n    elt.download = `qboard-${timeString()}.json`;\r\n    document.body.appendChild(elt);\r\n    elt.click();\r\n    elt.parentElement.removeChild(elt);\r\n\r\n    revokeURL();\r\n    this.canvas.modified = false;\r\n  };\r\n\r\n  overwritePages = async (\r\n    pages: PageJSON[] = [defaultPageJSON]\r\n  ): Promise<boolean> => {\r\n    const response =\r\n      !this.canvas.modified ||\r\n      this.pagesJSON.every((page) => page.objects.length === 0) ||\r\n      window.confirm(\r\n        \"Your work will be overwritten. Are you sure you wish to continue?\"\r\n      );\r\n    if (!response) return false;\r\n\r\n    this.pagesJSON = pages;\r\n    await this.loadPage(0, true, true);\r\n    this.canvas.modified = false;\r\n    return true;\r\n  };\r\n\r\n  insertPages = async (index: number, pages: PageJSON[]): Promise<number> => {\r\n    this.pagesJSON.splice(index, 0, ...pages);\r\n    this.canvas.modified = true;\r\n    return this.loadPage(index);\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nimport Page, { ObjectId } from \"./page\";\r\nimport Pages from \"./pages\";\r\n\r\ninterface HistoryItem {\r\n  ids: number[];\r\n  oldObjects: fabric.Object[] | null;\r\n  newObjects: fabric.Object[] | null;\r\n  page: number;\r\n}\r\n\r\nexport type HistoryCommand = {\r\n  add?: fabric.Object[];\r\n  remove?: fabric.Object[];\r\n  clear?: [boolean];\r\n};\r\n\r\nexport default class HistoryHandler {\r\n  history: HistoryItem[] = [];\r\n  redoStack: HistoryItem[] = [];\r\n  selection: fabric.Object[];\r\n  locked = false;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public pages: Pages,\r\n    public updateState: () => void\r\n  ) {}\r\n\r\n  execute = async (command: HistoryCommand = {}): Promise<void[]> => {\r\n    if (command.clear) this.clear(command.clear[0]);\r\n    const actions: Promise<void>[] = [\r\n      this.add(command.add),\r\n      this.remove(command.remove),\r\n    ];\r\n    return Promise.all(actions);\r\n  };\r\n\r\n  add = async (objects: fabric.Object[]): Promise<void> =>\r\n    objects?.length && this.save(null, objects);\r\n\r\n  remove = async (objects: fabric.Object[]): Promise<void> =>\r\n    objects?.length && this.save(objects, null);\r\n\r\n  clear = (clearRedo = false): void => {\r\n    this.history = [];\r\n    if (clearRedo) this.redoStack = [];\r\n    this.updateState();\r\n  };\r\n\r\n  store = async (objects: fabric.Object[]): Promise<void> => {\r\n    if (this.locked) return;\r\n    this.locked = true;\r\n    this.selection = await this.canvas.serialize(objects);\r\n    this.locked = false;\r\n  };\r\n\r\n  modify = async (objects: fabric.Object[]): Promise<void> =>\r\n    this.save(this.selection, objects);\r\n\r\n  save = async (\r\n    oldObjects: fabric.Object[] | null,\r\n    newObjects: fabric.Object[] | null\r\n  ): Promise<void> => {\r\n    if (this.locked) return;\r\n    const basis = newObjects || oldObjects;\r\n    this.locked = true;\r\n    this.history.push({\r\n      ids: basis.map((object: ObjectId) => object.id),\r\n      oldObjects: newObjects\r\n        ? oldObjects\r\n        : await this.canvas.serialize(oldObjects),\r\n      newObjects: newObjects && (await this.canvas.serialize(newObjects)),\r\n      page: this.pages.currentIndex,\r\n    });\r\n    this.locked = false;\r\n    this.redoStack = [];\r\n    this.canvas.modified = true;\r\n    this.updateState();\r\n  };\r\n\r\n  undo = async (): Promise<void> => {\r\n    if (!this.history.length) return;\r\n    this.canvas.discardActiveObject();\r\n    await this.move(this.history, this.redoStack, true);\r\n  };\r\n\r\n  redo = async (): Promise<void> => {\r\n    if (!this.redoStack.length) return;\r\n    await this.move(this.redoStack, this.history, false);\r\n  };\r\n\r\n  private move = async (\r\n    from: HistoryItem[],\r\n    to: HistoryItem[],\r\n    isUndo: boolean\r\n  ): Promise<void> => {\r\n    this.locked = true;\r\n    const last = from.pop();\r\n    await this.pages.loadPage(last.page);\r\n    this.canvas.apply(last.ids, isUndo ? last.oldObjects : last.newObjects);\r\n    to.push(last);\r\n    this.locked = false;\r\n    this.canvas.modified = true;\r\n    this.updateState();\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nimport Page from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport HistoryHandler from \"./history\";\r\n\r\nexport default class ClipboardHandler {\r\n  clipboard: fabric.Object;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number\r\n  ) {\r\n    window.addEventListener(\"paste\", this.pasteExternal);\r\n  }\r\n\r\n  copy = async (): Promise<fabric.Object> => {\r\n    const objects: fabric.Object = this.canvas.getActiveObject();\r\n    if (!objects) return null;\r\n    objects.clone((clone) => {\r\n      this.clipboard = clone;\r\n    });\r\n    return objects;\r\n  };\r\n\r\n  cut = async (): Promise<boolean> => {\r\n    const objects = (await this.copy()) as fabric.ActiveSelection;\r\n    if (!objects) return false;\r\n    this.canvas.discardActiveObject();\r\n    if (objects.type === \"activeSelection\") {\r\n      objects.forEachObject((object) => {\r\n        this.canvas.remove(object);\r\n      });\r\n      await this.history.remove(objects._objects);\r\n    } else {\r\n      this.canvas.remove(objects);\r\n      await this.history.remove([objects]);\r\n    }\r\n    this.canvas.requestRenderAll();\r\n    return true;\r\n  };\r\n\r\n  paste = async (): Promise<void> => {\r\n    if (!this.clipboard) return;\r\n    return this.clipboard.clone((clone) =>\r\n      this.canvas.placeObject(clone).then(this.history.add)\r\n    );\r\n  };\r\n\r\n  pasteExternal = async (e: ClipboardEvent): Promise<void> => {\r\n    const historyCommand = await this.files.processFiles(e.clipboardData.files);\r\n    await this.history.execute(historyCommand);\r\n    await this.paste();\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nexport const enum Dash {\r\n  Solid,\r\n  Dashed,\r\n  Dotted,\r\n}\r\n\r\nexport const enum Stroke {\r\n  Black = \"#000000\",\r\n  Blue = \"#0097f6\",\r\n  Green = \"#00b253\",\r\n  Yellow = \"#ffbf00\",\r\n  Orange = \"#ff2600\",\r\n}\r\n\r\nexport const enum Fill {\r\n  Transparent,\r\n  Solid,\r\n  HalfSolid,\r\n}\r\n\r\nexport interface Style {\r\n  dash: Dash;\r\n  stroke: Stroke;\r\n  fill: Fill;\r\n}\r\n\r\nconst dashMap = [\r\n  [0, 0],\r\n  [20, 15],\r\n  [5, 10],\r\n];\r\n\r\nexport default class StyleHandler {\r\n  constructor(\r\n    public currentStyle: Style,\r\n    public drawerOptions: fabric.IObjectOptions,\r\n    public freeDrawingBrush: fabric.BaseBrush,\r\n    public updateState: () => void\r\n  ) {}\r\n\r\n  set = (dash: Dash | null, stroke: Stroke | null, fill: Fill | null): void => {\r\n    if (dash !== null) {\r\n      this.currentStyle.dash = dash;\r\n      this.drawerOptions.strokeDashArray = dashMap[dash];\r\n      this.freeDrawingBrush.strokeDashArray = dashMap[dash];\r\n    }\r\n\r\n    if (stroke !== null) {\r\n      this.currentStyle.stroke = stroke;\r\n      this.drawerOptions.stroke = stroke;\r\n      this.freeDrawingBrush.color = stroke;\r\n    }\r\n\r\n    if (fill !== null) {\r\n      this.currentStyle.fill = fill;\r\n    }\r\n\r\n    if (stroke !== null || fill !== null) {\r\n      switch (this.currentStyle.fill) {\r\n        case Fill.Transparent: {\r\n          this.drawerOptions.fill = \"transparent\";\r\n          break;\r\n        }\r\n        case Fill.Solid: {\r\n          this.drawerOptions.fill = this.currentStyle.stroke;\r\n          break;\r\n        }\r\n        case Fill.HalfSolid: {\r\n          this.drawerOptions.fill = `${this.currentStyle.stroke}11`;\r\n          break;\r\n        }\r\n      }\r\n    }\r\n\r\n    this.updateState();\r\n  };\r\n}\r\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\n\r\nimport Overlay from \"./components/Overlay\";\r\nimport QBoard from \"./lib/qboard\";\r\n\r\nimport \"./main.scss\";\r\n\r\nconst qboard = new QBoard(\r\n  document.querySelector(\"#QBoard\"),\r\n  document.querySelector(\"#BaseQBoard\"),\r\n  1600,\r\n  900\r\n);\r\n\r\nReactDOM.render(\r\n  <Overlay qboard={qboard} />,\r\n  document.querySelector(\"#Overlay\")\r\n);\r\n","import { fabric } from \"fabric\";\r\nimport { Network } from \"@mehra/ts\";\r\n\r\nimport ToolHandler, { Handlers, Tool } from \"./tools\";\r\nimport Page, { ObjectId } from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler, { JSONReader } from \"./files\";\r\nimport HistoryHandler from \"./history\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport StyleHandler, { Dash, Fill, Stroke, Style } from \"./styles\";\r\nimport ActionHandler from \"./action\";\r\nimport KeyboardHandler, { KeyMap } from \"./keyboard\";\r\n\r\nexport interface QBoardState {\r\n  dragActive: boolean;\r\n  currentPage: number;\r\n  totalPages: number;\r\n  currentTool: Tool;\r\n  currentStyle: Style;\r\n  canUndo: boolean;\r\n  canRedo: boolean;\r\n  keyMap: KeyMap;\r\n}\r\n\r\nexport default class QBoard {\r\n  baseCanvas: Page;\r\n  canvas: Page;\r\n  pages: Pages;\r\n  files: FileHandler;\r\n  history: HistoryHandler;\r\n  clipboard: ClipboardHandler;\r\n  style: StyleHandler;\r\n  action: ActionHandler;\r\n  keyboard: KeyboardHandler;\r\n\r\n  handlers: ToolHandler[] = Handlers;\r\n  currentStyle: Style = {\r\n    dash: Dash.Solid,\r\n    stroke: Stroke.Black,\r\n    fill: Fill.Transparent,\r\n  };\r\n  drawerOptions: fabric.IObjectOptions = {\r\n    fill: \"transparent\",\r\n    stroke: \"#000000\",\r\n    strokeWidth: 4,\r\n    selectable: false,\r\n    strokeDashArray: [0, 0],\r\n    strokeUniform: true,\r\n  };\r\n\r\n  resizeCooldown: NodeJS.Timeout;\r\n  currentTool: Tool;\r\n  tool: ToolHandler;\r\n  currentObject: fabric.Object;\r\n  dragActive = false;\r\n  isDown = false;\r\n  strict = false;\r\n  callback: (state: QBoardState) => void;\r\n\r\n  constructor(\r\n    public canvasElement: HTMLCanvasElement,\r\n    public baseCanvasElement: HTMLCanvasElement,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number\r\n  ) {\r\n    const queryParams = new URLSearchParams(window.location.search);\r\n\r\n    this.baseCanvas = new Page(baseCanvasElement, {\r\n      backgroundColor: \"white\",\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n      targetFindTolerance: 15,\r\n    });\r\n    this.canvas = new Page(canvasElement, {\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n    });\r\n    this.pages = new Pages(\r\n      this.baseCanvas,\r\n      this.canvasWidth,\r\n      this.canvasHeight,\r\n      this.updateState\r\n    );\r\n\r\n    if (queryParams.get(\"json\") !== null)\r\n      Network.loadJSON(queryParams.get(\"json\"))\r\n        .then(JSONReader.readParsed)\r\n        .then(this.pages.overwritePages)\r\n        .catch(console.error);\r\n\r\n    this.files = new FileHandler(this.pages);\r\n    this.history = new HistoryHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.updateState\r\n    );\r\n    this.clipboard = new ClipboardHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.canvasWidth,\r\n      this.canvasHeight\r\n    );\r\n    this.style = new StyleHandler(\r\n      this.currentStyle,\r\n      this.drawerOptions,\r\n      this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n      this.updateState\r\n    );\r\n    this.action = new ActionHandler(\r\n      this.switchTool,\r\n      this.currentStyle,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.clipboard,\r\n      this.style.set\r\n    );\r\n    this.keyboard = new KeyboardHandler(\r\n      this.action.doAction,\r\n      (strict: boolean) => (this.strict = strict),\r\n      this.updateState\r\n    );\r\n\r\n    void this.switchTool(Tool.Move);\r\n    void this.windowResize();\r\n\r\n    window.onresize = this.windowResize;\r\n    window.onbeforeunload = () => this.baseCanvas.modified || null;\r\n\r\n    this.canvas.on(\"mouse:down\", this.mouseDown);\r\n    this.canvas.on(\"mouse:move\", this.mouseMove);\r\n    this.canvas.on(\"mouse:up\", this.mouseUp);\r\n\r\n    this.baseCanvas.on(\"dragenter\", () => this.setDragActive(true));\r\n    this.baseCanvas.on(\"dragleave\", () => this.setDragActive(false));\r\n    this.baseCanvas.on(\"drop\", this.drop);\r\n\r\n    this.baseCanvas.on(\"path:created\", this.pathCreated);\r\n    this.baseCanvas.on(\"selection:created\", this.selectionCreated);\r\n    this.baseCanvas.on(\"object:modified\", this.objectModified);\r\n    this.baseCanvas.on(\"mouse:move\", this.updateCursor);\r\n  }\r\n\r\n  updateState = (): void => {\r\n    this?.callback?.({\r\n      dragActive: this.dragActive,\r\n      currentPage: this.pages.currentIndex + 1,\r\n      totalPages: this.pages.pagesJSON.length,\r\n      currentTool: this.currentTool,\r\n      currentStyle: this.currentStyle,\r\n      canUndo: this.history.history.length > 0,\r\n      canRedo: this.history.redoStack.length > 0,\r\n      keyMap: this.keyboard.keyMap,\r\n    });\r\n  };\r\n\r\n  switchTool = async (tool: Tool): Promise<void> => {\r\n    if (tool === Tool.Eraser) {\r\n      if (await this.clipboard.cut()) return;\r\n    }\r\n\r\n    this.currentTool = tool;\r\n    this.tool = this.handlers[tool];\r\n\r\n    if (tool === Tool.Move || this.tool.isBrush) {\r\n      await this.baseCanvas.activateSelection();\r\n      this.canvasElement.parentElement.style.display = \"none\";\r\n      await this.tool.setBrush?.(\r\n        this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n        this.drawerOptions\r\n      );\r\n    } else {\r\n      await this.baseCanvas.deactivateSelection();\r\n      this.canvasElement.parentElement.style.display = \"block\";\r\n    }\r\n\r\n    this.baseCanvas.isDrawingMode = this.tool.isBrush;\r\n\r\n    this.updateState();\r\n  };\r\n\r\n  windowResize = async (): Promise<void> => {\r\n    clearTimeout(this.resizeCooldown);\r\n    this.resizeCooldown = setTimeout(async () => {\r\n      await this.canvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n      await this.baseCanvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n    }, 100);\r\n  };\r\n\r\n  mouseDown = async (e: fabric.IEvent): Promise<void> => {\r\n    if (!this.tool.draw) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n    this.isDown = true;\r\n    this.currentObject = await this.tool.draw(x, y, this.drawerOptions);\r\n    (this.currentObject as ObjectId).id = await this.baseCanvas.getNextId();\r\n    this.canvas.add(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseMove = async (e: fabric.IEvent): Promise<void> => {\r\n    if (!(this.tool.draw && this.isDown)) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n    await this.tool.resize(this.currentObject, x, y, this.strict);\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseUp = async (): Promise<void> => {\r\n    if (!this.tool.draw) return;\r\n\r\n    this.isDown = false;\r\n    this.baseCanvas.add(fabric.util.object.clone(this.currentObject));\r\n    this.baseCanvas.requestRenderAll();\r\n    this.canvas.remove(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n    await this.history.add([this.currentObject]);\r\n  };\r\n\r\n  setDragActive = (state: boolean): void => {\r\n    this.dragActive = state;\r\n    this.updateState();\r\n  };\r\n\r\n  drop = async (iEvent: fabric.IEvent): Promise<void> => {\r\n    iEvent.e.stopPropagation();\r\n    iEvent.e.preventDefault();\r\n    this.updateCursor(iEvent);\r\n    this.setDragActive(false);\r\n\r\n    const historyCommand = await this.files.processFiles(\r\n      (iEvent.e as DragEvent).dataTransfer.files\r\n    );\r\n    await this.history.execute(historyCommand);\r\n  };\r\n\r\n  pathCreated = async (e: any): Promise<void> => {\r\n    if (this.currentTool === Tool.Pen) {\r\n      e.path.id = await this.baseCanvas.getNextId();\r\n      await this.history.add([e.path]);\r\n    } else if (this.currentTool === Tool.Eraser) {\r\n      const path = fabric.util.object.clone(e.path);\r\n      this.baseCanvas.remove(e.path);\r\n      const objects = this.baseCanvas\r\n        .getObjects()\r\n        .filter((object) => object.intersectsWithObject(path));\r\n      if (!objects.length) return;\r\n      this.baseCanvas.remove(...objects);\r\n      await this.history.remove(objects);\r\n    } else if (this.currentTool === Tool.Laser) {\r\n      setTimeout(async () => {\r\n        this.baseCanvas.remove(e.path);\r\n        this.baseCanvas.requestRenderAll();\r\n      }, 1000);\r\n    }\r\n  };\r\n\r\n  selectionCreated = (e: any): Promise<void> =>\r\n    !this.history.locked && this.history.store(e.selected);\r\n\r\n  objectModified = async (e: any): Promise<void> => {\r\n    await this.history.modify(e.target._objects || [e.target]);\r\n    await this.history.store(e.target._objects || [e.target]);\r\n  };\r\n\r\n  updateCursor = (e: fabric.IEvent): void => {\r\n    const { x, y } = this.baseCanvas.getPointer(e.e);\r\n    this.baseCanvas.cursor = { x, y };\r\n  };\r\n}\r\n"],"sourceRoot":""}