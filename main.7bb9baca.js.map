{"version":3,"sources":["webpack:///./src/lib/action.ts","webpack:///./src/lib/keyboard.ts","webpack:///./src/components/Icon.tsx","webpack:///./src/components/OverlayButton.tsx","webpack:///./src/components/Pagination.tsx","webpack:///./src/components/UndoRedo.tsx","webpack:///./src/components/Toolbar.tsx","webpack:///./src/components/ButtonRow.tsx","webpack:///./src/components/StyleMenu.tsx","webpack:///./src/components/Stylebar.tsx","webpack:///./src/components/BindingModal.tsx","webpack:///./src/components/Bindings.tsx","webpack:///./src/components/HelpModal.tsx","webpack:///./src/components/ContextMenu.tsx","webpack:///./src/components/Overlay.tsx","webpack:///./src/lib/tools.ts","webpack:///./src/lib/page.ts","webpack:///./src/lib/files.ts","webpack:///./src/lib/pages.ts","webpack:///./src/lib/history.ts","webpack:///./src/lib/clipboard.ts","webpack:///./src/lib/styles.ts","webpack:///./src/lib/error.ts","webpack:///./src/lib/network.ts","webpack:///./src/index.js","webpack:///./src/lib/qboard.ts"],"names":["Action","nameMap","previousPage","nextPage","addPage","selectAll","duplicate","eraser","rectangle","transparent","halfFilled","resetStyles","fullScreen","enterFullScreen","exitFullScreen","actionName","action","name","toUpperCase","slice","switchTool","currentStyle","pages","files","history","clipboard","setStyle","doAction","async","this","actionMap","setDash","dash","setStroke","stroke","setFill","fill","canvas","nextOrNewPage","undo","redo","open","openFile","save","saveFile","export","cut","copy","paste","deselect","discardActiveObject","requestRenderAll","setActiveObject","fabric","ActiveSelection","getObjects","then","move","pen","laser","line","ellipse","dotted","dashed","solid","blue","green","yellow","orange","black","filled","document","fullscreenElement","ExitFullScreen","EnterFullScreen","documentElement","requestFullscreen","exitFullscreen","defaultKeys","q","Laser","w","Copy","e","Blue","esc","Deselect","r","Green","a","PreviousPage","s","NextPage","d","Pen","f","Undo","g","Paste","z","ResetStyles","x","Eraser","c","Line","v","Move","Dotted","Transparent","Ellipse","Rectangle","Dashed","HalfFilled","Black","Redo","Solid","Filled","Yellow","Orange","SelectAll","Save","Duplicate","Cut","mirrorMap","tab","t","shift","b","mirror","key","setStrict","updateState","keyMap","window","localStorage","setItem","JSON","stringify","bindAll","value","Object","entries","bind","unbind","reset","keys","getItem","parse","fasIcon","iconName","style","className","close","transform","file","color","viewBox","width","height","marginRight","position","left","opacity","top","props","undefined","onClick","callback","backgroundColor","effect","id","place","textColor","setValue","setWidth","currentPage","toString","length","navigate","page","Number","totalPages","loadPage","visibility","onSubmit","preventDefault","onChange","target","type","tabIndex","AddPage","canUndo","canRedo","tools","map","tool","index","currentTool","cName","outerButton","actions","i","DashStyle","dashes","button","dashStyle","inContext","StrokeStyle","strokes","strokeMap","strokeStyle","FillStyle","fills","fillStyle","fileInputRef","fileButton","fileActions","Open","Export","otherActions","mobileActions","isMobile","FullScreen","isFullscreen","setIsFullscreen","Boolean","addEventListener","accept","acceptFile","multiple","ref","current","click","setAppElement","nonBinding","overlayClassName","isOpen","letter","values","includes","HeaderKey","leftHanded","label","Key","bindingModalKeys","setBindingModalKeys","bindingModalAction","setBindingModalAction","rows","header","letters","split","getModified","modifier","keyHandler","reverse","keyModifier","setKeyModifier","setLeftHanded","toggleOpen","fontSize","fontWeight","marginLeft","wasLeftHanded","href","toggleMobility","coords","setCoords","oldCoords","clientX","clientY","qboard","setVisibility","helpModalOpen","setHelpModalOpen","setMobility","state","setState","dragActive","wasOpen","currentVisibility","execute","keyboard","wasMobile","rectify","dirs","y","x2","y2","ox","oy","vx","vy","side","sq","Math","abs","project","reduce","acc","cur","Handlers","isBrush","setBrush","brush","options","strokeDashArray","strokeWidth","draw","Promise","resolve","perPixelTargetFind","resize","object","strict","set","Rect","originX","originY","rx","ry","Canvas","latestId","modified","fitToWindow","canvasWidth","canvasHeight","widthRatio","innerWidth","heightRatio","innerHeight","setZoom","min","getZoom","setHeight","deactivateSelection","isDrawingMode","selection","forEachObject","selectable","activateSelection","getNextId","getObjectByIds","ids","filter","serialize","objects","toObject","apply","newObjects","oldObjects","remove","addObjects","forEach","add","util","enlivenObjects","loadFromJSONAsync","json","super","loadFromJSON","placeObject","obj","cursor","_objects","id_","AsyncReader","readAsText","reject","reader","FileReader","onload","result","onerror","readAsDataURL","JSONReader","readParsed","version","JSONWriter","pagesJSON","stringified","sourceJSON","toBlob","Blob","toURL","url","URL","createObjectURL","revokeObjectURL","processFiles","images","all","startsWith","push","handleImage","handleJSON","flat","clear","savePage","overwritePages","read","Image","fromURL","insertPages","currentIndex","defaultPageJSON","background","timeString","offset","Date","getTimezoneOffset","now","toISOString","replace","fromFile","force","newPage","splice","content","currentIndexCopy","svg","toSVG","docDefinition","pageSize","pageMargins","createPdf","download","fileURL","revokeURL","elt","createElement","display","body","appendChild","parentElement","removeChild","every","confirm","HistoryHandler","redoStack","locked","command","clearRedo","store","modify","basis","from","to","isUndo","last","pop","ClipboardHandler","getActiveObject","clone","pasteExternal","historyCommand","clipboardData","dashMap","StyleHandler","drawerOptions","freeDrawingBrush","CustomError","Error","message","constructor","code","ResourceNotFoundException","Network","filePath","fetch","xhr","overrideMimeType","responseType","response","prerequest","method","resolveCondition","status","XMLHttpRequest","send","onreadystatechange","readyState","statusText","canvasElement","baseCanvasElement","handlers","strokeUniform","isDown","baseCanvas","windowResize","clearTimeout","resizeCooldown","setTimeout","mouseDown","getPointer","currentObject","mouseMove","mouseUp","setDragActive","drop","iEvent","stopPropagation","updateCursor","dataTransfer","pathCreated","path","intersectsWithObject","selectionCreated","selected","objectModified","queryParams","URLSearchParams","location","search","renderOnAddRemove","targetFindTolerance","get","loadJSON","catch","console","error","onresize","onbeforeunload","on","querySelector","ReactDOM","render"],"mappings":"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","file":"main.7bb9baca.js","sourcesContent":["import { fabric } from \"fabric\";\r\n\r\nimport { Tool } from \"./tools\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport HistoryHandler from \"./history\";\r\nimport { Dash, Fill, Stroke, Style } from \"./styles\";\r\n\r\nexport enum Action {\r\n  PreviousPage = \"previousPage\",\r\n  NextPage = \"nextPage\",\r\n  AddPage = \"addPage\",\r\n\r\n  Undo = \"undo\",\r\n  Redo = \"redo\",\r\n\r\n  Open = \"open\",\r\n  Save = \"save\",\r\n  Export = \"export\",\r\n  Cut = \"cut\",\r\n  Copy = \"copy\",\r\n  Paste = \"paste\",\r\n\r\n  Deselect = \"deselect\",\r\n  SelectAll = \"selectAll\",\r\n  Duplicate = \"duplicate\",\r\n\r\n  Move = \"move\",\r\n  Pen = \"pen\",\r\n  Eraser = \"eraser\",\r\n  Laser = \"laser\",\r\n  Line = \"line\",\r\n  Ellipse = \"ellipse\",\r\n  Rectangle = \"rectangle\",\r\n\r\n  Dotted = \"dotted\",\r\n  Dashed = \"dashed\",\r\n  Solid = \"solid\",\r\n\r\n  Black = \"black\",\r\n  Blue = \"blue\",\r\n  Green = \"green\",\r\n  Orange = \"orange\",\r\n  Yellow = \"yellow\",\r\n\r\n  Transparent = \"transparent\",\r\n  HalfFilled = \"halfFilled\",\r\n  Filled = \"filled\",\r\n\r\n  ResetStyles = \"resetStyles\",\r\n  FullScreen = \"fullScreen\",\r\n  EnterFullScreen = \"enterFullScreen\",\r\n  ExitFullScreen = \"exitFullScreen\",\r\n}\r\n\r\nconst nameMap = {\r\n  previousPage: \"–Page\",\r\n  nextPage: \"+Page\",\r\n  addPage: \"+Page\",\r\n  selectAll: \"Select All\",\r\n  duplicate: \"Clone\",\r\n  eraser: \"Cut / Eraser\",\r\n  rectangle: \"Rect.\",\r\n  transparent: \"Unfilled\",\r\n  halfFilled: \"Half Fill\",\r\n  resetStyles: \"Reset Styles\",\r\n  fullScreen: \"Full Screen\",\r\n  enterFullScreen: \"Enter Full Screen\",\r\n  exitFullScreen: \"Exit Full Screen\",\r\n};\r\n\r\nexport const actionName = (action: Action): string => {\r\n  const name = nameMap[action] || action;\r\n  return name && name[0].toUpperCase() + name.slice(1);\r\n};\r\n\r\nexport default class ActionHandler {\r\n  canvas: fabric.Canvas;\r\n  actionMap: unknown;\r\n\r\n  constructor(\r\n    public switchTool: (tool: Tool) => Promise<void>,\r\n    public currentStyle: Style,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public clipboard: ClipboardHandler,\r\n    public setStyle: (\r\n      dash: Dash | null,\r\n      stroke: Stroke | null,\r\n      fill: Fill | null\r\n    ) => void\r\n  ) {\r\n    this.canvas = this.pages.canvas;\r\n\r\n    this.actionMap = {\r\n      previousPage: pages.previousPage,\r\n      nextPage: pages.nextOrNewPage,\r\n      addPage: pages.nextOrNewPage,\r\n\r\n      undo: history.undo,\r\n      redo: history.redo,\r\n\r\n      open: files.openFile,\r\n      save: pages.saveFile,\r\n      export: pages.export,\r\n      cut: clipboard.cut,\r\n      copy: clipboard.copy,\r\n      paste: clipboard.paste,\r\n\r\n      deselect: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      selectAll: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.setActiveObject(\r\n          new fabric.ActiveSelection(this.canvas.getObjects(), {\r\n            canvas: this.canvas,\r\n          })\r\n        );\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      duplicate: () => this.clipboard.copy().then(() => this.clipboard.paste()),\r\n\r\n      move: () => this.switchTool(Tool.Move),\r\n      pen: () => this.switchTool(Tool.Pen),\r\n      eraser: () => this.switchTool(Tool.Eraser),\r\n      laser: () => this.switchTool(Tool.Laser),\r\n      line: () => this.switchTool(Tool.Line),\r\n      ellipse: () => this.switchTool(Tool.Ellipse),\r\n      rectangle: () => this.switchTool(Tool.Rectangle),\r\n\r\n      dotted: () => this.setDash(Dash.Dotted),\r\n      dashed: () => this.setDash(Dash.Dashed),\r\n      solid: () => this.setDash(Dash.Solid),\r\n\r\n      blue: () => this.setStroke(Stroke.Blue),\r\n      green: () => this.setStroke(Stroke.Green),\r\n      yellow: () => this.setStroke(Stroke.Yellow),\r\n      orange: () => this.setStroke(Stroke.Orange),\r\n      black: () => this.setStroke(Stroke.Black),\r\n\r\n      transparent: () => this.setFill(Fill.Transparent),\r\n      halfFilled: () => this.setFill(Fill.HalfSolid),\r\n      filled: () => this.setFill(Fill.Solid),\r\n\r\n      resetStyles: () =>\r\n        this.setStyle(Dash.Solid, Stroke.Black, Fill.Transparent),\r\n      fullScreen: () =>\r\n        this.doAction(\r\n          !document.fullscreenElement\r\n            ? Action.EnterFullScreen\r\n            : Action.ExitFullScreen\r\n        ),\r\n      enterFullScreen: () => document.documentElement.requestFullscreen(),\r\n      exitFullScreen: () => document.exitFullscreen(),\r\n    };\r\n  }\r\n\r\n  doAction = async (action: Action): Promise<void> => this.actionMap[action]();\r\n\r\n  setDash = async (dash: Dash): Promise<void> => {\r\n    if (dash === this.currentStyle.dash) {\r\n      this.setStyle(Dash.Solid, null, null);\r\n    } else {\r\n      this.setStyle(dash, null, null);\r\n    }\r\n  };\r\n\r\n  setStroke = async (stroke: Stroke): Promise<void> => {\r\n    if (stroke === this.currentStyle.stroke) {\r\n      this.setStyle(null, Stroke.Black, null);\r\n    } else {\r\n      this.setStyle(null, stroke, null);\r\n    }\r\n  };\r\n\r\n  setFill = async (fill: Fill): Promise<void> => {\r\n    if (fill === this.currentStyle.fill) {\r\n      this.setStyle(null, null, Fill.Transparent);\r\n    } else {\r\n      this.setStyle(null, null, fill);\r\n    }\r\n  };\r\n}\r\n","import keyboardJS from \"keyboardjs\";\n\nimport { Action } from \"./action\";\n\nexport type KeyMap = {\n  [key: string]: Action;\n};\n\nexport type MirrorMap = {\n  [key: string]: string;\n};\n\nexport const defaultKeys: KeyMap = {\n  q: Action.Laser,\n  w: Action.Copy,\n  e: Action.Blue,\n  esc: Action.Deselect,\n  r: Action.Green,\n  a: Action.PreviousPage,\n  s: Action.NextPage,\n  d: Action.Pen,\n  f: Action.Undo,\n  g: Action.Paste,\n  z: Action.ResetStyles,\n  x: Action.Eraser,\n  c: Action.Line,\n  v: Action.Move,\n\n  \"shift + q\": Action.Dotted,\n  \"shift + w\": Action.Transparent,\n  \"shift + e\": Action.Ellipse,\n  \"shift + r\": Action.Rectangle,\n  \"shift + a\": Action.Dashed,\n  \"shift + s\": Action.HalfFilled,\n  \"shift + d\": Action.Black,\n  \"shift + f\": Action.Redo,\n  \"shift + z\": Action.Solid,\n  \"shift + x\": Action.Filled,\n  \"shift + c\": Action.Yellow,\n  \"shift + v\": Action.Orange,\n\n  \"ctrl + a\": Action.SelectAll,\n  \"ctrl + s\": Action.Save,\n  \"ctrl + d\": Action.Duplicate,\n  \"ctrl + z\": Action.Undo,\n  \"ctrl + x\": Action.Cut,\n  \"ctrl + c\": Action.Copy,\n};\n\nconst mirrorMap: MirrorMap = {\n  tab: \"[\",\n  q: \"p\",\n  w: \"o\",\n  e: \"i\",\n  r: \"u\",\n  t: \"y\",\n  esc: \"'\",\n  a: \";\",\n  s: \"l\",\n  d: \"k\",\n  f: \"j\",\n  g: \"h\",\n  shift: \"shift\",\n  z: \"/\",\n  x: \".\",\n  c: \",\",\n  v: \"m\",\n  b: \"n\",\n};\n\nexport const mirror = (key: string): string => {\n  return mirrorMap[key] || key.slice(0, -1) + mirrorMap[key.slice(-1)];\n};\n\nexport default class KeyboardHandler {\n  keyMap: KeyMap = {};\n\n  constructor(\n    public doAction: (action: Action) => Promise<void>,\n    public setStrict: (strict: boolean) => void,\n    public updateState: () => void\n  ) {\n    keyboardJS.bind(\n      \"shift\",\n      () => {\n        this.setStrict(true);\n      },\n      () => {\n        this.setStrict(false);\n      }\n    );\n\n    if (!window.localStorage.getItem(\"keyMap\")) {\n      this.reset();\n    } else {\n      this.keyMap = JSON.parse(window.localStorage.getItem(\"keyMap\"));\n      this.bindAll();\n    }\n  }\n\n  save = (): void => {\n    window.localStorage.setItem(\"keyMap\", JSON.stringify(this.keyMap));\n  };\n\n  bindAll = (): void => {\n    for (const [key, value] of Object.entries(this.keyMap)) {\n      this.bind(key, value);\n    }\n    this.updateState();\n  };\n\n  unbind = (key: string): void => {\n    delete this.keyMap[key];\n    keyboardJS.unbind(key);\n    keyboardJS.unbind(mirror(key));\n    this.updateState();\n    this.save();\n  };\n\n  bind = (key: string, action: Action): void => {\n    this.keyMap[key] = action;\n    keyboardJS.bind(key, () => this.doAction(this.keyMap[key]));\n    keyboardJS.bind(mirror(key), () => this.doAction(this.keyMap[key]));\n    this.updateState();\n    this.save();\n  };\n\n  reset = (): void => {\n    for (const key of Object.keys(this.keyMap)) {\n      keyboardJS.unbind(key);\n      keyboardJS.unbind(mirror(key));\n    }\n    this.keyMap = { ...defaultKeys };\n    this.bindAll();\n    this.save();\n  };\n}\n","import React from \"react\";\n\nimport { Stroke } from \"../lib/styles\";\n\nconst fasIcon = (iconName: string, style?: unknown) => (\n  <i className={`fas fa-${iconName}`} style={style} />\n);\n\nconst Icon = {\n  close: fasIcon(\"times-circle\"),\n\n  previousPage: fasIcon(\"caret-left\"),\n  nextPage: fasIcon(\"caret-right\"),\n  addPage: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\n\n  undo: fasIcon(\"undo\"),\n  redo: fasIcon(\"redo\"),\n\n  move: fasIcon(\"mouse-pointer\"),\n  pen: fasIcon(\"pen\"),\n  eraser: fasIcon(\"eraser\"),\n  laser: fasIcon(\"asterisk\"),\n  line: fasIcon(\"minus\", { transform: \"rotate(-45deg)\" }),\n  ellipse: fasIcon(\"circle\"),\n  rectangle: fasIcon(\"square\"),\n\n  file: fasIcon(\"file\"),\n  open: fasIcon(\"folder-open\"),\n  save: fasIcon(\"save\"),\n  export: fasIcon(\"file-export\"),\n  cut: fasIcon(\"cut\"),\n  copy: fasIcon(\"copy\"),\n  paste: fasIcon(\"paste\"),\n\n  duplicate: fasIcon(\"clone\"),\n\n  fullScreen: fasIcon(\"expand\"),\n  enterFullScreen: fasIcon(\"expand\"),\n  exitFullScreen: fasIcon(\"compress\"),\n\n  black: fasIcon(\"circle\", { color: Stroke.Black }),\n  blue: fasIcon(\"circle\", { color: Stroke.Blue }),\n  green: fasIcon(\"circle\", { color: Stroke.Green }),\n  orange: fasIcon(\"circle\", { color: Stroke.Orange }),\n  yellow: fasIcon(\"circle\", { color: Stroke.Yellow }),\n\n  dotted: (\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\n      <g transform=\"translate(-90 -1158)\">\n        <g>\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\n        </g>\n      </g>\n    </svg>\n  ),\n  dashed: (\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\n      <g transform=\"translate(-90 -1158)\">\n        <g>\n          <path d=\"M101,1176.92v2.021c1.735-0.192,3.319-0.878,4.613-1.913l-1.43-1.43C103.269,1176.284,102.183,1176.75,101,1176.92z\" />\n          <path d=\"M93.08,1171h-2.021c0.191,1.735,0.879,3.319,1.914,4.614l1.43-1.43C93.716,1173.269,93.25,1172.183,93.08,1171z\" />\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\n          <path d=\"M106.92,1169h2.021c-0.191-1.735-0.879-3.319-1.914-4.614l-1.43,1.43C106.284,1166.731,106.75,1167.817,106.92,1169z\" />\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\n          <path d=\"M99,1163.08v-2.021c-1.735,0.192-3.319,0.878-4.613,1.913l1.43,1.43C96.731,1163.716,97.817,1163.25,99,1163.08z\" />\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\n        </g>\n      </g>\n    </svg>\n  ),\n  solid: <i className=\"far fa-circle\" />,\n\n  transparent: <i className=\"far fa-circle\" />,\n  halfFilled: (\n    <div style={{ height: \"0.7em\", marginRight: \"1em\", position: \"relative\" }}>\n      <i\n        className=\"fas fa-circle\"\n        style={{ left: \"50%\", opacity: 0.3, position: \"absolute\", top: 0 }}\n      />\n      <i\n        className=\"far fa-circle\"\n        style={{ left: \"50%\", position: \"absolute\", top: 0 }}\n      />\n    </div>\n  ),\n  filled: fasIcon(\"circle\"),\n\n  resetStyles: null,\n};\n\nexport default Icon;\n","import React from \"react\";\r\nimport ReactTooltip from \"react-tooltip\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\n\r\nconst OverlayButton = (props: {\r\n  action: Action;\r\n  callback: (action: Action) => Promise<void>;\r\n  className?: string;\r\n}): JSX.Element => {\r\n  return (\r\n    <>\r\n      <button\r\n        className={props.className || undefined}\r\n        data-tip\r\n        data-for={props.action}\r\n        onClick={() => props.callback(props.action)}\r\n      >\r\n        {Icon[props.action]}\r\n      </button>\r\n      <ReactTooltip\r\n        backgroundColor=\"#ddd\"\r\n        effect=\"solid\"\r\n        id={props.action}\r\n        place=\"right\"\r\n        textColor=\"#262626\"\r\n      >\r\n        {actionName(props.action)}\r\n      </ReactTooltip>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default OverlayButton;\r\n","import React, { useEffect, useState } from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport OverlayButton from \"./OverlayButton\";\n\nconst Pagination = (props: {\n  loadPage: (index: number) => Promise<void | number>;\n  currentPage: number;\n  totalPages: number;\n  doAction: (action: Action) => Promise<void>;\n  visibility: Visibility;\n}): JSX.Element => {\n  const [value, setValue] = useState(0);\n  const [width, setWidth] = useState(\"0.6em\");\n\n  useEffect(() => {\n    setValue(props.currentPage);\n    setWidth(`${0.6 * props.currentPage.toString().length}em`);\n  }, [props]);\n\n  const navigate = async () => {\n    if (!value) return;\n    const page = Number(value);\n    if (!page || page > props.totalPages) {\n      setValue(props.currentPage);\n    } else {\n      await props.loadPage(page - 1);\n    }\n  };\n\n  useEffect(() => void navigate(), [value]);\n\n  const onSubmit: (e) => Promise<void> = (e) => {\n    e?.preventDefault();\n    return navigate();\n  };\n\n  const onChange = (e) => setValue(e.target.value);\n\n  return (\n    <div className={`pagination visibility-${props.visibility}`}>\n      <OverlayButton\n        className={props.currentPage === 1 ? \"disabled\" : undefined}\n        action={Action.PreviousPage}\n        callback={props.doAction}\n      />\n      <form onSubmit={onSubmit}>\n        <input\n          onChange={onChange}\n          type=\"text\"\n          value={value}\n          style={{ width }}\n          tabIndex={-1}\n        />\n      </form>\n      <span className=\"total-pages\"> / {props.totalPages}</span>\n      {props.currentPage === props.totalPages ? (\n        <OverlayButton action={Action.AddPage} callback={props.doAction} />\n      ) : (\n        <OverlayButton action={Action.NextPage} callback={props.doAction} />\n      )}\n    </div>\n  );\n};\n\nexport default Pagination;\n","import React from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport OverlayButton from \"./OverlayButton\";\n\nconst UndoRedo = (props: {\n  canUndo: boolean;\n  canRedo: boolean;\n  doAction: (action: Action) => Promise<void>;\n  visibility: Visibility;\n}): JSX.Element => {\n  return (\n    <div className={`undoredo visibility-${props.visibility}`}>\n      <OverlayButton\n        action={Action.Undo}\n        callback={props.doAction}\n        className={props.canUndo ? undefined : \"disabled\"}\n      />\n      <OverlayButton\n        action={Action.Redo}\n        callback={props.doAction}\n        className={props.canRedo ? undefined : \"disabled\"}\n      />\n    </div>\n  );\n};\n\nexport default UndoRedo;\n","import React from \"react\";\r\n\r\nimport { Tool } from \"../lib/tools\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst Toolbar = (props: {\r\n  currentTool: Tool;\r\n  doAction: (action: Action) => Promise<void>;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  const tools = [\r\n    Action.Move,\r\n    Action.Pen,\r\n    Action.Eraser,\r\n    Action.Laser,\r\n    Action.Line,\r\n    Action.Rectangle,\r\n    Action.Ellipse,\r\n  ];\r\n\r\n  return (\r\n    <div className={`toolbar visibility-${props.visibility}`}>\r\n      {tools.map((tool, index) => (\r\n        <OverlayButton\r\n          action={tool}\r\n          callback={props.doAction}\r\n          className={index === props.currentTool ? \"active\" : undefined}\r\n          key={tool}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Toolbar;\r\n","import React, { ReactNode } from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport OverlayButton from \"./OverlayButton\";\n\nconst ButtonRow = (props: {\n  actions: Action[];\n  callback: (action: Action) => Promise<void>;\n  className?: (action: Action, i?: number) => null | string;\n  cName?: string;\n  outerButton?: boolean | ReactNode;\n}): JSX.Element => {\n  return (\n    <div\n      className={`button-row ${props.cName} ${\n        props.outerButton ? \"button-row-hover\" : \"\"\n      }`}\n    >\n      {props.outerButton}\n      <div className=\"button-row-inner\">\n        {props.actions.map((action, i) => (\n          <OverlayButton\n            action={action}\n            className={props.className?.(action, i)}\n            callback={props.callback}\n            key={action}\n          />\n        ))}\n      </div>\n    </div>\n  );\n};\n\nexport default ButtonRow;\n","import React from \"react\";\n\nimport { Dash, Fill, Stroke, Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport Icon from \"./Icon\";\nimport ButtonRow from \"./ButtonRow\";\n\nconst DashStyle = (props: {\n  dashStyle: Dash;\n  callback: (action: Action) => Promise<void>;\n  inContext: boolean;\n}) => {\n  const dashes = [Action.Solid, Action.Dashed, Action.Dotted];\n  const button = (\n    <button className=\"inactive\">{Icon[dashes[props.dashStyle]]}</button>\n  );\n\n  return (\n    <ButtonRow\n      actions={dashes}\n      className={(action, i) =>\n        props.inContext && props.dashStyle === i && \"active\"\n      }\n      callback={props.callback}\n      outerButton={!props.inContext && button}\n    />\n  );\n};\n\nconst StrokeStyle = (props: {\n  strokeStyle: string;\n  callback: (action: Action) => Promise<void>;\n  inContext: boolean;\n}): JSX.Element => {\n  const strokes = [\n    Action.Black,\n    Action.Blue,\n    Action.Green,\n    Action.Yellow,\n    Action.Orange,\n  ];\n  const strokeMap = [\n    Stroke.Black,\n    Stroke.Blue,\n    Stroke.Green,\n    Stroke.Yellow,\n    Stroke.Orange,\n  ];\n  const button = (\n    <button className=\"inactive\">\n      <i className=\"fas fa-circle\" style={{ color: props.strokeStyle }} />\n    </button>\n  );\n\n  return (\n    <ButtonRow\n      actions={strokes}\n      className={(action, i) =>\n        props.inContext && props.strokeStyle === strokeMap[i] && \"active\"\n      }\n      callback={props.callback}\n      outerButton={!props.inContext && button}\n    />\n  );\n};\n\nconst FillStyle = (props: {\n  fillStyle: Fill;\n  callback: (action: Action) => Promise<void>;\n  inContext: boolean;\n}): JSX.Element => {\n  const fills = [Action.Transparent, Action.Filled, Action.HalfFilled];\n  const button = (\n    <button className=\"inactive\">{Icon[fills[props.fillStyle]]}</button>\n  );\n\n  return (\n    <ButtonRow\n      actions={fills}\n      className={(action, i) =>\n        props.inContext && props.fillStyle === i && \"active\"\n      }\n      callback={props.callback}\n      outerButton={!props.inContext && button}\n    />\n  );\n};\n\nconst StyleMenu = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => Promise<void>;\n  inContext?: boolean;\n}): JSX.Element => {\n  return (\n    <>\n      <DashStyle\n        dashStyle={props.currentStyle ? props.currentStyle.dash : null}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n      <StrokeStyle\n        strokeStyle={props.currentStyle ? props.currentStyle.stroke : null}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n      <FillStyle\n        fillStyle={props.currentStyle ? props.currentStyle.fill : null}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n    </>\n  );\n};\n\nexport default StyleMenu;\n","import React, { useEffect, useRef, useState } from \"react\";\n\nimport { Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport ButtonRow from \"./ButtonRow\";\nimport Icon from \"./Icon\";\nimport StyleMenu from \"./StyleMenu\";\n\nconst Stylebar = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => Promise<void>;\n  acceptFile: (files: FileList) => Promise<void | void[]>;\n  visibility: Visibility;\n  isMobile: boolean;\n}): JSX.Element => {\n  const fileInputRef = useRef(null);\n  const fileButton = <button className=\"inactive\">{Icon.file}</button>;\n  const fileActions = [Action.Open, Action.Save, Action.Export];\n\n  const otherActions = [Action.Copy, Action.Paste];\n  const mobileActions = props.isMobile ? [Action.FullScreen] : [];\n\n  const [isFullscreen, setIsFullscreen] = useState(false);\n\n  useEffect(() => {\n    setIsFullscreen(Boolean(document.fullscreenElement));\n    document.addEventListener(\"fullscreenchange\", () =>\n      setIsFullscreen(Boolean(document.fullscreenElement))\n    );\n  }, []);\n\n  return (\n    <div className={`stylebar visibility-${props.visibility}`}>\n      <input\n        accept=\"\"\n        onChange={(e) => props.acceptFile(e.target.files)}\n        multiple={false}\n        ref={fileInputRef}\n        type=\"file\"\n      />\n      <ButtonRow\n        actions={fileActions}\n        callback={async (action) => {\n          if (action === Action.Open) {\n            fileInputRef.current.click();\n          } else {\n            await props.doAction(action);\n          }\n        }}\n        cName=\"file-actions\"\n        outerButton={fileButton}\n      />\n      <ButtonRow\n        actions={otherActions}\n        cName=\"other-actions vertical\"\n        callback={props.doAction}\n      />\n      <StyleMenu currentStyle={props.currentStyle} doAction={props.doAction} />\n      <ButtonRow\n        actions={mobileActions.map((action) =>\n          action === Action.FullScreen\n            ? !isFullscreen\n              ? Action.EnterFullScreen\n              : Action.ExitFullScreen\n            : action\n        )}\n        callback={props.doAction}\n        cName=\"mobile-actions vertical\"\n      />\n    </div>\n  );\n};\n\nexport default Stylebar;\n","import React from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action, actionName } from \"../lib/action\";\n\nimport Icon from \"./Icon\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst nonBinding: Action[] = [\n  Action.AddPage,\n  Action.EnterFullScreen,\n  Action.ExitFullScreen,\n];\n\nconst BindingModal = (props: {\n  letter: string;\n  action: Action | null;\n  close: () => void;\n  callback: (action: Action | null) => void;\n}): Modal => {\n  return (\n    <Modal\n      className=\"modal\"\n      overlayClassName=\"modal-overlay binding-modal\"\n      isOpen={props.letter !== \"\"}\n    >\n      <button className=\"close\" onClick={() => props.close()}>\n        {Icon.close}\n      </button>\n      <p>\n        Changing <span className=\"binding\">{props.letter}</span> binding…\n      </p>\n      <div className=\"tools\">\n        <button\n          className={props.action === undefined ? \"active\" : undefined}\n          onClick={() => props.callback(null)}\n        >\n          <span style={{ left: \"0.25em\" }}>none</span>\n        </button>\n        {Object.values(Action).map(\n          (action) =>\n            !nonBinding.includes(action) && (\n              <button\n                key={action}\n                className={props.action === action ? \"active\" : undefined}\n                onClick={() => props.callback(action)}\n              >\n                {Icon[action]}\n                <span style={Icon[action] ? {} : { left: \"0.25em\" }}>\n                  {actionName(action)}\n                </span>\n              </button>\n            )\n        )}\n      </div>\n    </Modal>\n  );\n};\n\nexport default BindingModal;\n","import React, { useState } from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action, actionName } from \"../lib/action\";\nimport { KeyMap, mirror } from \"../lib/keyboard\";\n\nimport Icon from \"./Icon\";\nimport BindingModal from \"./BindingModal\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst HeaderKey = (props: {\n  letter: string;\n  label?: string;\n  width: string;\n  leftHanded: boolean;\n}) => {\n  return (\n    <div className=\"key\" style={{ width: props.width }}>\n      <span className=\"letter\">\n        {props.leftHanded ? mirror(props.letter) : props.letter}\n      </span>\n      <div className=\"action\">\n        <span className=\"unassigned\">{props.label || \"\"}</span>\n      </div>\n    </div>\n  );\n};\n\nconst Key = (props: {\n  letter: string;\n  action?: Action;\n  callback: (key: string) => void;\n  leftHanded: boolean;\n}) => {\n  return (\n    <button className=\"key\" onClick={() => props.callback(props.letter)}>\n      <div className=\"action\">\n        {props.action && Icon[props.action]}\n        <span className={props.action ? undefined : \"unassigned\"}>\n          {actionName(props.action) || \"none\"}\n        </span>\n      </div>\n      <span className=\"letter\">\n        {props.leftHanded ? mirror(props.letter) : props.letter}\n      </span>\n    </button>\n  );\n};\n\nconst Bindings = (props: {\n  bind: (key: string, action: Action) => void;\n  unbind: (key: string) => void;\n  keyMap: KeyMap;\n  modifier: string;\n  leftHanded: boolean;\n}): JSX.Element => {\n  const [bindingModalKeys, setBindingModalKeys]: [\n    string,\n    React.Dispatch<React.SetStateAction<string>>\n  ] = useState<string>(\"\");\n  const [bindingModalAction, setBindingModalAction] = useState(undefined);\n\n  const rows = [\n    {\n      header: (\n        <HeaderKey\n          letter=\"tab\"\n          label=\"Hide Toolbar\"\n          width=\"4.5em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"qwert\".split(\"\"),\n    },\n    {\n      header: (\n        <HeaderKey\n          letter=\"esc\"\n          label=\"Deselect\"\n          width=\"6em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"asdfg\".split(\"\"),\n    },\n    {\n      header: (\n        <HeaderKey\n          letter=\"shift\"\n          label=\"Snap\"\n          width=\"7.5em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"zxcvb\".split(\"\"),\n    },\n  ];\n\n  const getModified = (letter: string): string =>\n    props.modifier === \"\" ? letter : `${props.modifier} + ${letter}`;\n\n  const keyHandler = (letter: string): void => {\n    setBindingModalKeys(getModified(letter));\n    setBindingModalAction(props.keyMap[getModified(letter)]);\n  };\n\n  return (\n    <>\n      <div className=\"bindings\">\n        {rows.map(({ header, letters }, index) => (\n          <div className={`row ${props.leftHanded ? \"left\" : \"\"}`} key={index}>\n            {!props.leftHanded && header}\n            {(props.leftHanded ? letters.reverse() : letters).map((letter) => (\n              <Key\n                key={letter}\n                letter={letter}\n                action={props.keyMap[getModified(letter)]}\n                callback={keyHandler}\n                leftHanded={props.leftHanded}\n              />\n            ))}\n            {props.leftHanded && header}\n          </div>\n        ))}\n      </div>\n      <BindingModal\n        letter={bindingModalKeys}\n        action={bindingModalAction}\n        close={() => setBindingModalKeys(\"\")}\n        callback={(action) => {\n          props.unbind(bindingModalKeys);\n          if (action) props.bind(bindingModalKeys, action);\n          setBindingModalKeys(\"\");\n        }}\n      />\n    </>\n  );\n};\n\nexport default Bindings;\n","import React, { useEffect, useState } from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action } from \"../lib/action\";\nimport { KeyMap } from \"../lib/keyboard\";\n\nimport Bindings from \"./Bindings\";\nimport Icon from \"./Icon\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst HelpModal = (props: {\n  bind: (key: string, action: Action) => void;\n  unbind: (key: string) => void;\n  reset: () => void;\n  keyMap: KeyMap;\n  isOpen: boolean;\n  toggleOpen: () => void;\n  isMobile: boolean;\n  toggleMobility: () => void;\n}): JSX.Element => {\n  const [keyModifier, setKeyModifier] = useState(\"\");\n  const [leftHanded, setLeftHanded] = useState(false);\n\n  const toggleHand = (): void => {\n    setLeftHanded((wasLeftHanded: boolean) => {\n      window.localStorage.setItem(\n        \"leftHanded\",\n        wasLeftHanded ? \"false\" : \"true\"\n      );\n\n      return !wasLeftHanded;\n    });\n  };\n\n  useEffect(() => {\n    if (window.localStorage.getItem(\"leftHanded\") === \"true\") {\n      setLeftHanded(true);\n    }\n  }, []);\n\n  return (\n    <Modal\n      className=\"modal\"\n      overlayClassName=\"modal-overlay help-modal\"\n      isOpen={props.isOpen}\n    >\n      <button className=\"close\" onClick={() => props.toggleOpen()}>\n        {Icon.close}\n      </button>\n      <p>\n        <span style={{ fontSize: \"1.5em\", fontWeight: \"bold\" }}>qboard</span>{\" \"}\n        <span style={{ color: \"#666\", marginLeft: \"0.2em\" }}>\n          The efficient digital whiteboard.\n        </span>\n      </p>\n      <p>\n        Press <b>{leftHanded ? \"0\" : \"1\"}</b> to show or hide this screen.\n      </p>\n      <p>\n        <button\n          className={keyModifier === \"\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"\")}\n        >\n          unmodified\n        </button>\n        <button\n          className={keyModifier === \"shift\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"shift\")}\n        >\n          with shift\n        </button>\n        <button\n          className={keyModifier === \"ctrl\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"ctrl\")}\n        >\n          with ctrl\n        </button>\n        <button onClick={() => toggleHand()}>\n          {leftHanded ? \"make right-handed\" : \"make left-handed\"}\n        </button>\n      </p>\n      <Bindings\n        bind={props.bind}\n        unbind={props.unbind}\n        keyMap={props.keyMap}\n        modifier={keyModifier}\n        leftHanded={leftHanded}\n      />\n      <p>\n        Click a key to change the binding.{\" \"}\n        <button onClick={() => props.reset()}>reset to default</button>\n      </p>\n      <p style={{ color: \"#666\" }}>\n        By <a href=\"https://cjquines.com/\">CJ Quines</a>. View on{\" \"}\n        <a href=\"https://github.com/cjquines/qboard\">Github</a>. Use{\" \"}\n        <a onClick={() => props.toggleMobility()} tabIndex={0}>\n          {props.isMobile ? \"desktop\" : \"mobile\"} site\n        </a>\n        .\n      </p>\n    </Modal>\n  );\n};\n\nexport default HelpModal;\n","import React, { useEffect, useState } from \"react\";\n\nimport { Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport StyleMenu from \"./StyleMenu\";\n\nconst ContextMenu = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => Promise<void>;\n}): JSX.Element => {\n  const [coords, setCoords] = useState<[number, number] | null>(null);\n\n  useEffect(() => {\n    document.addEventListener(\"contextmenu\", (e: MouseEvent) => {\n      e.preventDefault();\n      setCoords((oldCoords) => (oldCoords ? null : [e.clientX, e.clientY]));\n    });\n    document.addEventListener(\"click\", () => setCoords(null));\n  }, []);\n\n  return coords ? (\n    <div\n      className=\"context-menu\"\n      style={{\n        top: `calc(${coords[1]}px - 2.8em)`,\n        left: `calc(${coords[0]}px - 1.1em)`,\n      }}\n    >\n      <StyleMenu\n        currentStyle={props.currentStyle}\n        doAction={(action: Action) => props.doAction(action)}\n        inContext={true}\n      />\n    </div>\n  ) : null;\n};\n\nexport default ContextMenu;\n","import React, { useEffect, useState } from \"react\";\r\nimport keyboardJS from \"keyboardjs\";\r\n\r\nimport QBoard, { QBoardState } from \"../lib/qboard\";\r\nimport { Tool } from \"../lib/tools\";\r\nimport { Dash, Fill, Stroke } from \"../lib/styles\";\r\nimport { defaultKeys } from \"../lib/keyboard\";\r\n\r\nimport Pagination from \"./Pagination\";\r\nimport UndoRedo from \"./UndoRedo\";\r\nimport Toolbar from \"./Toolbar\";\r\nimport Stylebar from \"./Stylebar\";\r\nimport HelpModal from \"./HelpModal\";\r\nimport ContextMenu from \"./ContextMenu\";\r\n\r\nexport const enum Visibility {\r\n  None,\r\n  Condensed,\r\n  Full,\r\n}\r\n\r\nconst Overlay = (props: { qboard: QBoard }): JSX.Element => {\r\n  const { qboard } = props;\r\n\r\n  const [visibility, setVisibility] = useState<Visibility>(Visibility.Full);\r\n  const [helpModalOpen, setHelpModalOpen] = useState<boolean>(false);\r\n  const [isMobile, setMobility] = useState<boolean>(false);\r\n\r\n  const [state, setState]: [\r\n    QBoardState,\r\n    React.Dispatch<React.SetStateAction<QBoardState>>\r\n  ] = useState<QBoardState>({\r\n    dragActive: false,\r\n    currentPage: 0,\r\n    totalPages: 0,\r\n    currentTool: Tool.Move,\r\n    currentStyle: {\r\n      dash: Dash.Solid,\r\n      stroke: Stroke.Black,\r\n      fill: Fill.Transparent,\r\n    },\r\n    canUndo: false,\r\n    canRedo: false,\r\n    keyMap: defaultKeys,\r\n  });\r\n\r\n  const toggleOpen = (): void => {\r\n    setHelpModalOpen((wasOpen) => {\r\n      window.localStorage.setItem(\"helpModalOpen\", wasOpen ? \"false\" : \"true\");\r\n      return !wasOpen;\r\n    });\r\n  };\r\n\r\n  const toggleMobility = (): void => {\r\n    setMobility((wasMobile) => {\r\n      window.localStorage.setItem(\"isMobile\", wasMobile ? \"false\" : \"true\");\r\n      return !wasMobile;\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (window.localStorage.getItem(\"helpModalOpen\") !== \"false\") {\r\n      setHelpModalOpen(true);\r\n    }\r\n    if (window.localStorage.getItem(\"isMobile\") !== \"false\") {\r\n      setMobility(true);\r\n    }\r\n\r\n    qboard.callback = setState;\r\n    qboard.updateState();\r\n\r\n    keyboardJS.bind(\"tab\", () => {\r\n      setVisibility((currentVisibility) => (currentVisibility + 2) % 3);\r\n    });\r\n\r\n    keyboardJS.bind(\"1\", () => toggleOpen());\r\n    keyboardJS.bind(\"0\", () => toggleOpen());\r\n  }, []);\r\n\r\n  return (\r\n    <>\r\n      <div className={`drop-area ${state.dragActive ? \"active\" : \"\"}`} />\r\n      <div className={`overlay visibility-${visibility}`}>\r\n        <Pagination\r\n          loadPage={qboard.pages.loadPage}\r\n          currentPage={state.currentPage}\r\n          totalPages={state.totalPages}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <UndoRedo\r\n          canUndo={state.canUndo}\r\n          canRedo={state.canRedo}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <Toolbar\r\n          currentTool={state.currentTool}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <Stylebar\r\n          currentStyle={state.currentStyle}\r\n          doAction={qboard.action.doAction}\r\n          acceptFile={async (file) =>\r\n            qboard.history.execute(\r\n              (await qboard.files.acceptFile(file)).history\r\n            )\r\n          }\r\n          visibility={visibility}\r\n          isMobile={isMobile}\r\n        />\r\n        <HelpModal\r\n          bind={qboard.keyboard.bind}\r\n          unbind={qboard.keyboard.unbind}\r\n          reset={qboard.keyboard.reset}\r\n          keyMap={state.keyMap}\r\n          isOpen={helpModalOpen}\r\n          toggleOpen={toggleOpen}\r\n          isMobile={isMobile}\r\n          toggleMobility={toggleMobility}\r\n        />\r\n      </div>\r\n      <ContextMenu\r\n        currentStyle={state.currentStyle}\r\n        doAction={qboard.action.doAction}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default Overlay;\r\n","import { fabric } from \"fabric\";\r\n\r\n// projects the point x2, y2 to the vector with origin ox, oy and direction vx, vy. returns the square distance and the coordinates of the projection.\r\nconst project = (\r\n  ox: number,\r\n  oy: number,\r\n  vx: number,\r\n  vy: number,\r\n  x2: number,\r\n  y2: number\r\n): number[] => {\r\n  const x = x2 - ox;\r\n  const y = y2 - oy;\r\n  const side = vx * y - vy * x;\r\n  const sq = vx * vx + vy * vy;\r\n  return [\r\n    Math.abs(side) / sq,\r\n    ox + x + (vy * side) / sq,\r\n    oy + y - (vx * side) / sq,\r\n  ];\r\n};\r\n\r\n// given the origin x, y, snaps the point x2, y2 to the nearest vector in dirs\r\nconst rectify = (\r\n  dirs: number[][],\r\n  x: number,\r\n  y: number,\r\n  x2: number,\r\n  y2: number\r\n): number[] => {\r\n  return dirs\r\n    .map((d) => project(x, y, d[0], d[1], x2, y2))\r\n    .reduce((acc, cur) => (acc[0] < cur[0] ? acc : cur));\r\n};\r\n\r\nexport const enum Tool {\r\n  Move,\r\n  Pen,\r\n  Eraser,\r\n  Laser,\r\n  Line,\r\n  Rectangle,\r\n  Ellipse,\r\n}\r\n\r\nexport default interface ToolHandler {\r\n  tool: Tool;\r\n  isBrush: boolean;\r\n\r\n  draw?: (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ) => Promise<fabric.Object>;\r\n\r\n  resize?: (\r\n    object: fabric.Object,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ) => Promise<fabric.Object>;\r\n\r\n  setBrush?: (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ) => Promise<void>;\r\n}\r\n\r\nexport class MoveHandler implements ToolHandler {\r\n  tool: Tool = Tool.Move;\r\n  isBrush = false;\r\n}\r\n\r\nexport class PenHandler implements ToolHandler {\r\n  tool: Tool = Tool.Pen;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = options.stroke;\r\n    brush.strokeDashArray = options.strokeDashArray;\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class EraserHandler implements ToolHandler {\r\n  tool: Tool = Tool.Eraser;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = \"#ff005455\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = 5 * options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class LaserHandler implements ToolHandler {\r\n  tool: Tool = Tool.Laser;\r\n  isBrush = true;\r\n\r\n  setBrush = async (\r\n    brush: fabric.BaseBrush,\r\n    options: fabric.IObjectOptions\r\n  ): Promise<void> => {\r\n    brush.color = \"#f23523\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class LineHandler implements ToolHandler {\r\n  tool: Tool = Tool.Line;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 0],\r\n    [1, 1],\r\n    [0, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Line> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Line>((resolve) => {\r\n      resolve(\r\n        new fabric.Line([x, y, x2, y2], {\r\n          ...options,\r\n          perPixelTargetFind: true,\r\n        })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Line,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Line> => {\r\n    let [x, y] = [x2, y2];\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object.set({ x2: x, y2: y }).setCoords();\r\n    return new Promise<fabric.Line>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport class RectangleHandler implements ToolHandler {\r\n  tool: Tool = Tool.Rectangle;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Rect> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Rect>((resolve) => {\r\n      resolve(\r\n        new fabric.Rect({ left: x, top: y, width: x2, height: y2, ...options })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Rect,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Rect> => {\r\n    let [x, y] = [x2, y2];\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        width: Math.abs(this.x - x),\r\n        height: Math.abs(this.y - y),\r\n      })\r\n      .setCoords();\r\n\r\n    return new Promise<fabric.Rect>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport class EllipseHandler implements ToolHandler {\r\n  tool: Tool = Tool.Ellipse;\r\n  isBrush = false;\r\n  x: number;\r\n  y: number;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = async (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): Promise<fabric.Ellipse> => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new Promise<fabric.Ellipse>((resolve) => {\r\n      resolve(\r\n        new fabric.Ellipse({ left: x, top: y, rx: x2, ry: y2, ...options })\r\n      );\r\n    });\r\n  };\r\n\r\n  resize = async (\r\n    object: fabric.Ellipse,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): Promise<fabric.Ellipse> => {\r\n    let [x, y] = [x2, y2];\r\n\r\n    if (strict) {\r\n      [, x, y] = rectify(this.dirs, this.x, this.y, x2, y2);\r\n    }\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        rx: Math.abs(x - object.left) / 2,\r\n        ry: Math.abs(y - object.top) / 2,\r\n      })\r\n      .setCoords();\r\n\r\n    return new Promise<fabric.Ellipse>((resolve) => {\r\n      resolve(object);\r\n    });\r\n  };\r\n}\r\n\r\nexport const Handlers = [\r\n  new MoveHandler(),\r\n  new PenHandler(),\r\n  new EraserHandler(),\r\n  new LaserHandler(),\r\n  new LineHandler(),\r\n  new RectangleHandler(),\r\n  new EllipseHandler(),\r\n];\r\n","import { fabric } from \"fabric\";\n\nexport interface ObjectId extends fabric.Object {\n  id: number;\n}\n\nexport type Cursor = { x: number; y: number };\n\nexport default class Page extends fabric.Canvas {\n  cursor: Cursor;\n  canvasWidth: number;\n  canvasHeight: number;\n  latestId = 0;\n  modified = false;\n\n  fitToWindow = async (\n    canvasWidth: number,\n    canvasHeight: number\n  ): Promise<void> => {\n    const widthRatio = window.innerWidth / canvasWidth;\n    const heightRatio = window.innerHeight / canvasHeight;\n    this.setZoom(Math.min(widthRatio, heightRatio));\n    this.setWidth(canvasWidth * this.getZoom());\n    this.setHeight(canvasHeight * this.getZoom());\n    this.canvasWidth = canvasWidth;\n    this.canvasHeight = canvasHeight;\n  };\n\n  deactivateSelection = async (): Promise<void> => {\n    this.isDrawingMode = false;\n    this.selection = false;\n    this.discardActiveObject();\n    this.forEachObject((object) => {\n      object.selectable = false;\n    });\n    this.requestRenderAll();\n  };\n\n  activateSelection = async (): Promise<void> => {\n    this.isDrawingMode = false;\n    this.selection = true;\n    this.forEachObject((object) => {\n      object.selectable = true;\n    });\n  };\n\n  getNextId = async (): Promise<number> => {\n    this.latestId += 1;\n    return this.latestId;\n  };\n\n  getObjectByIds = (ids: number[]): fabric.Object[] => {\n    // multiple element case; kind of inefficient\n    if (ids.length > 1) {\n      return this.getObjects().filter((object: ObjectId) =>\n        ids.includes(object.id)\n      );\n    }\n    // single element case\n    const [id] = ids;\n    for (const object of this.getObjects()) {\n      if ((object as ObjectId).id === id) {\n        return [object];\n      }\n    }\n    return [];\n  };\n\n  serialize = async (objects: fabric.Object[]): Promise<fabric.Object[]> => {\n    return objects.map((object) => object.toObject([\"strokeUniform\"]));\n  };\n\n  apply = (ids: number[], newObjects: fabric.Object[] | null): void => {\n    const oldObjects = this.getObjectByIds(ids);\n    if (oldObjects.length) {\n      this.remove(...oldObjects);\n    }\n    if (newObjects?.length) {\n      const addObjects = (objects) => {\n        objects.forEach((object: ObjectId, i) => {\n          object.id = ids[i];\n        });\n        this.add(...objects);\n        this.requestRenderAll();\n      };\n      fabric.util.enlivenObjects(newObjects, addObjects, \"fabric\");\n    } else {\n      this.requestRenderAll();\n    }\n  };\n\n  loadFromJSONAsync = async (json: unknown): Promise<void> =>\n    new Promise<void>((resolve) => {\n      super.loadFromJSON(json, () => {\n        resolve();\n      });\n    });\n\n  placeObject = async (\n    obj: any,\n    cursor: Cursor = this.cursor\n  ): Promise<fabric.Object[]> => {\n    const { x = this.canvasWidth / 2, y = this.canvasHeight / 2 } =\n      cursor || {};\n    this.discardActiveObject();\n    const id = await this.getNextId();\n\n    obj.set({\n      id,\n      left: x,\n      top: y,\n      originX: \"center\",\n      originY: \"center\",\n    } as Partial<fabric.ActiveSelection>);\n    if (obj._objects) {\n      obj.canvas = this;\n      obj.forEachObject((object) =>\n        this.getNextId().then((id_) => {\n          (object as ObjectId).id = id_;\n          this.add(object);\n        })\n      );\n      obj.setCoords();\n    } else {\n      this.add(obj);\n    }\n    this.setActiveObject(obj);\n    this.requestRenderAll();\n    return obj._objects || [obj];\n  };\n}\n","import { fabric } from \"fabric\";\n\nimport { HistoryCommand } from \"./history\";\nimport Pages, { PageJSON } from \"./pages\";\nimport { Cursor } from \"./page\";\n\nexport class AsyncReader {\n  static readAsText = (file: File): Promise<string | ArrayBuffer> =>\n    new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => {\n        resolve(reader.result);\n      };\n      reader.onerror = reject;\n      reader.readAsText(file);\n    });\n\n  static readAsDataURL = (file: File): Promise<string | ArrayBuffer> =>\n    new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => {\n        resolve(reader.result);\n      };\n      reader.onerror = reject;\n      reader.readAsDataURL(file);\n    });\n}\n\n// manages version compatibility with old document formats\n// change the signature and usages to accommodate new data; this will fill in sample data for missing fields\nexport class JSONReader {\n  static read(json: string | ArrayBuffer): PageJSON[] {\n    const object = JSON.parse(json.toString());\n    return JSONReader.readParsed(object);\n  }\n\n  static readParsed(object): PageJSON[] {\n    const { \"qboard-version\": version, pages } = object;\n    switch (version) {\n      case 1:\n        return pages;\n      default:\n        return pages;\n    }\n  }\n}\n\nexport class JSONWriter {\n  private readonly sourceJSON: {\n    \"qboard-version\": number;\n    pages: PageJSON[];\n  };\n  private stringified: string;\n\n  constructor(pagesJSON: PageJSON[]) {\n    this.sourceJSON = {\n      \"qboard-version\": 1,\n      pages: pagesJSON,\n    };\n  }\n\n  toString = (): string => {\n    if (this.stringified !== undefined) return this.stringified;\n    this.stringified = JSON.stringify(this.sourceJSON);\n    return this.stringified;\n  };\n\n  toBlob = (): Blob =>\n    new Blob([this.toString()], { type: \"application/json\" });\n\n  toURL = (): [string, () => void] => {\n    const url = window.URL.createObjectURL(this.toBlob());\n    const revoke = () => window.URL.revokeObjectURL(url);\n    return [url, revoke];\n  };\n}\n\nexport type FileHandlerResponse = {\n  action: \"none\" | \"image\" | \"json\";\n  history?: HistoryCommand;\n};\n\nexport default class FileHandler {\n  constructor(public pages: Pages) {}\n\n  processFiles = async (\n    files: FileList,\n    cursor?: Cursor\n  ): Promise<HistoryCommand> => {\n    const images = [];\n    await Promise.all(\n      [...files].map(async (file) => {\n        if (file.type.startsWith(\"image/\")) {\n          images.push(await this.handleImage(file, cursor));\n        }\n        if (file.type === \"application/json\") {\n          return this.handleJSON(file);\n        }\n      })\n    );\n    return {\n      add: images.flat(),\n    };\n  };\n\n  acceptFile = async (\n    files: FileList,\n    cursor?: Cursor\n  ): Promise<FileHandlerResponse> => {\n    if (!files.length) return { action: \"none\" };\n    const [file] = files;\n\n    if (file.type.startsWith(\"image/\")) {\n      return {\n        action: \"image\",\n        history: { add: await this.handleImage(file, cursor) },\n      };\n    }\n\n    if (file.type === \"application/json\") {\n      await this.openFile(file);\n      return {\n        action: \"json\",\n        history: { clear: [true] },\n      };\n    }\n\n    // unsupported file\n    return { action: \"none\" };\n  };\n\n  openFile = async (file: File): Promise<boolean> => {\n    this.pages.savePage();\n    return this.pages.overwritePages(\n      JSONReader.read(await AsyncReader.readAsText(file))\n    );\n  };\n\n  private handleImage = async (\n    file: File,\n    cursor?: Cursor\n  ): Promise<fabric.Object[]> =>\n    new Promise<fabric.Object[]>((resolve) =>\n      AsyncReader.readAsDataURL(file).then((result) =>\n        fabric.Image.fromURL(result.toString(), (obj: fabric.Image) => {\n          resolve(this.pages.canvas.placeObject(obj, cursor));\n        })\n      )\n    );\n\n  private handleJSON = async (file: File): Promise<number> => {\n    const pages = JSONReader.read(await AsyncReader.readAsText(file));\n    return this.pages.insertPages(this.pages.currentIndex + 1, pages);\n  };\n}\n","import pdfMake from \"pdfmake/build/pdfmake.min\";\nimport { fabric } from \"fabric\";\n\nimport Page from \"./page\";\nimport { JSONWriter } from \"./files\";\n\nexport type PageJSON = {\n  version: string;\n  objects: fabric.Object[];\n  background: string;\n};\n\nconst defaultPageJSON: PageJSON = {\n  version: \"4.2.0\",\n  objects: [],\n  background: \"white\",\n};\n\nconst timeString = (): string => {\n  const offset = new Date().getTimezoneOffset() * 60000;\n  return new Date(Date.now() - offset)\n    .toISOString()\n    .slice(0, -8)\n    .replace(/\\D/g, \"-\");\n};\n\nexport default class Pages {\n  currentIndex = 0;\n\n  constructor(\n    public canvas: Page,\n    public canvasWidth: number,\n    public canvasHeight: number,\n    public updateState: () => void,\n    public pagesJSON: PageJSON[] = [defaultPageJSON]\n  ) {}\n\n  savePage = (): void => {\n    this.pagesJSON[this.currentIndex] = this.canvas.toObject([\n      \"id\",\n      \"strokeUniform\",\n    ]);\n  };\n\n  loadPage = async (\n    index: number,\n    fromFile = false,\n    force = false\n  ): Promise<number> => {\n    if (index === this.currentIndex && !force) return index;\n    if (!fromFile) this.savePage();\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[index]);\n    this.currentIndex = index;\n    if (!fromFile || force) this.updateState();\n    return index;\n  };\n\n  newPage = async (fromFile = false): Promise<number> => {\n    this.pagesJSON.splice(this.currentIndex + 1, 0, defaultPageJSON);\n    return this.loadPage(this.currentIndex + 1, fromFile);\n  };\n\n  previousPage = async (): Promise<number> => {\n    if (this.currentIndex === 0) return 0;\n    return this.loadPage(this.currentIndex - 1);\n  };\n\n  nextOrNewPage = async (fromFile = false): Promise<number> => {\n    if (this.currentIndex === this.pagesJSON.length - 1) {\n      return this.newPage(fromFile);\n    }\n    return this.loadPage(this.currentIndex + 1, fromFile);\n  };\n\n  export = async (): Promise<void> => {\n    this.savePage();\n    const ratio = 2;\n    const content = [];\n    const currentIndexCopy = this.currentIndex;\n    for (const page of this.pagesJSON) {\n      await this.canvas.loadFromJSONAsync(page);\n      content.push({\n        svg: this.canvas.toSVG(),\n        width: this.canvasWidth / ratio,\n      });\n    }\n\n    const docDefinition = {\n      pageSize: {\n        width: this.canvasWidth / ratio,\n        height: this.canvasHeight / ratio,\n      },\n      pageMargins: [0, 0],\n      content,\n    };\n\n    pdfMake.createPdf(docDefinition).download(`qboard-${timeString()}.pdf`);\n\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[currentIndexCopy]);\n  };\n\n  saveFile = (): void => {\n    this.savePage();\n    const [fileURL, revokeURL] = new JSONWriter(this.pagesJSON).toURL();\n\n    const elt = document.createElement(\"a\");\n    elt.style.display = \"none\";\n    elt.href = fileURL;\n    elt.download = `qboard-${timeString()}.json`;\n    document.body.appendChild(elt);\n    elt.click();\n    elt.parentElement.removeChild(elt);\n\n    revokeURL();\n    this.canvas.modified = false;\n  };\n\n  overwritePages = async (\n    pages: PageJSON[] = [defaultPageJSON]\n  ): Promise<boolean> => {\n    const response =\n      !this.canvas.modified ||\n      this.pagesJSON.every((page) => page.objects.length === 0) ||\n      window.confirm(\n        \"Your work will be overwritten. Are you sure you wish to continue?\"\n      );\n    if (!response) return false;\n\n    this.pagesJSON = pages;\n    await this.loadPage(0, true, true);\n    this.canvas.modified = false;\n    return true;\n  };\n\n  insertPages = async (index: number, pages: PageJSON[]): Promise<number> => {\n    this.pagesJSON.splice(index, 0, ...pages);\n    this.canvas.modified = true;\n    return this.loadPage(index);\n  };\n}\n","import { fabric } from \"fabric\";\n\nimport Page, { ObjectId } from \"./page\";\nimport Pages from \"./pages\";\n\ninterface HistoryItem {\n  ids: number[];\n  oldObjects: fabric.Object[] | null;\n  newObjects: fabric.Object[] | null;\n  page: number;\n}\n\nexport type HistoryCommand = {\n  add?: fabric.Object[];\n  remove?: fabric.Object[];\n  clear?: [boolean];\n};\n\nexport default class HistoryHandler {\n  history: HistoryItem[] = [];\n  redoStack: HistoryItem[] = [];\n  selection: fabric.Object[];\n  locked = false;\n\n  constructor(\n    public canvas: Page,\n    public pages: Pages,\n    public updateState: () => void\n  ) {}\n\n  execute = async (command: HistoryCommand = {}): Promise<void[]> => {\n    if (command.clear) this.clear(command.clear[0]);\n    const actions: Promise<void>[] = [\n      this.add(command.add),\n      this.remove(command.remove),\n    ];\n    return Promise.all(actions);\n  };\n\n  add = async (objects: fabric.Object[]): Promise<void> =>\n    objects?.length && this.save(null, objects);\n\n  remove = async (objects: fabric.Object[]): Promise<void> =>\n    objects?.length && this.save(objects, null);\n\n  clear = (clearRedo = false): void => {\n    this.history = [];\n    if (clearRedo) this.redoStack = [];\n    this.updateState();\n  };\n\n  store = async (objects: fabric.Object[]): Promise<void> => {\n    if (this.locked) return;\n    this.selection = await this.canvas.serialize(objects);\n  };\n\n  modify = async (objects: fabric.Object[]): Promise<void> =>\n    this.save(this.selection, objects);\n\n  save = async (\n    oldObjects: fabric.Object[] | null,\n    newObjects: fabric.Object[] | null\n  ): Promise<void> => {\n    if (this.locked) return;\n    const basis = newObjects || oldObjects;\n    this.history.push({\n      ids: basis.map((object: ObjectId) => object.id),\n      oldObjects: newObjects\n        ? oldObjects\n        : await this.canvas.serialize(oldObjects),\n      newObjects: newObjects && (await this.canvas.serialize(newObjects)),\n      page: this.pages.currentIndex,\n    });\n    this.redoStack = [];\n    this.canvas.modified = true;\n    this.updateState();\n  };\n\n  undo = async (): Promise<void> => {\n    if (!this.history.length) return;\n    this.canvas.discardActiveObject();\n    await this.move(this.history, this.redoStack, true);\n  };\n\n  redo = async (): Promise<void> => {\n    if (!this.redoStack.length) return;\n    await this.move(this.redoStack, this.history, false);\n  };\n\n  private move = async (\n    from: HistoryItem[],\n    to: HistoryItem[],\n    isUndo: boolean\n  ): Promise<void> => {\n    this.locked = true;\n    const last = from.pop();\n    await this.pages.loadPage(last.page);\n    this.canvas.apply(last.ids, isUndo ? last.oldObjects : last.newObjects);\n    to.push(last);\n    this.locked = false;\n    this.canvas.modified = true;\n    this.updateState();\n  };\n}\n","import { fabric } from \"fabric\";\n\nimport Page from \"./page\";\nimport Pages from \"./pages\";\nimport FileHandler from \"./files\";\nimport HistoryHandler from \"./history\";\n\nexport default class ClipboardHandler {\n  clipboard: fabric.Object;\n\n  constructor(\n    public canvas: Page,\n    public pages: Pages,\n    public files: FileHandler,\n    public history: HistoryHandler,\n    public canvasWidth: number,\n    public canvasHeight: number\n  ) {\n    window.addEventListener(\"paste\", this.pasteExternal);\n  }\n\n  copy = async (): Promise<fabric.Object> => {\n    const objects: fabric.Object = this.canvas.getActiveObject();\n    if (!objects) return null;\n    objects.clone((clone) => {\n      this.clipboard = clone;\n    });\n    return objects;\n  };\n\n  cut = async (): Promise<boolean> => {\n    const objects = (await this.copy()) as fabric.ActiveSelection;\n    if (!objects) return false;\n    this.canvas.discardActiveObject();\n    if (objects.type === \"activeSelection\") {\n      objects.forEachObject((object) => {\n        this.canvas.remove(object);\n      });\n      await this.history.remove(objects._objects);\n    } else {\n      this.canvas.remove(objects);\n      await this.history.remove([objects]);\n    }\n    this.canvas.requestRenderAll();\n    return true;\n  };\n\n  paste = async (): Promise<void> => {\n    if (!this.clipboard) return;\n    return this.clipboard.clone((clone) =>\n      this.canvas.placeObject(clone).then(this.history.add)\n    );\n  };\n\n  pasteExternal = async (e: ClipboardEvent): Promise<void> => {\n    const historyCommand = await this.files.processFiles(e.clipboardData.files);\n    await this.history.execute(historyCommand);\n    await this.paste();\n  };\n}\n","import { fabric } from \"fabric\";\n\nexport const enum Dash {\n  Solid,\n  Dashed,\n  Dotted,\n}\n\nexport const enum Stroke {\n  Black = \"#000000\",\n  Blue = \"#0097f6\",\n  Green = \"#00b253\",\n  Yellow = \"#ffbf00\",\n  Orange = \"#ff2600\",\n}\n\nexport const enum Fill {\n  Transparent,\n  Solid,\n  HalfSolid,\n}\n\nexport interface Style {\n  dash: Dash;\n  stroke: Stroke;\n  fill: Fill;\n}\n\nconst dashMap = [\n  [0, 0],\n  [20, 15],\n  [5, 10],\n];\n\nexport default class StyleHandler {\n  constructor(\n    public currentStyle: Style,\n    public drawerOptions: fabric.IObjectOptions,\n    public freeDrawingBrush: fabric.BaseBrush,\n    public updateState: () => void\n  ) {}\n\n  set = (dash: Dash | null, stroke: Stroke | null, fill: Fill | null): void => {\n    if (dash !== null) {\n      this.currentStyle.dash = dash;\n      this.drawerOptions.strokeDashArray = dashMap[dash];\n      this.freeDrawingBrush.strokeDashArray = dashMap[dash];\n    }\n\n    if (stroke !== null) {\n      this.currentStyle.stroke = stroke;\n      this.drawerOptions.stroke = stroke;\n      this.freeDrawingBrush.color = stroke;\n    }\n\n    if (fill !== null) {\n      this.currentStyle.fill = fill;\n    }\n\n    if (stroke !== null || fill !== null) {\n      switch (this.currentStyle.fill) {\n        case Fill.Transparent: {\n          this.drawerOptions.fill = \"transparent\";\n          break;\n        }\n        case Fill.Solid: {\n          this.drawerOptions.fill = this.currentStyle.stroke;\n          break;\n        }\n        case Fill.HalfSolid: {\n          this.drawerOptions.fill = `${this.currentStyle.stroke}11`;\n          break;\n        }\n      }\n    }\n\n    this.updateState();\n  };\n}\n","export default class CustomError extends Error {\n  constructor(message: string) {\n    super(message);\n    this.name = this.constructor.name;\n  }\n}\n","import CustomError from \"./error\";\n\ntype Predicate<T> = (T) => boolean;\n\nexport class HTTPError extends CustomError {\n  constructor(public code: number = 400, message = \"HTTP Error\") {\n    super(message);\n  }\n}\n\nexport class ResourceNotFoundException extends HTTPError {\n  constructor(public code: number = 404, message = \"Resource not found\") {\n    super(code, message);\n  }\n}\n\nexport default class Network {\n  static async loadJSON(filePath): Promise<any> {\n    const xhr = await Network.fetch(filePath, (xhr) => {\n      xhr.overrideMimeType(\"application/json\");\n      xhr.responseType = \"json\";\n    });\n    return xhr.response;\n  }\n\n  static async fetch(\n    url,\n    prerequest: (xhr: XMLHttpRequest) => void = () => {},\n    method = \"GET\",\n    body = null,\n    resolveCondition: Predicate<number> = (status) =>\n      status >= 200 && status < 300\n  ): Promise<XMLHttpRequest> {\n    const xhr = new XMLHttpRequest();\n    xhr.open(method, url, true);\n    prerequest(xhr);\n    xhr.send(body);\n\n    return new Promise((resolve, reject) => {\n      xhr.onreadystatechange = function () {\n        if (xhr.readyState === 4) {\n          if (resolveCondition(xhr.status)) resolve(xhr);\n          else\n            reject(new ResourceNotFoundException(xhr.status, xhr.statusText));\n        }\n      };\n    });\n  }\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\n\nimport Overlay from \"./components/Overlay\";\nimport QBoard from \"./lib/qboard\";\n\nimport \"./main.scss\";\n\nconst qboard = new QBoard(\n  document.querySelector(\"#QBoard\"),\n  document.querySelector(\"#BaseQBoard\"),\n  1600,\n  900\n);\n\nReactDOM.render(\n  <Overlay qboard={qboard} />,\n  document.querySelector(\"#Overlay\")\n);\n","import { fabric } from \"fabric\";\n\nimport ToolHandler, { Handlers, Tool } from \"./tools\";\nimport Page, { ObjectId } from \"./page\";\nimport Pages from \"./pages\";\nimport FileHandler, { JSONReader } from \"./files\";\nimport HistoryHandler from \"./history\";\nimport ClipboardHandler from \"./clipboard\";\nimport StyleHandler, { Dash, Fill, Stroke, Style } from \"./styles\";\nimport ActionHandler from \"./action\";\nimport KeyboardHandler, { KeyMap } from \"./keyboard\";\nimport Network from \"./network\";\n\nexport interface QBoardState {\n  dragActive: boolean;\n  currentPage: number;\n  totalPages: number;\n  currentTool: Tool;\n  currentStyle: Style;\n  canUndo: boolean;\n  canRedo: boolean;\n  keyMap: KeyMap;\n}\n\nexport default class QBoard {\n  baseCanvas: Page;\n  canvas: Page;\n  pages: Pages;\n  files: FileHandler;\n  history: HistoryHandler;\n  clipboard: ClipboardHandler;\n  style: StyleHandler;\n  action: ActionHandler;\n  keyboard: KeyboardHandler;\n\n  handlers: ToolHandler[] = Handlers;\n  currentStyle: Style = {\n    dash: Dash.Solid,\n    stroke: Stroke.Black,\n    fill: Fill.Transparent,\n  };\n  drawerOptions: fabric.IObjectOptions = {\n    fill: \"transparent\",\n    stroke: \"#000000\",\n    strokeWidth: 4,\n    selectable: false,\n    strokeDashArray: [0, 0],\n    strokeUniform: true,\n  };\n\n  resizeCooldown: NodeJS.Timeout;\n  currentTool: Tool;\n  tool: ToolHandler;\n  currentObject: fabric.Object;\n  dragActive = false;\n  isDown = false;\n  strict = false;\n  callback: (state: QBoardState) => void;\n\n  constructor(\n    public canvasElement: HTMLCanvasElement,\n    public baseCanvasElement: HTMLCanvasElement,\n    public canvasWidth: number,\n    public canvasHeight: number\n  ) {\n    const queryParams = new URLSearchParams(window.location.search);\n\n    this.baseCanvas = new Page(baseCanvasElement, {\n      backgroundColor: \"white\",\n      renderOnAddRemove: false,\n      selection: false,\n      targetFindTolerance: 15,\n    });\n    this.canvas = new Page(canvasElement, {\n      renderOnAddRemove: false,\n      selection: false,\n    });\n    this.pages = new Pages(\n      this.baseCanvas,\n      this.canvasWidth,\n      this.canvasHeight,\n      this.updateState\n    );\n\n    if (queryParams.get(\"json\") !== null)\n      Network.loadJSON(queryParams.get(\"json\"))\n        .then(JSONReader.readParsed)\n        .then(this.pages.overwritePages)\n        .catch(console.error);\n\n    this.files = new FileHandler(this.pages);\n    this.history = new HistoryHandler(\n      this.baseCanvas,\n      this.pages,\n      this.updateState\n    );\n    this.clipboard = new ClipboardHandler(\n      this.baseCanvas,\n      this.pages,\n      this.files,\n      this.history,\n      this.canvasWidth,\n      this.canvasHeight\n    );\n    this.style = new StyleHandler(\n      this.currentStyle,\n      this.drawerOptions,\n      this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\n      this.updateState\n    );\n    this.action = new ActionHandler(\n      this.switchTool,\n      this.currentStyle,\n      this.pages,\n      this.files,\n      this.history,\n      this.clipboard,\n      this.style.set\n    );\n    this.keyboard = new KeyboardHandler(\n      this.action.doAction,\n      (strict: boolean) => (this.strict = strict),\n      this.updateState\n    );\n\n    void this.switchTool(Tool.Move);\n    void this.windowResize();\n\n    window.onresize = this.windowResize;\n    window.onbeforeunload = () => this.baseCanvas.modified || null;\n\n    this.canvas.on(\"mouse:down\", this.mouseDown);\n    this.canvas.on(\"mouse:move\", this.mouseMove);\n    this.canvas.on(\"mouse:up\", this.mouseUp);\n\n    this.baseCanvas.on(\"dragenter\", () => this.setDragActive(true));\n    this.baseCanvas.on(\"dragleave\", () => this.setDragActive(false));\n    this.baseCanvas.on(\"drop\", this.drop);\n\n    this.baseCanvas.on(\"path:created\", this.pathCreated);\n    this.baseCanvas.on(\"selection:created\", this.selectionCreated);\n    this.baseCanvas.on(\"object:modified\", this.objectModified);\n    this.baseCanvas.on(\"mouse:move\", this.updateCursor);\n  }\n\n  updateState = (): void => {\n    this?.callback?.({\n      dragActive: this.dragActive,\n      currentPage: this.pages.currentIndex + 1,\n      totalPages: this.pages.pagesJSON.length,\n      currentTool: this.currentTool,\n      currentStyle: this.currentStyle,\n      canUndo: this.history.history.length > 0,\n      canRedo: this.history.redoStack.length > 0,\n      keyMap: this.keyboard.keyMap,\n    });\n  };\n\n  switchTool = async (tool: Tool): Promise<void> => {\n    if (tool === Tool.Eraser) {\n      if (await this.clipboard.cut()) return;\n    }\n\n    this.currentTool = tool;\n    this.tool = this.handlers[tool];\n\n    if (tool === Tool.Move || this.tool.isBrush) {\n      await this.baseCanvas.activateSelection();\n      this.canvasElement.parentElement.style.display = \"none\";\n      await this.tool.setBrush?.(\n        this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\n        this.drawerOptions\n      );\n    } else {\n      await this.baseCanvas.deactivateSelection();\n      this.canvasElement.parentElement.style.display = \"block\";\n    }\n\n    this.baseCanvas.isDrawingMode = this.tool.isBrush;\n\n    this.updateState();\n  };\n\n  windowResize = async (): Promise<void> => {\n    clearTimeout(this.resizeCooldown);\n    this.resizeCooldown = setTimeout(async () => {\n      await this.canvas.fitToWindow(this.canvasWidth, this.canvasHeight);\n      await this.baseCanvas.fitToWindow(this.canvasWidth, this.canvasHeight);\n    }, 100);\n  };\n\n  mouseDown = async (e: fabric.IEvent): Promise<void> => {\n    if (!this.tool.draw) return;\n\n    const { x, y } = this.canvas.getPointer(e.e);\n    this.isDown = true;\n    this.currentObject = await this.tool.draw(x, y, this.drawerOptions);\n    (this.currentObject as ObjectId).id = await this.baseCanvas.getNextId();\n    this.canvas.add(this.currentObject);\n    this.canvas.requestRenderAll();\n  };\n\n  mouseMove = async (e: fabric.IEvent): Promise<void> => {\n    if (!(this.tool.draw && this.isDown)) return;\n\n    const { x, y } = this.canvas.getPointer(e.e);\n    await this.tool.resize(this.currentObject, x, y, this.strict);\n    this.canvas.requestRenderAll();\n  };\n\n  mouseUp = async (): Promise<void> => {\n    if (!this.tool.draw) return;\n\n    this.isDown = false;\n    this.baseCanvas.add(fabric.util.object.clone(this.currentObject));\n    this.baseCanvas.requestRenderAll();\n    this.canvas.remove(this.currentObject);\n    this.canvas.requestRenderAll();\n    await this.history.add([this.currentObject]);\n  };\n\n  setDragActive = (state: boolean): void => {\n    this.dragActive = state;\n    this.updateState();\n  };\n\n  drop = async (iEvent: fabric.IEvent): Promise<void> => {\n    iEvent.e.stopPropagation();\n    iEvent.e.preventDefault();\n    this.updateCursor(iEvent);\n    this.setDragActive(false);\n\n    const historyCommand = await this.files.processFiles(\n      (iEvent.e as DragEvent).dataTransfer.files\n    );\n    await this.history.execute(historyCommand);\n  };\n\n  pathCreated = async (e: any): Promise<void> => {\n    if (this.currentTool === Tool.Pen) {\n      e.path.id = await this.baseCanvas.getNextId();\n      await this.history.add([e.path]);\n    } else if (this.currentTool === Tool.Eraser) {\n      const path = fabric.util.object.clone(e.path);\n      this.baseCanvas.remove(e.path);\n      const objects = this.baseCanvas\n        .getObjects()\n        .filter((object) => object.intersectsWithObject(path));\n      if (!objects.length) return;\n      this.baseCanvas.remove(...objects);\n      await this.history.remove(objects);\n    } else if (this.currentTool === Tool.Laser) {\n      setTimeout(async () => {\n        this.baseCanvas.remove(e.path);\n        this.baseCanvas.requestRenderAll();\n      }, 1000);\n    }\n  };\n\n  selectionCreated = (e: any): Promise<void> => this.history.store(e.selected);\n\n  objectModified = async (e: any): Promise<void> =>\n    this.history.modify(e.target._objects || [e.target]);\n\n  updateCursor = (e: fabric.IEvent): void => {\n    const { x, y } = this.baseCanvas.getPointer(e.e);\n    this.baseCanvas.cursor = { x, y };\n  };\n}\n"],"sourceRoot":""}