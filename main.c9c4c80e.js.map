{"version":3,"sources":["webpack:///./src/lib/action.ts","webpack:///./src/lib/keyboard.ts","webpack:///./src/components/Icon.tsx","webpack:///./src/components/OverlayButton.tsx","webpack:///./src/components/Pagination.tsx","webpack:///./src/components/UndoRedo.tsx","webpack:///./src/components/Toolbar.tsx","webpack:///./src/components/ButtonRow.tsx","webpack:///./src/components/StyleMenu.tsx","webpack:///./src/components/Stylebar.tsx","webpack:///./src/components/BindingModal.tsx","webpack:///./src/components/Bindings.tsx","webpack:///./src/components/HelpModal.tsx","webpack:///./src/components/ContextMenu.tsx","webpack:///./src/components/VirtualFileInput.tsx","webpack:///./src/components/Overlay.tsx","webpack:///./src/lib/tools.ts","webpack:///./src/lib/page.ts","webpack:///./src/lib/files.ts","webpack:///./src/lib/pages.ts","webpack:///./src/lib/history.ts","webpack:///./src/lib/clipboard.ts","webpack:///./src/lib/styles.ts","webpack:///./src/index.js","webpack:///./src/lib/qboard.ts"],"names":["Action","nameMap","previousPage","nextPage","addPageStart","addPageEnd","selectAll","duplicate","eraser","rectangle","transparent","halfFilled","resetStyles","fullScreen","enterFullScreen","exitFullScreen","actionName","action","name","toUpperCase","slice","switchTool","tools","currentStyle","pages","files","history","clipboard","setStyle","globalState","doAction","this","actionMap","setDash","dash","setStroke","stroke","setFill","fill","canvas","previousOrNewPage","nextOrNewPage","undo","redo","open","fileInputRef","current","click","save","saveFile","export","cut","copy","paste","deselect","discardActiveObject","requestRenderAll","setActiveObject","fabric","ActiveSelection","getObjects","move","Move","pen","Pen","Eraser","laser","Laser","line","Line","ellipse","Ellipse","Rectangle","dotted","dashed","solid","blue","green","yellow","orange","black","filled","document","fullscreenElement","ExitFullScreen","EnterFullScreen","documentElement","requestFullscreen","exitFullscreen","defaultKeys","q","w","Copy","e","Blue","esc","Deselect","r","Green","a","PreviousPage","s","NextPage","d","f","Undo","g","Paste","z","ResetStyles","x","c","v","Dotted","Transparent","Dashed","HalfFilled","Black","Redo","Solid","Filled","Yellow","Orange","SelectAll","Save","Duplicate","Cut","mirrorMap","tab","t","shift","b","mirror","key","setStrict","updateState","keyMap","window","localStorage","setItem","JSON","stringify","bindAll","value","Object","entries","bind","unbind","reset","keys","getItem","parse","fasIcon","iconName","style","className","close","transform","file","color","viewBox","width","height","marginRight","position","left","opacity","top","props","onClick","callback","backgroundColor","effect","id","place","textColor","setValue","setWidth","currentPage","toString","length","navigate","async","page","Number","totalPages","loadPage","visibility","AddPageStart","onSubmit","preventDefault","onChange","target","type","tabIndex","AddPageEnd","canUndo","undefined","canRedo","items","tool","map","isActive","cName","outerButton","actions","i","DashStyle","dashStyle","inContext","dashes","button","StrokeStyle","strokeStyle","strokes","strokeMap","FillStyle","fillStyle","fills","fileButton","fileActions","Open","Export","otherActions","mobileActions","isMobile","FullScreen","isFullscreen","setIsFullscreen","Boolean","addEventListener","setAppElement","nonBinding","overlayClassName","isOpen","letter","values","filter","includes","HeaderKey","leftHanded","label","Key","bindingModalKeys","setBindingModalKeys","bindingModalAction","setBindingModalAction","rows","header","letters","split","getModified","modifier","keyHandler","index","reverse","keyModifier","setKeyModifier","setLeftHanded","toggleOpen","fontSize","fontWeight","marginLeft","wasLeftHanded","href","toggleMobility","coords","setCoords","oldCoords","clientX","clientY","acceptFiles","captureRef","attrs","ref","display","qboard","setVisibility","helpModalOpen","setHelpModalOpen","setMobility","state","setState","dragActive","wasOpen","currentVisibility","VirtualFileInput","acceptFile","multiple","accept","currentTool","activeTool","execute","keyboard","wasMobile","Behaviors","rectify","dirs","y","x2","y2","project","reduce","acc","cur","ox","oy","vx","vy","side","sq","Math","abs","Tool","baseCanvas","_isDrawing","_requiresBase","_isBrush","active","activate","setActive","deactivate","DrawingTool","RequiresBase","Brush","pathCreated","setBrush","path","getNextId","add","brush","options","strokeDashArray","strokeWidth","util","object","clone","remove","objects","intersectsWithObject","setTimeout","draw","perPixelTargetFind","resize","strict","set","Rect","originX","originY","rx","ry","Canvas","latestId","modified","fitToWindow","canvasWidth","canvasHeight","widthRatio","innerWidth","heightRatio","innerHeight","setZoom","min","getZoom","setHeight","deactivateSelection","isDrawingMode","selection","forEachObject","selectable","activateSelection","getObjectByIds","ids","serialize","getActiveObjects","some","obj","toObject","apply","newObjects","oldObjects","addObjects","forEach","enlivenObjects","loadFromJSONAsync","json","Promise","resolve","super","loadFromJSON","cursor","defaults","getDefaultValue","AsyncReader","readAsText","reject","reader","FileReader","onload","result","onerror","readAsDataURL","JSONReader","readParsed","version","JSONWriter","pagesJSON","asString","sourceJSON","toBlob","asBlob","Blob","toURL","asUrl","URL","createObjectURL","revokeObjectURL","download","filename","fileURL","revokeURL","elt","createElement","body","appendChild","processFiles","images","all","startsWith","push","handleImage","handleJSON","flat","openFile","clear","savePage","overwritePages","read","then","Image","fromURL","placeObject","insertPagesAfter","defaultPageJSON","background","timeString","offset","Date","getTimezoneOffset","now","toISOString","replace","currentIndex","saveExisting","insertPagesBefore","content","currentIndexCopy","svg","toSVG","docDefinition","pageSize","pageMargins","createPdf","every","confirm","isNonModifying","splice","HistoryHandler","redoStack","locked","command","clearRedo","store","modify","basis","from","to","isUndo","last","pop","ClipboardHandler","getActiveObject","_objects","pasteExternal","historyCommand","clipboardData","dashMap","StyleHandler","drawerOptions","freeDrawingBrush","canvasElement","baseCanvasElement","strokeUniform","isDown","isBrush","requiresBase","parentElement","windowResize","resizeCooldown","clearTimeout","mouseDown","isDrawing","getPointer","currentObject","mouseMove","mouseUp","setDragActive","drop","iEvent","stopPropagation","updateCursor","dataTransfer","selectionCreated","selected","objectModified","queryParams","URLSearchParams","location","search","renderOnAddRemove","targetFindTolerance","jsonLink","get","loadJSON","catch","console","error","onresize","onbeforeunload","on","querySelector","ReactDOM","render"],"mappings":"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","file":"main.c9c4c80e.js","sourcesContent":["import { fabric } from \"fabric\";\r\n\r\nimport { Tool, Tools } from \"./tools\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport HistoryHandler from \"./history\";\r\nimport { Dash, Fill, Stroke, Style } from \"./styles\";\r\nimport React from \"react\";\r\n\r\nexport enum Action {\r\n  PreviousPage = \"previousPage\",\r\n  NextPage = \"nextPage\",\r\n  AddPageStart = \"addPageStart\",\r\n  AddPageEnd = \"addPageEnd\",\r\n\r\n  Undo = \"undo\",\r\n  Redo = \"redo\",\r\n\r\n  Open = \"open\",\r\n  Save = \"save\",\r\n  Export = \"export\",\r\n  Cut = \"cut\",\r\n  Copy = \"copy\",\r\n  Paste = \"paste\",\r\n\r\n  Deselect = \"deselect\",\r\n  SelectAll = \"selectAll\",\r\n  Duplicate = \"duplicate\",\r\n\r\n  Move = \"move\",\r\n  Pen = \"pen\",\r\n  Eraser = \"eraser\",\r\n  Laser = \"laser\",\r\n  Line = \"line\",\r\n  Ellipse = \"ellipse\",\r\n  Rectangle = \"rectangle\",\r\n\r\n  Dotted = \"dotted\",\r\n  Dashed = \"dashed\",\r\n  Solid = \"solid\",\r\n\r\n  Black = \"black\",\r\n  Blue = \"blue\",\r\n  Green = \"green\",\r\n  Orange = \"orange\",\r\n  Yellow = \"yellow\",\r\n\r\n  Transparent = \"transparent\",\r\n  HalfFilled = \"halfFilled\",\r\n  Filled = \"filled\",\r\n\r\n  ResetStyles = \"resetStyles\",\r\n  FullScreen = \"fullScreen\",\r\n  EnterFullScreen = \"enterFullScreen\",\r\n  ExitFullScreen = \"exitFullScreen\",\r\n}\r\n\r\nconst nameMap = {\r\n  previousPage: \"â€“Page\",\r\n  nextPage: \"+Page\",\r\n  addPageStart: \"-Page\",\r\n  addPageEnd: \"+Page\",\r\n  selectAll: \"Select All\",\r\n  duplicate: \"Clone\",\r\n  eraser: \"Cut / Eraser\",\r\n  rectangle: \"Rect.\",\r\n  transparent: \"Unfilled\",\r\n  halfFilled: \"Half Fill\",\r\n  resetStyles: \"Reset Styles\",\r\n  fullScreen: \"Full Screen\",\r\n  enterFullScreen: \"Enter Full Screen\",\r\n  exitFullScreen: \"Exit Full Screen\",\r\n};\r\n\r\nexport const actionName = (action: Action): string => {\r\n  const name = nameMap[action] || action;\r\n  return name && name[0].toUpperCase() + name.slice(1);\r\n};\r\n\r\nexport default class ActionHandler {\r\n  canvas: fabric.Canvas;\r\n  readonly actionMap: Record<Action, () => void>;\r\n\r\n  constructor(\r\n    public switchTool: (tool: Tool) => void,\r\n    tools: Tools,\r\n    public currentStyle: Style,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public clipboard: ClipboardHandler,\r\n    public setStyle: (\r\n      dash: Dash | null,\r\n      stroke: Stroke | null,\r\n      fill: Fill | null\r\n    ) => void,\r\n    /**\r\n     * Intentionally mutable global state object\r\n     */\r\n    private globalState: {\r\n      /**\r\n       * A ref to the global input element used for file input\r\n       *\r\n       * Readonly because we ourselves don't mutate this\r\n       */\r\n      readonly fileInputRef?: React.RefObject<HTMLInputElement>;\r\n    }\r\n  ) {\r\n    this.canvas = this.pages.canvas;\r\n\r\n    this.actionMap = {\r\n      previousPage: pages.previousOrNewPage,\r\n      nextPage: pages.nextOrNewPage,\r\n      addPageStart: pages.previousOrNewPage,\r\n      addPageEnd: pages.nextOrNewPage,\r\n\r\n      undo: history.undo,\r\n      redo: history.redo,\r\n\r\n      open: () => globalState.fileInputRef?.current?.click(),\r\n      save: pages.saveFile,\r\n      export: pages.export,\r\n      cut: clipboard.cut,\r\n      copy: clipboard.copy,\r\n      paste: clipboard.paste,\r\n\r\n      deselect: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      selectAll: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.setActiveObject(\r\n          new fabric.ActiveSelection(this.canvas.getObjects(), {\r\n            canvas: this.canvas,\r\n          })\r\n        );\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      duplicate: () => {\r\n        this.clipboard.copy();\r\n        this.clipboard.paste();\r\n      },\r\n\r\n      move: () => this.switchTool(tools.Move),\r\n      pen: () => this.switchTool(tools.Pen),\r\n      eraser: () => this.switchTool(tools.Eraser),\r\n      laser: () => this.switchTool(tools.Laser),\r\n      line: () => this.switchTool(tools.Line),\r\n      ellipse: () => this.switchTool(tools.Ellipse),\r\n      rectangle: () => this.switchTool(tools.Rectangle),\r\n\r\n      dotted: () => this.setDash(Dash.Dotted),\r\n      dashed: () => this.setDash(Dash.Dashed),\r\n      solid: () => this.setDash(Dash.Solid),\r\n\r\n      blue: () => this.setStroke(Stroke.Blue),\r\n      green: () => this.setStroke(Stroke.Green),\r\n      yellow: () => this.setStroke(Stroke.Yellow),\r\n      orange: () => this.setStroke(Stroke.Orange),\r\n      black: () => this.setStroke(Stroke.Black),\r\n\r\n      transparent: () => this.setFill(Fill.Transparent),\r\n      halfFilled: () => this.setFill(Fill.HalfSolid),\r\n      filled: () => this.setFill(Fill.Solid),\r\n\r\n      resetStyles: () =>\r\n        this.setStyle(Dash.Solid, Stroke.Black, Fill.Transparent),\r\n      fullScreen: () =>\r\n        this.doAction(\r\n          !document.fullscreenElement\r\n            ? Action.EnterFullScreen\r\n            : Action.ExitFullScreen\r\n        ),\r\n      enterFullScreen: () => document.documentElement.requestFullscreen(),\r\n      exitFullScreen: () => document.exitFullscreen(),\r\n    };\r\n  }\r\n\r\n  doAction = (action: Action): void => this.actionMap[action]();\r\n\r\n  setDash = (dash: Dash): void => {\r\n    if (dash === this.currentStyle.dash) {\r\n      this.setStyle(Dash.Solid, null, null);\r\n    } else {\r\n      this.setStyle(dash, null, null);\r\n    }\r\n  };\r\n\r\n  setStroke = (stroke: Stroke): void => {\r\n    if (stroke === this.currentStyle.stroke) {\r\n      this.setStyle(null, Stroke.Black, null);\r\n    } else {\r\n      this.setStyle(null, stroke, null);\r\n    }\r\n  };\r\n\r\n  setFill = (fill: Fill): void => {\r\n    if (fill === this.currentStyle.fill) {\r\n      this.setStyle(null, null, Fill.Transparent);\r\n    } else {\r\n      this.setStyle(null, null, fill);\r\n    }\r\n  };\r\n}\r\n","import keyboardJS from \"keyboardjs\";\r\n\r\nimport { Action } from \"./action\";\r\n\r\nexport type KeyMap = {\r\n  [key: string]: Action;\r\n};\r\n\r\nexport type MirrorMap = {\r\n  [key: string]: string;\r\n};\r\n\r\nexport const defaultKeys: KeyMap = {\r\n  q: Action.Laser,\r\n  w: Action.Copy,\r\n  e: Action.Blue,\r\n  esc: Action.Deselect,\r\n  r: Action.Green,\r\n  a: Action.PreviousPage,\r\n  s: Action.NextPage,\r\n  d: Action.Pen,\r\n  f: Action.Undo,\r\n  g: Action.Paste,\r\n  z: Action.ResetStyles,\r\n  x: Action.Eraser,\r\n  c: Action.Line,\r\n  v: Action.Move,\r\n\r\n  \"shift + q\": Action.Dotted,\r\n  \"shift + w\": Action.Transparent,\r\n  \"shift + e\": Action.Ellipse,\r\n  \"shift + r\": Action.Rectangle,\r\n  \"shift + a\": Action.Dashed,\r\n  \"shift + s\": Action.HalfFilled,\r\n  \"shift + d\": Action.Black,\r\n  \"shift + f\": Action.Redo,\r\n  \"shift + z\": Action.Solid,\r\n  \"shift + x\": Action.Filled,\r\n  \"shift + c\": Action.Yellow,\r\n  \"shift + v\": Action.Orange,\r\n\r\n  \"ctrl + a\": Action.SelectAll,\r\n  \"ctrl + s\": Action.Save,\r\n  \"ctrl + d\": Action.Duplicate,\r\n  \"ctrl + z\": Action.Undo,\r\n  \"ctrl + x\": Action.Cut,\r\n  \"ctrl + c\": Action.Copy,\r\n};\r\n\r\nconst mirrorMap: MirrorMap = {\r\n  tab: \"[\",\r\n  q: \"p\",\r\n  w: \"o\",\r\n  e: \"i\",\r\n  r: \"u\",\r\n  t: \"y\",\r\n  esc: \"'\",\r\n  a: \";\",\r\n  s: \"l\",\r\n  d: \"k\",\r\n  f: \"j\",\r\n  g: \"h\",\r\n  shift: \"shift\",\r\n  z: \"/\",\r\n  x: \".\",\r\n  c: \",\",\r\n  v: \"m\",\r\n  b: \"n\",\r\n};\r\n\r\nexport const mirror = (key: string): string => {\r\n  return mirrorMap[key] || key.slice(0, -1) + mirrorMap[key.slice(-1)];\r\n};\r\n\r\nexport default class KeyboardHandler {\r\n  keyMap: KeyMap = {};\r\n\r\n  constructor(\r\n    public doAction: (action: Action) => void,\r\n    public setStrict: (strict: boolean) => void,\r\n    public updateState: () => void\r\n  ) {\r\n    keyboardJS.bind(\r\n      \"shift\",\r\n      () => {\r\n        this.setStrict(true);\r\n      },\r\n      () => {\r\n        this.setStrict(false);\r\n      }\r\n    );\r\n\r\n    const keyMap = window.localStorage.getItem(\"keyMap\");\r\n    if (keyMap === null) {\r\n      this.reset();\r\n    } else {\r\n      this.keyMap = JSON.parse(keyMap);\r\n      this.bindAll();\r\n    }\r\n  }\r\n\r\n  save = (): void => {\r\n    window.localStorage.setItem(\"keyMap\", JSON.stringify(this.keyMap));\r\n  };\r\n\r\n  bindAll = (): void => {\r\n    for (const [key, value] of Object.entries(this.keyMap)) {\r\n      this.bind(key, value);\r\n    }\r\n    this.updateState();\r\n  };\r\n\r\n  unbind = (key: string): void => {\r\n    delete this.keyMap[key];\r\n    keyboardJS.unbind(key);\r\n    keyboardJS.unbind(mirror(key));\r\n    this.updateState();\r\n    this.save();\r\n  };\r\n\r\n  bind = (key: string, action: Action): void => {\r\n    this.keyMap[key] = action;\r\n    keyboardJS.bind(key, () => this.doAction(this.keyMap[key]));\r\n    keyboardJS.bind(mirror(key), () => this.doAction(this.keyMap[key]));\r\n    this.updateState();\r\n    this.save();\r\n  };\r\n\r\n  reset = (): void => {\r\n    for (const key of Object.keys(this.keyMap)) {\r\n      keyboardJS.unbind(key);\r\n      keyboardJS.unbind(mirror(key));\r\n    }\r\n    this.keyMap = { ...defaultKeys };\r\n    this.bindAll();\r\n    this.save();\r\n  };\r\n}\r\n","import React, { CSSProperties } from \"react\";\r\n\r\nimport { Stroke } from \"../lib/styles\";\r\n\r\nconst fasIcon = (iconName: string, style?: CSSProperties) => (\r\n  <i className={`fas fa-${iconName}`} style={style} />\r\n);\r\n\r\nconst Icon = {\r\n  close: fasIcon(\"times-circle\"),\r\n\r\n  previousPage: fasIcon(\"caret-left\"),\r\n  nextPage: fasIcon(\"caret-right\"),\r\n  addPageStart: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\r\n  addPageEnd: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\r\n\r\n  undo: fasIcon(\"undo\"),\r\n  redo: fasIcon(\"redo\"),\r\n\r\n  move: fasIcon(\"mouse-pointer\"),\r\n  pen: fasIcon(\"pen\"),\r\n  eraser: fasIcon(\"eraser\"),\r\n  laser: fasIcon(\"asterisk\"),\r\n  line: fasIcon(\"minus\", { transform: \"rotate(-45deg)\" }),\r\n  ellipse: fasIcon(\"circle\"),\r\n  rectangle: fasIcon(\"square\"),\r\n\r\n  file: fasIcon(\"file\"),\r\n  open: fasIcon(\"folder-open\"),\r\n  save: fasIcon(\"save\"),\r\n  export: fasIcon(\"file-export\"),\r\n  cut: fasIcon(\"cut\"),\r\n  copy: fasIcon(\"copy\"),\r\n  paste: fasIcon(\"paste\"),\r\n\r\n  duplicate: fasIcon(\"clone\"),\r\n\r\n  fullScreen: fasIcon(\"expand\"),\r\n  enterFullScreen: fasIcon(\"expand\"),\r\n  exitFullScreen: fasIcon(\"compress\"),\r\n\r\n  black: fasIcon(\"circle\", { color: Stroke.Black }),\r\n  blue: fasIcon(\"circle\", { color: Stroke.Blue }),\r\n  green: fasIcon(\"circle\", { color: Stroke.Green }),\r\n  orange: fasIcon(\"circle\", { color: Stroke.Orange }),\r\n  yellow: fasIcon(\"circle\", { color: Stroke.Yellow }),\r\n\r\n  dotted: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  dashed: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M101,1176.92v2.021c1.735-0.192,3.319-0.878,4.613-1.913l-1.43-1.43C103.269,1176.284,102.183,1176.75,101,1176.92z\" />\r\n          <path d=\"M93.08,1171h-2.021c0.191,1.735,0.879,3.319,1.914,4.614l1.43-1.43C93.716,1173.269,93.25,1172.183,93.08,1171z\" />\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M106.92,1169h2.021c-0.191-1.735-0.879-3.319-1.914-4.614l-1.43,1.43C106.284,1166.731,106.75,1167.817,106.92,1169z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M99,1163.08v-2.021c-1.735,0.192-3.319,0.878-4.613,1.913l1.43,1.43C96.731,1163.716,97.817,1163.25,99,1163.08z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  solid: <i className=\"far fa-circle\" />,\r\n\r\n  transparent: <i className=\"far fa-circle\" />,\r\n  halfFilled: (\r\n    <div style={{ height: \"0.7em\", marginRight: \"1em\", position: \"relative\" }}>\r\n      <i\r\n        className=\"fas fa-circle\"\r\n        style={{ left: \"50%\", opacity: 0.3, position: \"absolute\", top: 0 }}\r\n      />\r\n      <i\r\n        className=\"far fa-circle\"\r\n        style={{ left: \"50%\", position: \"absolute\", top: 0 }}\r\n      />\r\n    </div>\r\n  ),\r\n  filled: fasIcon(\"circle\"),\r\n\r\n  resetStyles: null,\r\n};\r\n\r\nexport default Icon;\r\n","import React from \"react\";\r\nimport ReactTooltip from \"react-tooltip\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\n\r\nconst OverlayButton = (props: {\r\n  action: Action;\r\n  callback: (action: Action) => void;\r\n  className?: string;\r\n}): JSX.Element => {\r\n  return (\r\n    <>\r\n      <button\r\n        className={props.className}\r\n        data-tip\r\n        data-for={props.action}\r\n        onClick={() => props.callback(props.action)}\r\n      >\r\n        {Icon[props.action]}\r\n      </button>\r\n      <ReactTooltip\r\n        backgroundColor=\"#ddd\"\r\n        effect=\"solid\"\r\n        id={props.action}\r\n        place=\"right\"\r\n        textColor=\"#262626\"\r\n      >\r\n        {actionName(props.action)}\r\n      </ReactTooltip>\r\n    </>\r\n  );\r\n};\r\n\r\nexport default OverlayButton;\r\n","import React, { useEffect, useState } from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst Pagination = (props: {\r\n  loadPage: (index: number) => Promise<void | number>;\r\n  currentPage: number;\r\n  totalPages: number;\r\n  doAction: (action: Action) => void;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  const [value, setValue] = useState(0);\r\n  const [width, setWidth] = useState(\"0.6em\");\r\n\r\n  useEffect(() => {\r\n    setValue(props.currentPage);\r\n    setWidth(`${0.6 * props.currentPage.toString().length}em`);\r\n  }, [props]);\r\n\r\n  const navigate = async () => {\r\n    if (!value) return;\r\n    const page = Number(value);\r\n    if (!page || page > props.totalPages) {\r\n      setValue(props.currentPage);\r\n    } else {\r\n      await props.loadPage(page - 1);\r\n    }\r\n  };\r\n\r\n  useEffect(() => void navigate(), [value]);\r\n\r\n  const onSubmit = (e) => {\r\n    e?.preventDefault();\r\n    return navigate();\r\n  };\r\n\r\n  const onChange = (e) => setValue(e.target.value);\r\n\r\n  return (\r\n    <div className={`pagination visibility-${props.visibility}`}>\r\n      {props.currentPage === 1 ? (\r\n        <OverlayButton action={Action.AddPageStart} callback={props.doAction} />\r\n      ) : (\r\n        <OverlayButton action={Action.PreviousPage} callback={props.doAction} />\r\n      )}\r\n      <form onSubmit={onSubmit}>\r\n        <input\r\n          onChange={onChange}\r\n          type=\"text\"\r\n          value={value}\r\n          style={{ width }}\r\n          tabIndex={-1}\r\n        />\r\n      </form>\r\n      <span className=\"total-pages\"> / {props.totalPages}</span>\r\n      {props.currentPage === props.totalPages ? (\r\n        <OverlayButton action={Action.AddPageEnd} callback={props.doAction} />\r\n      ) : (\r\n        <OverlayButton action={Action.NextPage} callback={props.doAction} />\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Pagination;\r\n","import React from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst UndoRedo = (props: {\r\n  canUndo: boolean;\r\n  canRedo: boolean;\r\n  doAction: (action: Action) => void;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  return (\r\n    <div className={`undoredo visibility-${props.visibility}`}>\r\n      <OverlayButton\r\n        action={Action.Undo}\r\n        callback={props.doAction}\r\n        className={props.canUndo ? undefined : \"disabled\"}\r\n      />\r\n      <OverlayButton\r\n        action={Action.Redo}\r\n        callback={props.doAction}\r\n        className={props.canRedo ? undefined : \"disabled\"}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default UndoRedo;\r\n","import React from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\nimport { Tool, Tools } from \"../lib/tools\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst Toolbar = (props: {\r\n  currentTool: Tool;\r\n  tools: Tools;\r\n  doAction: (action: Action) => void;\r\n  visibility: Visibility;\r\n}): JSX.Element => {\r\n  const items = [\r\n    { tool: props.tools.Move, action: Action.Move },\r\n    { tool: props.tools.Pen, action: Action.Pen },\r\n    { tool: props.tools.Eraser, action: Action.Eraser },\r\n    { tool: props.tools.Laser, action: Action.Laser },\r\n    { tool: props.tools.Line, action: Action.Line },\r\n    { tool: props.tools.Rectangle, action: Action.Rectangle },\r\n    { tool: props.tools.Ellipse, action: Action.Ellipse },\r\n  ];\r\n\r\n  return (\r\n    <div className={`toolbar visibility-${props.visibility}`}>\r\n      {items.map(({ tool, action }) => (\r\n        <OverlayButton\r\n          action={action}\r\n          callback={props.doAction}\r\n          className={tool.isActive() ? \"active\" : undefined}\r\n          key={action}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Toolbar;\r\n","import React, { ReactNode } from \"react\";\r\n\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport OverlayButton from \"./OverlayButton\";\r\n\r\nconst ButtonRow = (props: {\r\n  actions: Action[];\r\n  callback: (action: Action) => void;\r\n  className?: (action: Action, i: number) => undefined | string;\r\n  cName?: string;\r\n  outerButton?: boolean | ReactNode;\r\n}): JSX.Element => {\r\n  return (\r\n    <div\r\n      className={`button-row ${props.cName} ${\r\n        props.outerButton ? \"button-row-hover\" : \"\"\r\n      }`}\r\n    >\r\n      {props.outerButton}\r\n      <div className=\"button-row-inner\">\r\n        {props.actions.map((action, i) => (\r\n          <OverlayButton\r\n            action={action}\r\n            className={props.className?.(action, i)}\r\n            callback={props.callback}\r\n            key={action}\r\n          />\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ButtonRow;\r\n","import React from \"react\";\r\n\r\nimport { Dash, Fill, Stroke, Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\nimport ButtonRow from \"./ButtonRow\";\r\n\r\ntype StyleOptions = {\r\n  callback: (action: Action) => void;\r\n  inContext?: boolean;\r\n};\r\n\r\nconst DashStyle = ({\r\n  dashStyle,\r\n  callback,\r\n  inContext = false,\r\n}: StyleOptions & { dashStyle: Dash }) => {\r\n  const dashes = [Action.Solid, Action.Dashed, Action.Dotted];\r\n  const button = (\r\n    <button className=\"inactive\">{Icon[dashes[dashStyle]]}</button>\r\n  );\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={dashes}\r\n      className={(action, i) => {\r\n        if (inContext && dashStyle === i) return \"active\";\r\n      }}\r\n      callback={callback}\r\n      outerButton={!inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst StrokeStyle = ({\r\n  strokeStyle,\r\n  callback,\r\n  inContext = false,\r\n}: StyleOptions & {\r\n  strokeStyle: string;\r\n}): JSX.Element => {\r\n  const strokes = [\r\n    Action.Black,\r\n    Action.Blue,\r\n    Action.Green,\r\n    Action.Yellow,\r\n    Action.Orange,\r\n  ];\r\n  const strokeMap = [\r\n    Stroke.Black,\r\n    Stroke.Blue,\r\n    Stroke.Green,\r\n    Stroke.Yellow,\r\n    Stroke.Orange,\r\n  ];\r\n  const button = (\r\n    <button className=\"inactive\">\r\n      <i className=\"fas fa-circle\" style={{ color: strokeStyle }} />\r\n    </button>\r\n  );\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={strokes}\r\n      className={(action, i) => {\r\n        if (inContext && strokeStyle === strokeMap[i]) return \"active\";\r\n      }}\r\n      callback={callback}\r\n      outerButton={!inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst FillStyle = ({\r\n  fillStyle,\r\n  callback,\r\n  inContext = false,\r\n}: StyleOptions & {\r\n  fillStyle: Fill;\r\n}): JSX.Element => {\r\n  const fills = [Action.Transparent, Action.Filled, Action.HalfFilled];\r\n  const button = <button className=\"inactive\">{Icon[fills[fillStyle]]}</button>;\r\n\r\n  return (\r\n    <ButtonRow\r\n      actions={fills}\r\n      className={(action, i) => {\r\n        if (inContext && fillStyle === i) return \"active\";\r\n      }}\r\n      callback={callback}\r\n      outerButton={!inContext && button}\r\n    />\r\n  );\r\n};\r\n\r\nconst StyleMenu = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => void;\r\n  inContext?: boolean;\r\n}): JSX.Element => {\r\n  return (\r\n    <>\r\n      <DashStyle\r\n        dashStyle={props.currentStyle.dash}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n      <StrokeStyle\r\n        strokeStyle={props.currentStyle.stroke}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n      <FillStyle\r\n        fillStyle={props.currentStyle.fill}\r\n        callback={props.doAction}\r\n        inContext={props.inContext}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default StyleMenu;\r\n","import React, { useEffect, useState } from \"react\";\r\n\r\nimport { Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport { Visibility } from \"./Overlay\";\r\nimport ButtonRow from \"./ButtonRow\";\r\nimport Icon from \"./Icon\";\r\nimport StyleMenu from \"./StyleMenu\";\r\n\r\nconst Stylebar = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => void;\r\n  acceptFile: (files: FileList) => Promise<void | void[]>;\r\n  visibility: Visibility;\r\n  isMobile: boolean;\r\n}): JSX.Element => {\r\n  const fileButton = <button className=\"inactive\">{Icon.file}</button>;\r\n  const fileActions = [Action.Open, Action.Save, Action.Export];\r\n\r\n  const otherActions = [Action.Copy, Action.Paste];\r\n  const mobileActions = props.isMobile ? [Action.FullScreen] : [];\r\n\r\n  const [isFullscreen, setIsFullscreen] = useState(false);\r\n\r\n  useEffect(() => {\r\n    setIsFullscreen(Boolean(document.fullscreenElement));\r\n    document.addEventListener(\"fullscreenchange\", () =>\r\n      setIsFullscreen(Boolean(document.fullscreenElement))\r\n    );\r\n  }, []);\r\n\r\n  return (\r\n    <div className={`stylebar visibility-${props.visibility}`}>\r\n      <ButtonRow\r\n        actions={fileActions}\r\n        callback={props.doAction}\r\n        cName=\"file-actions\"\r\n        outerButton={fileButton}\r\n      />\r\n      <ButtonRow\r\n        actions={otherActions}\r\n        cName=\"other-actions vertical\"\r\n        callback={props.doAction}\r\n      />\r\n      <StyleMenu currentStyle={props.currentStyle} doAction={props.doAction} />\r\n      <ButtonRow\r\n        actions={mobileActions.map((action) =>\r\n          action === Action.FullScreen\r\n            ? !isFullscreen\r\n              ? Action.EnterFullScreen\r\n              : Action.ExitFullScreen\r\n            : action\r\n        )}\r\n        callback={props.doAction}\r\n        cName=\"mobile-actions vertical\"\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Stylebar;\r\n","import React from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\n\r\nimport Icon from \"./Icon\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst nonBinding: Action[] = [\r\n  Action.AddPageStart,\r\n  Action.AddPageEnd,\r\n  Action.EnterFullScreen,\r\n  Action.ExitFullScreen,\r\n];\r\n\r\nconst BindingModal = (props: {\r\n  letter: string;\r\n  action: Action | null;\r\n  close: () => void;\r\n  callback: (action: Action | null) => void;\r\n}): Partial<Modal> & JSX.Element => (\r\n  <Modal\r\n    className=\"modal\"\r\n    overlayClassName=\"modal-overlay binding-modal\"\r\n    isOpen={props.letter !== \"\"}\r\n  >\r\n    <button className=\"close\" onClick={() => props.close()}>\r\n      {Icon.close}\r\n    </button>\r\n    <p>\r\n      Changing <span className=\"binding\">{props.letter}</span> bindingâ€¦\r\n    </p>\r\n    <div className=\"tools\">\r\n      <button\r\n        className={props.action === undefined ? \"active\" : undefined}\r\n        onClick={() => props.callback(null)}\r\n      >\r\n        <span style={{ left: \"0.25em\" }}>none</span>\r\n      </button>\r\n      {Object.values(Action)\r\n        .filter((action) => !nonBinding.includes(action))\r\n        .map((action) => (\r\n          <button\r\n            key={action}\r\n            className={props.action === action ? \"active\" : undefined}\r\n            onClick={() => props.callback(action)}\r\n          >\r\n            {Icon[action]}\r\n            <span style={Icon[action] ? {} : { left: \"0.25em\" }}>\r\n              {actionName(action)}\r\n            </span>\r\n          </button>\r\n        ))}\r\n    </div>\r\n  </Modal>\r\n);\r\n\r\nexport default BindingModal;\r\n","import React, { useState } from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action, actionName } from \"../lib/action\";\r\nimport { KeyMap, mirror } from \"../lib/keyboard\";\r\n\r\nimport Icon from \"./Icon\";\r\nimport BindingModal from \"./BindingModal\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst HeaderKey = (props: {\r\n  letter: string;\r\n  label?: string;\r\n  width: string;\r\n  leftHanded: boolean;\r\n}) => {\r\n  return (\r\n    <div className=\"key\" style={{ width: props.width }}>\r\n      <span className=\"letter\">\r\n        {props.leftHanded ? mirror(props.letter) : props.letter}\r\n      </span>\r\n      <div className=\"action\">\r\n        <span className=\"unassigned\">{props.label || \"\"}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nconst Key = (props: {\r\n  letter: string;\r\n  action?: Action;\r\n  callback: (key: string) => void;\r\n  leftHanded: boolean;\r\n}) => {\r\n  return (\r\n    <button className=\"key\" onClick={() => props.callback(props.letter)}>\r\n      <div className=\"action\">\r\n        {props.action && Icon[props.action]}\r\n        <span className={props.action === undefined ? \"unassigned\" : undefined}>\r\n          {props.action === undefined ? \"none\" : actionName(props.action)}\r\n        </span>\r\n      </div>\r\n      <span className=\"letter\">\r\n        {props.leftHanded ? mirror(props.letter) : props.letter}\r\n      </span>\r\n    </button>\r\n  );\r\n};\r\n\r\nconst Bindings = (props: {\r\n  bind: (key: string, action: Action) => void;\r\n  unbind: (key: string) => void;\r\n  keyMap: KeyMap;\r\n  modifier: string;\r\n  leftHanded: boolean;\r\n}): JSX.Element => {\r\n  const [bindingModalKeys, setBindingModalKeys]: [\r\n    string,\r\n    React.Dispatch<React.SetStateAction<string>>\r\n  ] = useState<string>(\"\");\r\n  const [bindingModalAction, setBindingModalAction] = useState<Action | null>(\r\n    null\r\n  );\r\n\r\n  const rows = [\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"tab\"\r\n          label=\"Hide Toolbar\"\r\n          width=\"4.5em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"qwert\".split(\"\"),\r\n    },\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"esc\"\r\n          label=\"Deselect\"\r\n          width=\"6em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"asdfg\".split(\"\"),\r\n    },\r\n    {\r\n      header: (\r\n        <HeaderKey\r\n          letter=\"shift\"\r\n          label=\"Snap\"\r\n          width=\"7.5em\"\r\n          leftHanded={props.leftHanded}\r\n        />\r\n      ),\r\n      letters: \"zxcvb\".split(\"\"),\r\n    },\r\n  ];\r\n\r\n  const getModified = (letter: string): string =>\r\n    props.modifier === \"\" ? letter : `${props.modifier} + ${letter}`;\r\n\r\n  const keyHandler = (letter: string): void => {\r\n    setBindingModalKeys(getModified(letter));\r\n    setBindingModalAction(props.keyMap[getModified(letter)]);\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div className=\"bindings\">\r\n        {rows.map(({ header, letters }, index) => (\r\n          <div className={`row ${props.leftHanded ? \"left\" : \"\"}`} key={index}>\r\n            {!props.leftHanded && header}\r\n            {(props.leftHanded ? letters.reverse() : letters).map((letter) => (\r\n              <Key\r\n                key={letter}\r\n                letter={letter}\r\n                action={props.keyMap[getModified(letter)]}\r\n                callback={keyHandler}\r\n                leftHanded={props.leftHanded}\r\n              />\r\n            ))}\r\n            {props.leftHanded && header}\r\n          </div>\r\n        ))}\r\n      </div>\r\n      <BindingModal\r\n        letter={bindingModalKeys}\r\n        action={bindingModalAction}\r\n        close={() => setBindingModalKeys(\"\")}\r\n        callback={(action) => {\r\n          props.unbind(bindingModalKeys);\r\n          if (action) props.bind(bindingModalKeys, action);\r\n          setBindingModalKeys(\"\");\r\n        }}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default Bindings;\r\n","import React, { useEffect, useState } from \"react\";\r\nimport Modal from \"react-modal\";\r\n\r\nimport { Action } from \"../lib/action\";\r\nimport { KeyMap } from \"../lib/keyboard\";\r\n\r\nimport Bindings from \"./Bindings\";\r\nimport Icon from \"./Icon\";\r\n\r\nModal.setAppElement(\"#Overlay\");\r\n\r\nconst HelpModal = (props: {\r\n  bind: (key: string, action: Action) => void;\r\n  unbind: (key: string) => void;\r\n  reset: () => void;\r\n  keyMap: KeyMap;\r\n  isOpen: boolean;\r\n  toggleOpen: () => void;\r\n  isMobile: boolean;\r\n  toggleMobility: () => void;\r\n}): JSX.Element => {\r\n  const [keyModifier, setKeyModifier] = useState(\"\");\r\n  const [leftHanded, setLeftHanded] = useState(false);\r\n\r\n  const toggleHand = (): void => {\r\n    setLeftHanded((wasLeftHanded: boolean) => {\r\n      window.localStorage.setItem(\r\n        \"leftHanded\",\r\n        wasLeftHanded ? \"false\" : \"true\"\r\n      );\r\n\r\n      return !wasLeftHanded;\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (window.localStorage.getItem(\"leftHanded\") === \"true\") {\r\n      setLeftHanded(true);\r\n    }\r\n  }, []);\r\n\r\n  return (\r\n    <Modal\r\n      className=\"modal\"\r\n      overlayClassName=\"modal-overlay help-modal\"\r\n      isOpen={props.isOpen}\r\n    >\r\n      <button className=\"close\" onClick={() => props.toggleOpen()}>\r\n        {Icon.close}\r\n      </button>\r\n      <p>\r\n        <span style={{ fontSize: \"1.5em\", fontWeight: \"bold\" }}>qboard</span>{\" \"}\r\n        <span style={{ color: \"#666\", marginLeft: \"0.2em\" }}>\r\n          The efficient digital whiteboard.\r\n        </span>\r\n      </p>\r\n      <p>\r\n        Press <b>{leftHanded ? \"0\" : \"1\"}</b> to show or hide this screen.\r\n      </p>\r\n      <p>\r\n        <button\r\n          className={keyModifier === \"\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"\")}\r\n        >\r\n          unmodified\r\n        </button>\r\n        <button\r\n          className={keyModifier === \"shift\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"shift\")}\r\n        >\r\n          with shift\r\n        </button>\r\n        <button\r\n          className={keyModifier === \"ctrl\" ? \"active\" : undefined}\r\n          onClick={() => setKeyModifier(\"ctrl\")}\r\n        >\r\n          with ctrl\r\n        </button>\r\n        <button onClick={() => toggleHand()}>\r\n          {leftHanded ? \"show left side\" : \"show right side\"}\r\n        </button>\r\n      </p>\r\n      <Bindings\r\n        bind={props.bind}\r\n        unbind={props.unbind}\r\n        keyMap={props.keyMap}\r\n        modifier={keyModifier}\r\n        leftHanded={leftHanded}\r\n      />\r\n      <p>\r\n        Click a key to change the binding.{\" \"}\r\n        <button onClick={() => props.reset()}>reset to default</button>\r\n      </p>\r\n      <p style={{ color: \"#666\" }}>\r\n        By <a href=\"https://cjquines.com/\">CJ Quines</a> and{\" \"}\r\n        <a href=\"https://pihart.github.io/\">Avi Mehra</a>. View on{\" \"}\r\n        <a href=\"https://github.com/cjquines/qboard\">Github</a>. Use{\" \"}\r\n        <a onClick={() => props.toggleMobility()} tabIndex={0}>\r\n          {props.isMobile ? \"desktop\" : \"mobile\"} site\r\n        </a>\r\n        .\r\n      </p>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default HelpModal;\r\n","import React, { useEffect, useState } from \"react\";\r\n\r\nimport { Style } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nimport StyleMenu from \"./StyleMenu\";\r\n\r\nconst ContextMenu = (props: {\r\n  currentStyle: Style;\r\n  doAction: (action: Action) => void;\r\n}): JSX.Element | null => {\r\n  const [coords, setCoords] = useState<[number, number] | null>(null);\r\n\r\n  useEffect(() => {\r\n    document.addEventListener(\"contextmenu\", (e: MouseEvent) => {\r\n      e.preventDefault();\r\n      setCoords((oldCoords) => (oldCoords ? null : [e.clientX, e.clientY]));\r\n    });\r\n    document.addEventListener(\"click\", () => setCoords(null));\r\n  }, []);\r\n\r\n  return coords ? (\r\n    <div\r\n      className=\"context-menu\"\r\n      style={{\r\n        top: `calc(${coords[1]}px - 2.8em)`,\r\n        left: `calc(${coords[0]}px - 1.1em)`,\r\n      }}\r\n    >\r\n      <StyleMenu\r\n        currentStyle={props.currentStyle}\r\n        doAction={(action: Action) => props.doAction(action)}\r\n        inContext={true}\r\n      />\r\n    </div>\r\n  ) : null;\r\n};\r\n\r\nexport default ContextMenu;\r\n","import React, { useRef } from \"react\";\r\n\r\n/**\r\n * Passed to [[`OverlayButton`]]\r\n */\r\ninterface OverlayButtonProps {\r\n  /**\r\n   * An `onChange` callback that is given the extracted `FileList` as {@param files} if and only if\r\n   * * it exists (is non-null), and\r\n   * * has at least one file.\r\n   * Otherwise, it is not called.\r\n   *\r\n   * Use the `onChange` attribute if you instead want the raw handler\r\n   */\r\n  acceptFiles?: (files: FileList) => void;\r\n\r\n  /**\r\n   * Your own callback so that you can record the reference {@param ref} to the input.\r\n   * That way, you can invoke `click()`, and therefore open the file dialog, programmatically.\r\n   */\r\n  captureRef?: (ref: React.RefObject<HTMLInputElement>) => void;\r\n}\r\n\r\nconst OverlayButton = ({\r\n  acceptFiles,\r\n  captureRef,\r\n  ...attrs\r\n}: OverlayButtonProps &\r\n  React.DetailedHTMLProps<\r\n    React.InputHTMLAttributes<HTMLInputElement>,\r\n    HTMLInputElement\r\n  >): JSX.Element => {\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n\r\n  captureRef?.(fileInputRef);\r\n\r\n  return (\r\n    <input\r\n      onChange={\r\n        acceptFiles === undefined\r\n          ? undefined\r\n          : (e) => {\r\n              if (e.target.files?.length) acceptFiles(e.target.files);\r\n            }\r\n      }\r\n      ref={fileInputRef}\r\n      type=\"file\"\r\n      style={{ display: \"none\" }}\r\n      {...attrs}\r\n    />\r\n  );\r\n};\r\n\r\nexport default OverlayButton;\r\n","import React, { useEffect, useState } from \"react\";\r\nimport keyboardJS from \"keyboardjs\";\r\n\r\nimport QBoard, { QBoardState } from \"../lib/qboard\";\r\nimport { Dash, Fill, Stroke } from \"../lib/styles\";\r\nimport { defaultKeys } from \"../lib/keyboard\";\r\n\r\nimport Pagination from \"./Pagination\";\r\nimport UndoRedo from \"./UndoRedo\";\r\nimport Toolbar from \"./Toolbar\";\r\nimport Stylebar from \"./Stylebar\";\r\nimport HelpModal from \"./HelpModal\";\r\nimport ContextMenu from \"./ContextMenu\";\r\nimport VirtualFileInput from \"./VirtualFileInput\";\r\n\r\nexport const enum Visibility {\r\n  None,\r\n  Condensed,\r\n  Full,\r\n}\r\n\r\nconst Overlay = ({ qboard }: { qboard: QBoard }): JSX.Element => {\r\n  const [visibility, setVisibility] = useState<Visibility>(Visibility.Full);\r\n  const [helpModalOpen, setHelpModalOpen] = useState(false);\r\n  const [isMobile, setMobility] = useState(false);\r\n\r\n  const [state, setState]: [\r\n    QBoardState,\r\n    React.Dispatch<React.SetStateAction<QBoardState>>\r\n  ] = useState<QBoardState>({\r\n    dragActive: false,\r\n    currentPage: 0,\r\n    totalPages: 0,\r\n    currentStyle: {\r\n      dash: Dash.Solid,\r\n      stroke: Stroke.Black,\r\n      fill: Fill.Transparent,\r\n    },\r\n    canUndo: false,\r\n    canRedo: false,\r\n    keyMap: defaultKeys,\r\n  });\r\n\r\n  const toggleOpen = (): void => {\r\n    setHelpModalOpen((wasOpen) => {\r\n      window.localStorage.setItem(\"helpModalOpen\", wasOpen ? \"false\" : \"true\");\r\n      return !wasOpen;\r\n    });\r\n  };\r\n\r\n  const toggleMobility = (): void => {\r\n    setMobility((wasMobile) => {\r\n      window.localStorage.setItem(\"isMobile\", wasMobile ? \"false\" : \"true\");\r\n      return !wasMobile;\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (window.localStorage.getItem(\"helpModalOpen\") !== \"false\") {\r\n      setHelpModalOpen(true);\r\n    }\r\n    if (window.localStorage.getItem(\"isMobile\") !== \"false\") {\r\n      setMobility(true);\r\n    }\r\n\r\n    qboard.callback = setState;\r\n    qboard.updateState();\r\n\r\n    keyboardJS.bind(\"tab\", () => {\r\n      setVisibility((currentVisibility) => (currentVisibility + 2) % 3);\r\n    });\r\n\r\n    keyboardJS.bind(\"1\", () => toggleOpen());\r\n    keyboardJS.bind(\"0\", () => toggleOpen());\r\n  }, []);\r\n\r\n  return (\r\n    <>\r\n      <VirtualFileInput\r\n        acceptFiles={qboard.files.acceptFile}\r\n        captureRef={(ref) => {\r\n          qboard.globalState.fileInputRef = ref;\r\n        }}\r\n        multiple\r\n        accept=\"application/json, application/pdf, image/*\"\r\n      />\r\n      <div className={`drop-area ${state.dragActive ? \"active\" : \"\"}`} />\r\n      <div className={`overlay visibility-${visibility}`}>\r\n        <Pagination\r\n          loadPage={qboard.pages.loadPage}\r\n          currentPage={state.currentPage}\r\n          totalPages={state.totalPages}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <UndoRedo\r\n          canUndo={state.canUndo}\r\n          canRedo={state.canRedo}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <Toolbar\r\n          currentTool={qboard.activeTool}\r\n          tools={qboard.tools}\r\n          doAction={qboard.action.doAction}\r\n          visibility={visibility}\r\n        />\r\n        <Stylebar\r\n          currentStyle={state.currentStyle}\r\n          doAction={qboard.action.doAction}\r\n          acceptFile={async (file) =>\r\n            qboard.history.execute(\r\n              (await qboard.files.acceptFile(file)).history\r\n            )\r\n          }\r\n          visibility={visibility}\r\n          isMobile={isMobile}\r\n        />\r\n        <HelpModal\r\n          bind={qboard.keyboard.bind}\r\n          unbind={qboard.keyboard.unbind}\r\n          reset={qboard.keyboard.reset}\r\n          keyMap={state.keyMap}\r\n          isOpen={helpModalOpen}\r\n          toggleOpen={toggleOpen}\r\n          isMobile={isMobile}\r\n          toggleMobility={toggleMobility}\r\n        />\r\n      </div>\r\n      <ContextMenu\r\n        currentStyle={state.currentStyle}\r\n        doAction={qboard.action.doAction}\r\n      />\r\n    </>\r\n  );\r\n};\r\n\r\nexport default Overlay;\r\n","import { fabric } from \"fabric\";\r\nimport Page from \"./page\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport HistoryHandler from \"./history\";\r\nimport { PathEvent, GuaranteedIObjectOptions } from \"../types/fabric\";\r\nimport AssertType from \"../types/assert\";\r\n\r\ntype Async<T = void> = T | Promise<T>;\r\n\r\nclass Behaviors {\r\n  // given the origin x, y, snaps the point x2, y2 to the nearest vector in dirs\r\n  static rectify = (\r\n    dirs: number[][],\r\n    x: number,\r\n    y: number,\r\n    x2: number,\r\n    y2: number\r\n  ): number[] => {\r\n    return dirs\r\n      .map((d) => Behaviors.project(x, y, d[0], d[1], x2, y2))\r\n      .reduce((acc, cur) => (acc[0] < cur[0] ? acc : cur));\r\n  };\r\n\r\n  // projects the point x2, y2 to the vector with origin ox, oy and direction vx, vy. returns the square distance and the coordinates of the projection.\r\n  private static project = (\r\n    ox: number,\r\n    oy: number,\r\n    vx: number,\r\n    vy: number,\r\n    x2: number,\r\n    y2: number\r\n  ): number[] => {\r\n    const x = x2 - ox;\r\n    const y = y2 - oy;\r\n    const side = vx * y - vy * x;\r\n    const sq = vx * vx + vy * vy;\r\n    return [\r\n      Math.abs(side) / sq,\r\n      ox + x + (vy * side) / sq,\r\n      oy + y - (vx * side) / sq,\r\n    ];\r\n  };\r\n}\r\n\r\nexport class Tool {\r\n  // Add type marker `boolean` so it can be overridden; otherwise takes type `false`\r\n  /**\r\n   * Make sure that no extending classes except DrawingTool set this to true;\r\n   * the value of this property is used as a type guard.\r\n   */\r\n  protected readonly _isDrawing: boolean = false;\r\n  /**\r\n   * Make sure that no extending classes except RequiresBaseTool set this to true;\r\n   * the value of this property is used as a type guard.\r\n   */\r\n  protected readonly _requiresBase: boolean = false;\r\n  /**\r\n   * Make sure that no extending classes except Brush set this to true;\r\n   * the value of this property is used as a type guard.\r\n   */\r\n  protected readonly _isBrush: boolean = false;\r\n\r\n  isDrawing(): this is DrawingTool {\r\n    return this._isDrawing;\r\n  }\r\n\r\n  requiresBase(): this is RequiresBase {\r\n    return this._requiresBase;\r\n  }\r\n\r\n  isBrush(): this is Brush {\r\n    return this._isBrush;\r\n  }\r\n\r\n  resize?: (\r\n    object: fabric.Object,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ) => Async<fabric.Object>;\r\n\r\n  /**\r\n   * Set externally from activate() and deactivate().\r\n   * Set internally (from an extending class) with setActive();\r\n   * @private\r\n   */\r\n  private active = false;\r\n\r\n  constructor(\r\n    protected baseCanvas: Page,\r\n    protected history: HistoryHandler,\r\n    protected clipboard: ClipboardHandler\r\n  ) {}\r\n\r\n  /**\r\n   * @return Whether the activation was successful.\r\n   * Maybe want to throw error instead of return boolean.\r\n   */\r\n  activate: () => Async<boolean> = () => this.setActive(true);\r\n\r\n  /**\r\n   * Not allowed to fail\r\n   */\r\n  deactivate: () => void = () => this.setActive(false);\r\n\r\n  /**\r\n   * get this.active\r\n   */\r\n  isActive = (): boolean => this.active;\r\n\r\n  /**\r\n   * set this.active active\r\n   */\r\n  protected setActive = (active: boolean): boolean => (this.active = active);\r\n}\r\n\r\nexport abstract class DrawingTool extends Tool {\r\n  _isDrawing = true;\r\n  abstract draw: (\r\n    x,\r\n    y,\r\n    options,\r\n    x2?,\r\n    y2?\r\n  ) => fabric.Object | Promise<fabric.Object>;\r\n}\r\nexport abstract class RequiresBase extends Tool {\r\n  _requiresBase = true;\r\n}\r\n\r\nexport abstract class Brush extends RequiresBase {\r\n  _isBrush = true;\r\n\r\n  /**\r\n   * Handle the pathCreated event\r\n   */\r\n  pathCreated: (e: PathEvent) => void = () => {};\r\n\r\n  setBrush: (\r\n    brush: fabric.BaseBrush,\r\n    options: GuaranteedIObjectOptions\r\n  ) => void | Promise<void> = () => {};\r\n}\r\n\r\nexport class Move extends RequiresBase {}\r\n\r\nexport class Pen extends Brush {\r\n  pathCreated = (e: PathEvent): void => {\r\n    e.path.id = this.baseCanvas.getNextId();\r\n    this.history.add([e.path]);\r\n  };\r\n  setBrush = (\r\n    brush: fabric.BaseBrush,\r\n    options: GuaranteedIObjectOptions\r\n  ): void => {\r\n    brush.color = options.stroke;\r\n    brush.strokeDashArray = options.strokeDashArray;\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class Eraser extends Brush {\r\n  pathCreated = (e: PathEvent): void => {\r\n    const path = fabric.util.object.clone(e.path);\r\n    this.baseCanvas.remove(e.path);\r\n    const objects = this.baseCanvas\r\n      .getObjects()\r\n      .filter((object) => object.intersectsWithObject(path));\r\n    if (!objects.length) return;\r\n    this.baseCanvas.remove(...objects);\r\n    this.history.remove(objects);\r\n  };\r\n\r\n  setBrush = (\r\n    brush: fabric.BaseBrush,\r\n    options: GuaranteedIObjectOptions\r\n  ): void => {\r\n    brush.color = \"#ff005455\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = 5 * options.strokeWidth;\r\n  };\r\n\r\n  /**\r\n   * Attempts to activate the current tool\r\n   *\r\n   * Default implementation:\r\n   * Execute cut() which attempts to cut currently selected objects if they exist.\r\n   * If cut() true then abort; leave current tool active.\r\n   * Otherwise, mark internal state as active and return true\r\n   *\r\n   * @return Whether it was able to successfully activate\r\n   */\r\n  activate = (): boolean => !this.clipboard.cut() && this.setActive(true);\r\n}\r\n\r\nexport class Laser extends Brush {\r\n  pathCreated = (e: PathEvent): void => {\r\n    setTimeout(() => {\r\n      this.baseCanvas.remove(e.path);\r\n      this.baseCanvas.requestRenderAll();\r\n    }, 1000);\r\n  };\r\n  setBrush = (\r\n    brush: fabric.BaseBrush,\r\n    options: GuaranteedIObjectOptions\r\n  ): void => {\r\n    brush.color = \"#f23523\";\r\n    brush.strokeDashArray = [0, 0];\r\n    brush.width = options.strokeWidth;\r\n  };\r\n}\r\n\r\nexport class Line extends DrawingTool {\r\n  x = 0;\r\n  y = 0;\r\n\r\n  dirs: number[][] = [\r\n    [1, 0],\r\n    [1, 1],\r\n    [0, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): fabric.Line => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new fabric.Line([x, y, x2, y2] as number[], {\r\n      ...options,\r\n      perPixelTargetFind: true,\r\n    });\r\n  };\r\n\r\n  resize = (\r\n    object: fabric.Object,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): fabric.Line => {\r\n    AssertType<fabric.Line>(object);\r\n\r\n    const [, x, y] = strict\r\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\r\n      : [undefined, x2, y2];\r\n    object.set({ x2: x, y2: y }).setCoords();\r\n    return object;\r\n  };\r\n}\r\n\r\nexport class Rectangle extends DrawingTool {\r\n  x = 0;\r\n  y = 0;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): fabric.Rect => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new fabric.Rect({\r\n      left: x,\r\n      top: y,\r\n      width: x2,\r\n      height: y2,\r\n      ...options,\r\n    });\r\n  };\r\n\r\n  resize = (\r\n    object: fabric.Rect,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): fabric.Rect => {\r\n    const [, x, y] = strict\r\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\r\n      : [undefined, x2, y2];\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        width: Math.abs(this.x - x),\r\n        height: Math.abs(this.y - y),\r\n      })\r\n      .setCoords();\r\n\r\n    return object;\r\n  };\r\n}\r\n\r\nexport class Ellipse extends DrawingTool {\r\n  x = 0;\r\n  y = 0;\r\n\r\n  dirs: number[][] = [\r\n    [1, 1],\r\n    [-1, 1],\r\n  ];\r\n\r\n  draw = (\r\n    x: number,\r\n    y: number,\r\n    options: fabric.IObjectOptions,\r\n    x2?: number,\r\n    y2?: number\r\n  ): fabric.Ellipse => {\r\n    this.x = x;\r\n    this.y = y;\r\n\r\n    return new fabric.Ellipse({ ...options, left: x, top: y, rx: x2, ry: y2 });\r\n  };\r\n\r\n  resize = (\r\n    object: fabric.Object,\r\n    x2: number,\r\n    y2: number,\r\n    strict: boolean\r\n  ): fabric.Ellipse => {\r\n    AssertType<fabric.Ellipse>(object);\r\n\r\n    const [, x, y] = strict\r\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\r\n      : [undefined, x2, y2];\r\n    object\r\n      .set({\r\n        originX: this.x > x ? \"right\" : \"left\",\r\n        originY: this.y > y ? \"bottom\" : \"top\",\r\n        rx: Math.abs(x - (object.left || 0)) / 2,\r\n        ry: Math.abs(y - (object.top || 0)) / 2,\r\n      })\r\n      .setCoords();\r\n\r\n    return object;\r\n  };\r\n}\r\n\r\nexport interface Tools {\r\n  Line: Line;\r\n  Ellipse: Ellipse;\r\n  Move: Move;\r\n  Laser: Laser;\r\n  Pen: Pen;\r\n  Rectangle: Rectangle;\r\n  Eraser: Eraser;\r\n}\r\n\r\nconst instantiateTools = (\r\n  baseCanvas: Page,\r\n  history: HistoryHandler,\r\n  clipboard: ClipboardHandler\r\n): Tools => ({\r\n  Move: new Move(baseCanvas, history, clipboard),\r\n  Pen: new Pen(baseCanvas, history, clipboard),\r\n  Eraser: new Eraser(baseCanvas, history, clipboard),\r\n  Laser: new Laser(baseCanvas, history, clipboard),\r\n  Line: new Line(baseCanvas, history, clipboard),\r\n  Rectangle: new Rectangle(baseCanvas, history, clipboard),\r\n  Ellipse: new Ellipse(baseCanvas, history, clipboard),\r\n});\r\n\r\nexport default instantiateTools;\r\n","import { fabric } from \"fabric\";\r\nimport { ObjectId } from \"../types/fabric\";\r\n\r\nexport type Cursor = { x: number; y: number };\r\n\r\nexport default class Page extends fabric.Canvas {\r\n  cursor: Cursor | undefined;\r\n\r\n  // assert not undefined because fitToWindow, which is called at init, sets these\r\n  canvasWidth!: number;\r\n  canvasHeight!: number;\r\n\r\n  latestId = 0;\r\n  modified = false;\r\n\r\n  fitToWindow = (canvasWidth: number, canvasHeight: number): void => {\r\n    const widthRatio = window.innerWidth / canvasWidth;\r\n    const heightRatio = window.innerHeight / canvasHeight;\r\n    this.setZoom(Math.min(widthRatio, heightRatio));\r\n    this.setWidth(canvasWidth * this.getZoom());\r\n    this.setHeight(canvasHeight * this.getZoom());\r\n    this.canvasWidth = canvasWidth;\r\n    this.canvasHeight = canvasHeight;\r\n  };\r\n\r\n  deactivateSelection = (): void => {\r\n    this.isDrawingMode = false;\r\n    this.selection = false;\r\n    this.discardActiveObject();\r\n    this.forEachObject((object) => {\r\n      object.selectable = false;\r\n    });\r\n    this.requestRenderAll();\r\n  };\r\n\r\n  activateSelection = (): void => {\r\n    this.isDrawingMode = false;\r\n    this.selection = true;\r\n    this.forEachObject((object) => {\r\n      object.selectable = true;\r\n    });\r\n  };\r\n\r\n  getNextId = (): number => {\r\n    this.latestId += 1;\r\n    return this.latestId;\r\n  };\r\n\r\n  // kind of inefficient\r\n  getObjectByIds = (ids: number[]): fabric.Object[] =>\r\n    this.getObjects().filter((object) => ids.includes((object as ObjectId).id));\r\n\r\n  serialize = (objects: fabric.Object[]): fabric.Object[] => {\r\n    const selection = this.getActiveObjects();\r\n    const reselect =\r\n      selection.length > 1 && objects.some((obj) => selection.includes(obj));\r\n    if (reselect) {\r\n      this.discardActiveObject();\r\n      this.setActiveObject(\r\n        new fabric.ActiveSelection(selection, { canvas: this })\r\n      );\r\n    }\r\n    return objects.map((obj) => obj.toObject([\"strokeUniform\"]));\r\n  };\r\n\r\n  apply = (ids: number[], newObjects: fabric.Object[] | null): void => {\r\n    const oldObjects = this.getObjectByIds(ids);\r\n    if (oldObjects.length) {\r\n      this.remove(...oldObjects);\r\n    }\r\n    if (newObjects?.length) {\r\n      const addObjects = (objects) => {\r\n        objects.forEach((object: ObjectId, i) => {\r\n          object.id = ids[i];\r\n        });\r\n        this.add(...objects);\r\n        this.requestRenderAll();\r\n      };\r\n      fabric.util.enlivenObjects(newObjects, addObjects, \"fabric\");\r\n    } else {\r\n      this.requestRenderAll();\r\n    }\r\n  };\r\n\r\n  loadFromJSONAsync = async (json: unknown): Promise<void> =>\r\n    new Promise<void>((resolve) => {\r\n      super.loadFromJSON(json, () => {\r\n        resolve();\r\n      });\r\n    });\r\n\r\n  placeObject<T extends fabric.Object>(\r\n    obj: T,\r\n    {\r\n      x = this.canvasWidth / 2,\r\n      y = this.canvasHeight / 2,\r\n    }: Partial<Cursor> = this.cursor ?? {}\r\n  ): T {\r\n    this.discardActiveObject();\r\n    const id = this.getNextId();\r\n\r\n    obj.set(({\r\n      id,\r\n      left: x,\r\n      top: y,\r\n      originX: \"center\",\r\n      originY: \"center\",\r\n    } as Partial<fabric.Object>) as Partial<T>);\r\n    this.add(obj);\r\n    this.setActiveObject(obj);\r\n    this.requestRenderAll();\r\n    return obj;\r\n  }\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nimport { HistoryCommand } from \"./history\";\r\nimport Pages, { PageJSON } from \"./pages\";\r\nimport { Cursor } from \"./page\";\r\n\r\nconst defaults = <T>(value: T | undefined, getDefaultValue: () => T) =>\r\n  value === undefined ? getDefaultValue() : value;\r\n\r\nexport class AsyncReader {\r\n  static readAsText = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result!);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsText(file);\r\n    });\r\n\r\n  static readAsDataURL = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result!);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsDataURL(file);\r\n    });\r\n}\r\n\r\n// manages version compatibility with old document formats\r\n// change the signature and usages to accommodate new data; this will fill in sample data for missing fields\r\nexport class JSONReader {\r\n  static read(json: string | ArrayBuffer): PageJSON[] {\r\n    const object = JSON.parse(json.toString());\r\n    return JSONReader.readParsed(object);\r\n  }\r\n\r\n  // FIXME: provide backwards-compatible interface as input type\r\n  // * https://github.com/cjquines/qboard/pull/118\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any,@typescript-eslint/explicit-module-boundary-types\r\n  static readParsed(object: any): PageJSON[] {\r\n    const { \"qboard-version\": version, pages } = object;\r\n    switch (version) {\r\n      case 1:\r\n        return pages;\r\n      default:\r\n        return pages;\r\n    }\r\n  }\r\n}\r\n\r\nexport class JSONWriter {\r\n  private readonly sourceJSON: {\r\n    \"qboard-version\": number;\r\n    pages: PageJSON[];\r\n  };\r\n  private asString?: string;\r\n  private asBlob?: Blob;\r\n  private asUrl?: string;\r\n\r\n  constructor(pagesJSON: PageJSON[]) {\r\n    this.sourceJSON = {\r\n      \"qboard-version\": 1,\r\n      pages: pagesJSON,\r\n    };\r\n  }\r\n\r\n  toString = (): string =>\r\n    (this.asString = defaults(this.asString, () =>\r\n      JSON.stringify(this.sourceJSON)\r\n    ));\r\n\r\n  toBlob = (): Blob =>\r\n    (this.asBlob = defaults(\r\n      this.asBlob,\r\n      () => new Blob([this.toString()], { type: \"application/json\" })\r\n    ));\r\n\r\n  toURL = (): [string, () => void] => {\r\n    this.asUrl = defaults(this.asUrl, () =>\r\n      window.URL.createObjectURL(this.toBlob())\r\n    );\r\n    const revoke = () => {\r\n      if (this.asUrl === undefined) return;\r\n\r\n      window.URL.revokeObjectURL(this.asUrl);\r\n      this.asUrl = undefined;\r\n    };\r\n    return [this.asUrl, revoke];\r\n  };\r\n\r\n  download = (filename = \"qboard-file\"): void => {\r\n    const [fileURL, revokeURL] = this.toURL();\r\n\r\n    const elt = document.createElement(\"a\");\r\n    elt.style.display = \"none\";\r\n    elt.href = fileURL;\r\n    elt.download = filename;\r\n    document.body.appendChild(elt);\r\n    elt.click();\r\n    elt.remove();\r\n\r\n    revokeURL();\r\n  };\r\n}\r\n\r\nexport type FileHandlerResponse = {\r\n  action: \"none\" | \"image\" | \"json\";\r\n  history?: HistoryCommand;\r\n};\r\n\r\nexport default class FileHandler {\r\n  constructor(public pages: Pages) {}\r\n\r\n  processFiles = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<HistoryCommand> => {\r\n    const images: fabric.Object[] = [];\r\n    await Promise.all(\r\n      [...files].map(async (file) => {\r\n        if (file.type.startsWith(\"image/\")) {\r\n          images.push(await this.handleImage(file, cursor));\r\n        }\r\n        if (file.type === \"application/json\") {\r\n          return this.handleJSON(file);\r\n        }\r\n      })\r\n    );\r\n    return {\r\n      add: images.flat(),\r\n    };\r\n  };\r\n\r\n  acceptFile = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<FileHandlerResponse> => {\r\n    if (!files.length) return { action: \"none\" };\r\n    const [file] = files;\r\n\r\n    if (file.type.startsWith(\"image/\")) {\r\n      return {\r\n        action: \"image\",\r\n        history: { add: [await this.handleImage(file, cursor)] },\r\n      };\r\n    }\r\n\r\n    if (file.type === \"application/json\") {\r\n      await this.openFile(file);\r\n      return {\r\n        action: \"json\",\r\n        history: { clear: [true] },\r\n      };\r\n    }\r\n\r\n    // unsupported file\r\n    return { action: \"none\" };\r\n  };\r\n\r\n  openFile = async (file: File): Promise<boolean> => {\r\n    this.pages.savePage();\r\n    return this.pages.overwritePages(\r\n      JSONReader.read(await AsyncReader.readAsText(file))\r\n    );\r\n  };\r\n\r\n  private handleImage = async (\r\n    file: File,\r\n    cursor?: Cursor\r\n  ): Promise<fabric.Object> =>\r\n    new Promise<fabric.Object>((resolve) =>\r\n      AsyncReader.readAsDataURL(file).then((result) =>\r\n        fabric.Image.fromURL(result.toString(), (obj: fabric.Image) => {\r\n          resolve(this.pages.canvas.placeObject(obj, cursor));\r\n        })\r\n      )\r\n    );\r\n\r\n  private handleJSON = async (file: File): Promise<number> => {\r\n    const pages = JSONReader.read(await AsyncReader.readAsText(file));\r\n    return this.pages.insertPagesAfter(pages);\r\n  };\r\n}\r\n","import pdfMake from \"pdfmake/build/pdfmake.min\";\r\nimport { fabric } from \"fabric\";\r\n\r\nimport Page from \"./page\";\r\nimport { JSONWriter } from \"./files\";\r\n\r\nexport type PageJSON = {\r\n  version: string;\r\n  objects: fabric.Object[];\r\n  background: string;\r\n};\r\n\r\nconst defaultPageJSON: PageJSON = {\r\n  version: \"4.2.0\",\r\n  objects: [],\r\n  background: \"white\",\r\n};\r\n\r\n/**\r\n * @return The current local time in the form `yyyy-mm-dd-hh-mm`\r\n */\r\nconst timeString = (): string => {\r\n  const offset = new Date().getTimezoneOffset() * 60000;\r\n  return new Date(Date.now() - offset)\r\n    .toISOString()\r\n    .slice(0, -8)\r\n    .replace(/\\D/g, \"-\");\r\n};\r\n\r\nexport default class Pages {\r\n  currentIndex = 0;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number,\r\n    public updateState: () => void,\r\n    public pagesJSON: PageJSON[] = [defaultPageJSON]\r\n  ) {}\r\n\r\n  savePage = (): void => {\r\n    this.pagesJSON[this.currentIndex] = this.canvas.toObject([\r\n      \"id\",\r\n      \"strokeUniform\",\r\n    ]);\r\n  };\r\n\r\n  /**\r\n   * Safe method to load \"move to\"/\"switch to\" a specific page in UI\r\n   * @param index The 0-based index of the page to load\r\n   * @param saveExisting\r\n   * Whether to save the contents on the current page to memory before switching pages.\r\n   * Forces an unconditional re-render when set to `false`.\r\n   * May need to set to `false` if directly manipulating the internal array to prevent an override.\r\n   * @return The index of the loaded page.\r\n   * This equals {@param index}.\r\n   */\r\n  // TODO: Should saveExisting be renamed and negated to force?\r\n  loadPage = async (index: number, saveExisting = true): Promise<number> => {\r\n    if (saveExisting) this.savePage();\r\n    if (index === this.currentIndex && saveExisting) return index;\r\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[index]);\r\n    this.currentIndex = index;\r\n    this.updateState();\r\n    return index;\r\n  };\r\n\r\n  /**\r\n   * Safely move back one page, creating a blank page if necessary.\r\n   * @return The index of the loaded page.\r\n   */\r\n  previousOrNewPage = (): Promise<number> => {\r\n    if (this.currentIndex === 0) {\r\n      return this.insertPagesBefore([defaultPageJSON], true);\r\n    }\r\n    return this.loadPage(this.currentIndex - 1);\r\n  };\r\n\r\n  /**\r\n   * Safely move forward one page, creating a blank page if necessary.\r\n   * @return The index of the loaded page.\r\n   */\r\n  nextOrNewPage = (): Promise<number> => {\r\n    if (this.currentIndex === this.pagesJSON.length - 1) {\r\n      return this.insertPagesAfter([defaultPageJSON], true);\r\n    }\r\n    return this.loadPage(this.currentIndex + 1);\r\n  };\r\n\r\n  /**\r\n   * Safely convert the existing pages to PDF, and initiate a download.\r\n   * The filename is of the form `qboard-yyyy-mm-dd-hh-mm.pdf` in local time.\r\n   */\r\n  export = async (): Promise<void> => {\r\n    this.savePage();\r\n    const ratio = 2;\r\n    const content: { svg: string; width: number }[] = [];\r\n    const currentIndexCopy = this.currentIndex;\r\n    // Load each page and then record it as svg\r\n    for (const page of this.pagesJSON) {\r\n      // As of now, each page needs to be individually loaded, so we await each load\r\n      // eslint-disable-next-line no-await-in-loop\r\n      await this.canvas.loadFromJSONAsync(page);\r\n      content.push({\r\n        svg: this.canvas.toSVG(),\r\n        width: this.canvasWidth / ratio,\r\n      });\r\n    }\r\n\r\n    const docDefinition = {\r\n      pageSize: {\r\n        width: this.canvasWidth / ratio,\r\n        height: this.canvasHeight / ratio,\r\n      },\r\n      pageMargins: [0, 0],\r\n      content,\r\n    };\r\n\r\n    pdfMake.createPdf(docDefinition).download(`qboard-${timeString()}.pdf`);\r\n\r\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[currentIndexCopy]);\r\n  };\r\n\r\n  /**\r\n   * Safely convert the existing pages to qboard JSON, and initiate a download.\r\n   * The filename is of the form `qboard-yyyy-mm-dd-hh-mm.json` in local time.\r\n   */\r\n  saveFile = (): void => {\r\n    this.savePage();\r\n    new JSONWriter(this.pagesJSON).download(`qboard-${timeString()}.json`);\r\n    this.canvas.modified = false;\r\n  };\r\n\r\n  /**\r\n   * Replace the entire board with different data,\r\n   * after prompting (window.confirm) the user for confirmation.\r\n   * @param pages an array of page data in the internal format\r\n   * @return Whether the pages were successfully overwritten.\r\n   * This is the same as whether the user accepted the prompt.\r\n   */\r\n  overwritePages = async (\r\n    pages: PageJSON[] = [defaultPageJSON]\r\n  ): Promise<boolean> => {\r\n    const response =\r\n      !this.canvas.modified ||\r\n      this.pagesJSON.every((page) => page.objects.length === 0) ||\r\n      window.confirm(\r\n        \"Your work will be overwritten. Are you sure you wish to continue?\"\r\n      );\r\n    if (!response) return false;\r\n\r\n    this.pagesJSON = pages;\r\n    await this.loadPage(0, false);\r\n    this.canvas.modified = false;\r\n    return true;\r\n  };\r\n\r\n  /**\r\n   * Add the content of {@param pages} to the pages list before the current page.\r\n   * @param isNonModifying `true` if you don't want to mark the board as modified due to this change.\r\n   * Generally set when inserting blank pages, which don't contain any objects.\r\n   */\r\n  insertPagesBefore = async (\r\n    pages: PageJSON[],\r\n    isNonModifying = false\r\n  ): Promise<number> => {\r\n    this.savePage();\r\n    this.pagesJSON.splice(this.currentIndex, 0, ...pages);\r\n    // make sure not to do\r\n    // this.canvas.modified = !isNonModifying\r\n    // because that marks an already modified board as unmodified\r\n    if (!isNonModifying) {\r\n      this.canvas.modified = true;\r\n    }\r\n    // you have already saved the pages via splice;\r\n    // if you saveExisting then you will be saving to the wrong index\r\n    return this.loadPage(this.currentIndex, false);\r\n  };\r\n\r\n  /**\r\n   * Add the content of {@param pages} to the pages list after the current page.\r\n   * @param isNonModifying `true` if you don't want to mark the board as modified due to this change.\r\n   * Generally set when inserting blank pages, which don't contain any objects.\r\n   */\r\n  insertPagesAfter = async (\r\n    pages: PageJSON[],\r\n    isNonModifying = false\r\n  ): Promise<number> => {\r\n    this.pagesJSON.splice(this.currentIndex + 1, 0, ...pages);\r\n    // make sure not to do\r\n    // this.canvas.modified = !isNonModifying\r\n    // because that marks an already modified board as unmodified\r\n    if (!isNonModifying) {\r\n      this.canvas.modified = true;\r\n    }\r\n    // you can saveExisting because you're only updating indices _after_ the current page.\r\n    // you can also saveExisting before the splice\r\n    return this.loadPage(this.currentIndex + 1, true);\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nimport Page from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport { ObjectId } from \"../types/fabric\";\r\n\r\ninterface HistoryItem {\r\n  ids: number[];\r\n  oldObjects: fabric.Object[] | null;\r\n  newObjects: fabric.Object[] | null;\r\n  page: number;\r\n}\r\n\r\nexport type HistoryCommand = {\r\n  add?: fabric.Object[];\r\n  remove?: fabric.Object[];\r\n  clear?: [boolean];\r\n};\r\n\r\nexport default class HistoryHandler {\r\n  history: HistoryItem[] = [];\r\n  redoStack: HistoryItem[] = [];\r\n  selection: fabric.Object[] | null = null;\r\n  locked = false;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public pages: Pages,\r\n    public updateState: () => void\r\n  ) {}\r\n\r\n  execute = (command: HistoryCommand = {}): void => {\r\n    if (command.clear) this.clear(command.clear[0]);\r\n    this.add(command.add);\r\n    this.remove(command.remove);\r\n  };\r\n\r\n  add = (objects?: fabric.Object[]): void => {\r\n    if (objects?.length) this.save({ newObjects: objects });\r\n  };\r\n\r\n  remove = (objects?: fabric.Object[]): void => {\r\n    if (objects?.length) this.save({ oldObjects: objects });\r\n  };\r\n\r\n  clear = (clearRedo = false): void => {\r\n    this.history = [];\r\n    if (clearRedo) this.redoStack = [];\r\n    this.updateState();\r\n  };\r\n\r\n  store = (objects: fabric.Object[]): void => {\r\n    if (this.locked) return;\r\n    this.locked = true;\r\n    this.selection = this.canvas.serialize(objects);\r\n    this.locked = false;\r\n  };\r\n\r\n  modify = (objects: fabric.Object[]): void =>\r\n    this.save({ oldObjects: this.selection, newObjects: objects });\r\n\r\n  save = ({\r\n    oldObjects,\r\n    newObjects,\r\n  }:\r\n    | { oldObjects: fabric.Object[]; newObjects? }\r\n    | {\r\n        oldObjects?;\r\n        newObjects: fabric.Object[];\r\n      }): void => {\r\n    if (this.locked) return;\r\n    const basis = newObjects || oldObjects;\r\n    this.locked = true;\r\n    this.history.push({\r\n      ids: basis.map((object) => (object as ObjectId).id),\r\n      oldObjects: newObjects ? oldObjects : this.canvas.serialize(oldObjects),\r\n      newObjects: newObjects && this.canvas.serialize(newObjects),\r\n      page: this.pages.currentIndex,\r\n    });\r\n    this.locked = false;\r\n    this.redoStack = [];\r\n    this.canvas.modified = true;\r\n    this.updateState();\r\n  };\r\n\r\n  undo = async (): Promise<void> => {\r\n    if (!this.history.length) return;\r\n    this.canvas.discardActiveObject();\r\n    await this.move(this.history, this.redoStack, true);\r\n  };\r\n\r\n  redo = async (): Promise<void> => {\r\n    if (!this.redoStack.length) return;\r\n    await this.move(this.redoStack, this.history, false);\r\n  };\r\n\r\n  private move = async (\r\n    from: HistoryItem[],\r\n    to: HistoryItem[],\r\n    isUndo: boolean\r\n  ): Promise<void> => {\r\n    if (!from.length) return;\r\n    this.locked = true;\r\n    const last = from.pop()!;\r\n    await this.pages.loadPage(last.page);\r\n    this.canvas.apply(last.ids, isUndo ? last.oldObjects : last.newObjects);\r\n    to.push(last);\r\n    this.locked = false;\r\n    this.canvas.modified = true;\r\n    this.updateState();\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\r\n\r\nimport Page from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport HistoryHandler from \"./history\";\r\n\r\nexport default class ClipboardHandler {\r\n  clipboard: fabric.Object | undefined;\r\n\r\n  constructor(\r\n    public canvas: Page,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number\r\n  ) {\r\n    document.addEventListener(\"paste\", this.pasteExternal);\r\n  }\r\n\r\n  copy = (): fabric.Object | null => {\r\n    const objects: fabric.Object = this.canvas.getActiveObject();\r\n    if (!objects) return null;\r\n    objects.clone((clone) => {\r\n      this.clipboard = clone;\r\n    });\r\n    return objects;\r\n  };\r\n\r\n  /**\r\n   * Cuts currently selected objects, if any\r\n   * @return Whether there were objects to cut\r\n   */\r\n  cut = (): boolean => {\r\n    const objects = this.copy() as fabric.ActiveSelection;\r\n    if (!objects) return false;\r\n\r\n    this.canvas.discardActiveObject();\r\n    if (objects.type === \"activeSelection\") {\r\n      objects.forEachObject((object) => {\r\n        this.canvas.remove(object);\r\n      });\r\n      this.history.remove(objects._objects);\r\n    } else {\r\n      this.canvas.remove(objects);\r\n      this.history.remove([objects]);\r\n    }\r\n    this.canvas.requestRenderAll();\r\n\r\n    return true;\r\n  };\r\n\r\n  paste = (): void => {\r\n    if (this.clipboard === undefined) return;\r\n\r\n    return this.clipboard.clone((clone) =>\r\n      this.history.add(this.canvas.placeObject(clone))\r\n    );\r\n  };\r\n\r\n  pasteExternal = async (e: ClipboardEvent): Promise<void> => {\r\n    const historyCommand = await this.files.processFiles(\r\n      e.clipboardData!.files\r\n    );\r\n    this.history.execute(historyCommand);\r\n    this.paste();\r\n  };\r\n}\r\n","import { fabric } from \"fabric\";\n\nexport const enum Dash {\n  Solid,\n  Dashed,\n  Dotted,\n}\n\nexport const enum Stroke {\n  Black = \"#000000\",\n  Blue = \"#0097f6\",\n  Green = \"#00b253\",\n  Yellow = \"#ffbf00\",\n  Orange = \"#ff2600\",\n}\n\nexport const enum Fill {\n  Transparent,\n  Solid,\n  HalfSolid,\n}\n\nexport interface Style {\n  dash: Dash;\n  stroke: Stroke;\n  fill: Fill;\n}\n\nconst dashMap = [\n  [0, 0],\n  [20, 15],\n  [5, 10],\n];\n\nexport default class StyleHandler {\n  constructor(\n    public currentStyle: Style,\n    public drawerOptions: fabric.IObjectOptions,\n    public freeDrawingBrush: fabric.BaseBrush,\n    public updateState: () => void\n  ) {}\n\n  set = (dash: Dash | null, stroke: Stroke | null, fill: Fill | null): void => {\n    if (dash !== null) {\n      this.currentStyle.dash = dash;\n      this.drawerOptions.strokeDashArray = dashMap[dash];\n      this.freeDrawingBrush.strokeDashArray = dashMap[dash];\n    }\n\n    if (stroke !== null) {\n      this.currentStyle.stroke = stroke;\n      this.drawerOptions.stroke = stroke;\n      this.freeDrawingBrush.color = stroke;\n    }\n\n    if (fill !== null) {\n      this.currentStyle.fill = fill;\n    }\n\n    if (stroke !== null || fill !== null) {\n      switch (this.currentStyle.fill) {\n        case Fill.Transparent: {\n          this.drawerOptions.fill = \"transparent\";\n          break;\n        }\n        case Fill.Solid: {\n          this.drawerOptions.fill = this.currentStyle.stroke;\n          break;\n        }\n        case Fill.HalfSolid: {\n          this.drawerOptions.fill = `${this.currentStyle.stroke}11`;\n          break;\n        }\n      }\n    }\n\n    this.updateState();\n  };\n}\n","import React from \"react\";\nimport ReactDOM from \"react-dom\";\n\nimport Overlay from \"./components/Overlay\";\nimport QBoard from \"./lib/qboard\";\n\nimport \"./main.scss\";\n\nconst qboard = new QBoard(\n  document.querySelector(\"#QBoard\"),\n  document.querySelector(\"#BaseQBoard\"),\n  1600,\n  900\n);\n\nReactDOM.render(\n  <Overlay qboard={qboard} />,\n  document.querySelector(\"#Overlay\")\n);\n","import { fabric } from \"fabric\";\r\nimport { Network } from \"@mehra/ts\";\r\n\r\nimport instantiateTools, { Tool, Tools } from \"./tools\";\r\nimport Page from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler, { JSONReader } from \"./files\";\r\nimport HistoryHandler from \"./history\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport StyleHandler, { Dash, Fill, Stroke, Style } from \"./styles\";\r\nimport ActionHandler from \"./action\";\r\nimport KeyboardHandler, { KeyMap } from \"./keyboard\";\r\nimport { HTMLChildElement } from \"../types/html\";\r\nimport {\r\n  FabricIEvent,\r\n  GuaranteedIObjectOptions,\r\n  ObjectId,\r\n  PathEvent,\r\n} from \"../types/fabric\";\r\n\r\ntype Async<T = void> = T | Promise<T>;\r\n\r\ntype FabricHandler<T extends fabric.IEvent = fabric.IEvent> = (e: T) => Async;\r\nimport AssertType from \"../types/assert\";\r\n\r\nexport interface QBoardState {\r\n  dragActive: boolean;\r\n  currentPage: number;\r\n  totalPages: number;\r\n  currentStyle: Style;\r\n  canUndo: boolean;\r\n  canRedo: boolean;\r\n  keyMap: KeyMap;\r\n}\r\n\r\nexport default class QBoard {\r\n  baseCanvas: Page;\r\n  canvas: Page;\r\n  pages: Pages;\r\n  files: FileHandler;\r\n  history: HistoryHandler;\r\n  clipboard: ClipboardHandler;\r\n  style: StyleHandler;\r\n  action: ActionHandler;\r\n  keyboard: KeyboardHandler;\r\n\r\n  tools: Tools;\r\n  activeTool: Tool;\r\n  currentStyle: Style = {\r\n    dash: Dash.Solid,\r\n    stroke: Stroke.Black,\r\n    fill: Fill.Transparent,\r\n  };\r\n  readonly drawerOptions: GuaranteedIObjectOptions = {\r\n    fill: \"transparent\",\r\n    stroke: \"#000000\",\r\n    strokeWidth: 4,\r\n    selectable: false,\r\n    strokeDashArray: [0, 0],\r\n    strokeUniform: true,\r\n  };\r\n\r\n  resizeCooldown: NodeJS.Timeout | undefined;\r\n  currentObject: fabric.Object | undefined;\r\n  dragActive = false;\r\n  isDown = false;\r\n  strict = false;\r\n  callback: ((state: QBoardState) => void) | undefined;\r\n\r\n  /**\r\n   * Intentionally mutable global state object\r\n   */\r\n  public globalState: {\r\n    /**\r\n     * A ref to the global input element used for file input\r\n     */\r\n    fileInputRef?: React.RefObject<HTMLInputElement>;\r\n  } = {};\r\n\r\n  constructor(\r\n    public canvasElement: HTMLCanvasElement & HTMLChildElement,\r\n    public baseCanvasElement: HTMLCanvasElement & HTMLChildElement,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number\r\n  ) {\r\n    const queryParams = new URLSearchParams(window.location.search);\r\n\r\n    this.baseCanvas = new Page(baseCanvasElement, {\r\n      backgroundColor: \"white\",\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n      targetFindTolerance: 15,\r\n    });\r\n    this.canvas = new Page(canvasElement, {\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n    });\r\n    this.pages = new Pages(\r\n      this.baseCanvas,\r\n      this.canvasWidth,\r\n      this.canvasHeight,\r\n      this.updateState\r\n    );\r\n\r\n    {\r\n      const jsonLink = queryParams.get(\"json\");\r\n      if (jsonLink !== null)\r\n        Network.loadJSON(jsonLink)\r\n          .then(JSONReader.readParsed)\r\n          .then(this.pages.overwritePages)\r\n          .catch(console.error);\r\n    }\r\n\r\n    this.files = new FileHandler(this.pages);\r\n    this.history = new HistoryHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.updateState\r\n    );\r\n    this.clipboard = new ClipboardHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.canvasWidth,\r\n      this.canvasHeight\r\n    );\r\n    this.style = new StyleHandler(\r\n      this.currentStyle,\r\n      this.drawerOptions,\r\n      this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n      this.updateState\r\n    );\r\n    this.tools = instantiateTools(\r\n      this.baseCanvas,\r\n      this.history,\r\n      this.clipboard\r\n    );\r\n    this.action = new ActionHandler(\r\n      this.switchTool,\r\n      this.tools,\r\n      this.currentStyle,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.clipboard,\r\n      this.style.set,\r\n      this.globalState\r\n    );\r\n    this.keyboard = new KeyboardHandler(\r\n      this.action.doAction,\r\n      (strict: boolean) => (this.strict = strict),\r\n      this.updateState\r\n    );\r\n\r\n    // an instance which has no effect (deactivate method is trivial)\r\n    this.activeTool = new Tool(this.baseCanvas, this.history, this.clipboard);\r\n    void this.switchTool();\r\n\r\n    void this.windowResize();\r\n\r\n    window.onresize = this.windowResize;\r\n    window.onbeforeunload = () => this.baseCanvas.modified || null;\r\n    {\r\n      /* eslint-disable @typescript-eslint/ban-ts-comment */\r\n      this.canvas.on(\"mouse:down\", this.mouseDown);\r\n      this.canvas.on(\"mouse:move\", this.mouseMove);\r\n      this.canvas.on(\"mouse:up\", this.mouseUp);\r\n\r\n      this.baseCanvas.on(\"dragenter\", () => this.setDragActive(true));\r\n      this.baseCanvas.on(\"dragleave\", () => this.setDragActive(false));\r\n      this.baseCanvas.on(\"drop\", this.drop);\r\n\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"path:created\", this.pathCreated);\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"selection:created\", this.selectionCreated);\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"object:modified\", this.objectModified);\r\n      this.baseCanvas.on(\"mouse:move\", this.updateCursor);\r\n      /* eslint-enable @typescript-eslint/ban-ts-comment */\r\n    }\r\n  }\r\n\r\n  updateState = (): void => {\r\n    this?.callback?.({\r\n      dragActive: this.dragActive,\r\n      currentPage: this.pages.currentIndex + 1,\r\n      totalPages: this.pages.pagesJSON.length,\r\n      currentStyle: this.currentStyle,\r\n      canUndo: this.history.history.length > 0,\r\n      canRedo: this.history.redoStack.length > 0,\r\n      keyMap: this.keyboard.keyMap,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Assumes no two instances are the same tool\r\n   */\r\n  switchTool = async (tool: Tool = this.tools.Move): Promise<void> => {\r\n    // Reference equality because of assumption\r\n    if (tool === this.activeTool || !(await tool.activate())) return;\r\n\r\n    this.activeTool.deactivate();\r\n\r\n    if (tool.isBrush() || tool.requiresBase()) {\r\n      this.baseCanvas.activateSelection();\r\n      this.canvasElement.parentElement.style.display = \"none\";\r\n    } else {\r\n      this.baseCanvas.deactivateSelection();\r\n      this.canvasElement.parentElement.style.display = \"block\";\r\n    }\r\n\r\n    if (tool.isBrush()) {\r\n      await tool.setBrush(\r\n        this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n        this.drawerOptions\r\n      );\r\n    }\r\n\r\n    this.activeTool = tool;\r\n\r\n    this.baseCanvas.isDrawingMode = this.activeTool.isBrush();\r\n\r\n    this.updateState();\r\n  };\r\n\r\n  windowResize = (): void => {\r\n    if (this.resizeCooldown !== undefined) clearTimeout(this.resizeCooldown);\r\n    this.resizeCooldown = setTimeout(() => {\r\n      this.canvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n      this.baseCanvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n    }, 100);\r\n  };\r\n\r\n  mouseDown: FabricHandler = async (e) => {\r\n    if (!this.activeTool.isDrawing()) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n    this.isDown = true;\r\n    this.currentObject = await this.activeTool.draw(x, y, this.drawerOptions);\r\n    (this.currentObject as ObjectId).id = this.baseCanvas.getNextId();\r\n    this.canvas.add(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseMove: FabricHandler = async (e) => {\r\n    if (!(this.activeTool.isDrawing() && this.isDown)) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n\r\n    if (this.currentObject !== undefined)\r\n      await this.activeTool.resize?.(this.currentObject, x, y, this.strict);\r\n\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseUp: FabricHandler = () => {\r\n    if (!this.activeTool.isDrawing()) return;\r\n\r\n    this.isDown = false;\r\n    this.baseCanvas.add(fabric.util.object.clone(this.currentObject));\r\n    this.baseCanvas.requestRenderAll();\r\n\r\n    AssertType<fabric.Object>(this.currentObject); // can do this because mouseDown sets this\r\n\r\n    this.canvas.remove(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n    this.history.add([this.currentObject]);\r\n  };\r\n\r\n  setDragActive = (state: boolean): void => {\r\n    this.dragActive = state;\r\n    this.updateState();\r\n  };\r\n\r\n  drop: FabricHandler = async (iEvent) => {\r\n    iEvent.e.stopPropagation();\r\n    iEvent.e.preventDefault();\r\n    await this.updateCursor(iEvent);\r\n    this.setDragActive(false);\r\n\r\n    const historyCommand = await this.files.processFiles(\r\n      (iEvent.e as DragEvent).dataTransfer!.files\r\n    );\r\n    this.history.execute(historyCommand);\r\n  };\r\n\r\n  pathCreated: FabricHandler<PathEvent> = (e) => {\r\n    if (this.activeTool.isBrush()) this.activeTool.pathCreated(e);\r\n  };\r\n\r\n  selectionCreated: FabricHandler<FabricIEvent> = (e) => {\r\n    if (this.history.locked) return;\r\n    return this.history.store(e.selected);\r\n  };\r\n\r\n  objectModified: FabricHandler<FabricIEvent> = (e) => {\r\n    this.history.modify(e.target._objects || [e.target]);\r\n    this.history.store(e.target._objects || [e.target]);\r\n  };\r\n\r\n  updateCursor: FabricHandler = (iEvent) => {\r\n    const { x, y } = this.baseCanvas.getPointer(iEvent.e);\r\n    this.baseCanvas.cursor = { x, y };\r\n  };\r\n}\r\n"],"sourceRoot":""}