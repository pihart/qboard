{"version":3,"sources":["webpack:///./src/lib/action.ts","webpack:///./src/lib/keyboard.ts","webpack:///./src/components/Icon.tsx","webpack:///./src/components/OverlayButton.tsx","webpack:///./src/components/Pagination.tsx","webpack:///./src/components/UndoRedo.tsx","webpack:///./src/components/Toolbar.tsx","webpack:///./src/components/ButtonRow.tsx","webpack:///./src/components/StyleMenu.tsx","webpack:///./src/components/Stylebar.tsx","webpack:///./src/components/BindingModal.tsx","webpack:///./src/components/Bindings.tsx","webpack:///./src/components/HelpModal.tsx","webpack:///./src/components/ContextMenu.tsx","webpack:///./src/components/VirtualFileInput.tsx","webpack:///./src/components/Overlay.tsx","webpack:///./src/lib/tools.ts","webpack:///./src/types/fabric.ts","webpack:///./src/lib/page.ts","webpack:///./src/lib/files.ts","webpack:///./src/lib/pages.ts","webpack:///./src/lib/history.ts","webpack:///./src/lib/clipboard.ts","webpack:///./src/lib/styles.ts","webpack:///./src/index.js","webpack:///./src/lib/qboard.ts"],"names":["Action","nameMap","previousPage","nextPage","addPageStart","addPageEnd","selectAll","duplicate","eraser","rectangle","latex","transparent","halfFilled","resetStyles","fullScreen","enterFullScreen","exitFullScreen","actionName","action","name","toUpperCase","slice","switchTool","tools","currentStyle","pages","files","history","clipboard","setStyle","globalState","doAction","this","actionMap","setDash","dash","setStroke","stroke","setFill","fill","requestTeX","async","text","window","prompt","img","canvas","addImage","encodeURIComponent","scaleX","scaleY","add","undo","redo","previousOrNewPage","nextOrNewPage","open","fileInputRef","current","click","save","saveFile","export","cut","copy","paste","deselect","discardActiveObject","requestRenderAll","setActiveObject","fabric","ActiveSelection","getObjects","move","Move","pen","Pen","Eraser","laser","Laser","line","Line","ellipse","Ellipse","Rectangle","dotted","dashed","solid","blue","green","yellow","orange","black","filled","help","toggleHelpModal","document","fullscreenElement","ExitFullScreen","EnterFullScreen","documentElement","requestFullscreen","exitFullscreen","defaultKeys","q","w","Copy","e","Blue","esc","Deselect","r","Green","a","PreviousPage","s","NextPage","d","f","Undo","g","Paste","z","ResetStyles","x","c","v","Dotted","Transparent","Dashed","HalfFilled","Black","Redo","Solid","Filled","Yellow","Orange","SelectAll","Save","Duplicate","Cut","Help","mirrorMap","tab","t","shift","b","mirror","key","setStrict","updateState","keyMap","localStorage","setItem","JSON","stringify","bindAll","value","Object","entries","bind","unbind","reset","keys","getItem","parse","values","every","fasIcon","iconName","style","className","close","transform","file","color","viewBox","width","height","marginRight","position","left","opacity","top","props","onClick","callback","backgroundColor","effect","id","place","textColor","setValue","setWidth","currentPage","toString","length","navigate","page","Number","totalPages","loadPage","visibility","AddPageStart","onSubmit","preventDefault","onChange","target","type","tabIndex","AddPageEnd","canUndo","undefined","canRedo","items","tool","map","isActive","LaTeX","cName","outerButton","actions","i","DashStyle","dashStyle","inContext","dashes","button","StrokeStyle","strokeStyle","strokes","strokeMap","FillStyle","fillStyle","fills","fileButton","fileActions","Open","Export","isFullscreen","setIsFullscreen","otherActions","Boolean","addEventListener","setAppElement","nonBinding","overlayClassName","isOpen","letter","filter","includes","HeaderKey","leftHanded","label","Key","bindingModalKeys","setBindingModalKeys","bindingModalAction","setBindingModalAction","rows","header","letters","split","getModified","modifier","keyHandler","index","reverse","keyModifier","setKeyModifier","setLeftHanded","toggleOpen","fontSize","fontWeight","marginLeft","wasLeftHanded","href","coords","setCoords","classList","contains","stopPropagation","oldCoords","clientX","clientY","acceptFiles","captureRef","attrs","ref","display","qboard","setVisibility","helpModalOpen","setHelpModalOpen","state","setState","dragActive","wasOpen","currentVisibility","VirtualFileInput","acceptFile","multiple","accept","currentTool","activeTool","execute","isMobile","keyboard","Behaviors","rectify","dirs","y","x2","y2","project","reduce","acc","cur","ox","oy","vx","vy","side","sq","Math","abs","Tool","baseCanvas","_isDrawing","_requiresBase","_isBrush","active","activate","setActive","deactivate","DrawingTool","RequiresBase","Brush","pathCreated","setBrush","path","getNextId","brush","options","strokeDashArray","strokeWidth","util","object","clone","remove","objects","intersectsWithObject","setTimeout","draw","perPixelTargetFind","resize","strict","set","Rect","originX","originY","rx","ry","isFabricCollection","obj","Canvas","latestId","modified","fitToWindow","canvasWidth","canvasHeight","widthRatio","innerWidth","heightRatio","innerHeight","setZoom","min","getZoom","setHeight","deactivateSelection","isDrawingMode","selection","forEachObject","selectable","activateSelection","getObjectByIds","ids","serialize","getActiveObjects","some","toObject","apply","newObjects","oldObjects","addObjects","forEach","enlivenObjects","loadFromJSONAsync","json","Promise","resolve","super","loadFromJSON","imageURL","cursor","Image","fromURL","placeObject","returnObjects","defaults","getDefaultValue","AsyncReader","readAsText","reject","reader","FileReader","onload","result","onerror","readAsDataURL","message","JSONReader","readParsed","isValidQboardFile","JSONWriter","pagesJSON","asString","sourceJSON","toBlob","asBlob","Blob","toURL","asUrl","URL","createObjectURL","revokeObjectURL","download","filename","fileURL","revokeURL","elt","createElement","body","appendChild","FileHandler","processFiles","images","all","startsWith","push","handleImage","handleJSON","flat","openFile","clear","savePage","overwritePages","read","then","w_i","w_c","h_i","h_c","scaleToWidth","insertPagesAfter","defaultPageJSON","version","background","timeString","offset","Date","getTimezoneOffset","now","toISOString","replace","currentIndex","saveExisting","insertPagesBefore","content","currentIndexCopy","svg","toSVG","docDefinition","pageSize","pageMargins","createPdf","confirm","isNonModifying","splice","HistoryHandler","redoStack","locked","command","clearRedo","store","modify","basis","from","to","isUndo","last","pop","activeObject","getActiveObject","pasteExternal","historyCommand","clipboardData","dashMap","StyleHandler","drawerOptions","freeDrawingBrush","canvasElement","baseCanvasElement","strokeUniform","isDown","isBrush","requiresBase","parentElement","windowResize","resizeCooldown","clearTimeout","mouseDown","isDrawing","getPointer","currentObject","mouseMove","mouseUp","setDragActive","drop","iEvent","updateCursor","dataTransfer","selectionCreated","selected","objectModified","queryParams","URLSearchParams","location","search","renderOnAddRemove","targetFindTolerance","jsonLink","get","loadJSON","catch","console","error","onresize","onbeforeunload","on","querySelector","ReactDOM","render"],"mappings":"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","file":"main.6b21a87c.js","sourcesContent":["import { fabric } from \"fabric\";\r\n\r\nimport { Tool, Tools } from \"./tools\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler from \"./files\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport HistoryHandler from \"./history\";\r\nimport { Dash, Fill, Stroke, Style } from \"./styles\";\r\nimport React from \"react\";\r\nimport TeXToSVG from \"tex-to-svg\";\r\nimport Page from \"./page\";\r\n\r\nexport enum Action {\r\n  PreviousPage = \"previousPage\",\r\n  NextPage = \"nextPage\",\r\n  AddPageStart = \"addPageStart\",\r\n  AddPageEnd = \"addPageEnd\",\r\n\r\n  Undo = \"undo\",\r\n  Redo = \"redo\",\r\n\r\n  Open = \"open\",\r\n  Save = \"save\",\r\n  Export = \"export\",\r\n  Cut = \"cut\",\r\n  Copy = \"copy\",\r\n  Paste = \"paste\",\r\n\r\n  Deselect = \"deselect\",\r\n  SelectAll = \"selectAll\",\r\n  Duplicate = \"duplicate\",\r\n\r\n  Move = \"move\",\r\n  Pen = \"pen\",\r\n  Eraser = \"eraser\",\r\n  Laser = \"laser\",\r\n  Line = \"line\",\r\n  Ellipse = \"ellipse\",\r\n  Rectangle = \"rectangle\",\r\n  LaTeX = \"latex\",\r\n\r\n  Dotted = \"dotted\",\r\n  Dashed = \"dashed\",\r\n  Solid = \"solid\",\r\n\r\n  Black = \"black\",\r\n  Blue = \"blue\",\r\n  Green = \"green\",\r\n  Orange = \"orange\",\r\n  Yellow = \"yellow\",\r\n\r\n  Transparent = \"transparent\",\r\n  HalfFilled = \"halfFilled\",\r\n  Filled = \"filled\",\r\n\r\n  Help = \"help\",\r\n  ResetStyles = \"resetStyles\",\r\n  FullScreen = \"fullScreen\",\r\n  EnterFullScreen = \"enterFullScreen\",\r\n  ExitFullScreen = \"exitFullScreen\",\r\n}\r\n\r\nconst nameMap = {\r\n  previousPage: \"–Page\",\r\n  nextPage: \"+Page\",\r\n  addPageStart: \"-Page\",\r\n  addPageEnd: \"+Page\",\r\n  selectAll: \"Select All\",\r\n  duplicate: \"Clone\",\r\n  eraser: \"Cut / Eraser\",\r\n  rectangle: \"Rect.\",\r\n  latex: \"LaTeX\",\r\n  transparent: \"Unfilled\",\r\n  halfFilled: \"Half Fill\",\r\n  resetStyles: \"Reset Styles\",\r\n  fullScreen: \"Full Screen\",\r\n  enterFullScreen: \"Enter Full Screen\",\r\n  exitFullScreen: \"Exit Full Screen\",\r\n};\r\n\r\nexport const actionName = (action: Action): string => {\r\n  const name = nameMap[action] || action;\r\n  return name && name[0].toUpperCase() + name.slice(1);\r\n};\r\n\r\nexport default class ActionHandler {\r\n  canvas: Page;\r\n  readonly actionMap: Record<Action, () => void>;\r\n\r\n  constructor(\r\n    public switchTool: (tool: Tool) => void,\r\n    tools: Tools,\r\n    public currentStyle: Style,\r\n    public pages: Pages,\r\n    public files: FileHandler,\r\n    public history: HistoryHandler,\r\n    public clipboard: ClipboardHandler,\r\n    public setStyle: (\r\n      dash: Dash | null,\r\n      stroke: Stroke | null,\r\n      fill: Fill | null\r\n    ) => void,\r\n    /**\r\n     * Intentionally mutable global state object\r\n     */\r\n    private globalState: {\r\n      /**\r\n       * A ref to the global input element used for file input\r\n       *\r\n       * Readonly because we ourselves don't mutate this\r\n       */\r\n      readonly fileInputRef?: React.RefObject<HTMLInputElement>;\r\n      readonly toggleHelpModal?: () => void;\r\n    }\r\n  ) {\r\n    this.canvas = this.pages.canvas;\r\n\r\n    this.actionMap = {\r\n      previousPage: pages.previousOrNewPage,\r\n      nextPage: pages.nextOrNewPage,\r\n      addPageStart: pages.previousOrNewPage,\r\n      addPageEnd: pages.nextOrNewPage,\r\n\r\n      undo: history.undo,\r\n      redo: history.redo,\r\n\r\n      open: () => globalState.fileInputRef?.current?.click(),\r\n      save: pages.saveFile,\r\n      export: pages.export,\r\n      cut: clipboard.cut,\r\n      copy: clipboard.copy,\r\n      paste: clipboard.paste,\r\n\r\n      deselect: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      selectAll: () => {\r\n        this.canvas.discardActiveObject();\r\n        this.canvas.setActiveObject(\r\n          new fabric.ActiveSelection(this.canvas.getObjects(), {\r\n            canvas: this.canvas,\r\n          })\r\n        );\r\n        this.canvas.requestRenderAll();\r\n      },\r\n      duplicate: () => {\r\n        this.clipboard.copy();\r\n        this.clipboard.paste();\r\n      },\r\n\r\n      move: () => this.switchTool(tools.Move),\r\n      pen: () => this.switchTool(tools.Pen),\r\n      eraser: () => this.switchTool(tools.Eraser),\r\n      laser: () => this.switchTool(tools.Laser),\r\n      line: () => this.switchTool(tools.Line),\r\n      ellipse: () => this.switchTool(tools.Ellipse),\r\n      rectangle: () => this.switchTool(tools.Rectangle),\r\n      latex: this.requestTeX,\r\n\r\n      dotted: () => this.setDash(Dash.Dotted),\r\n      dashed: () => this.setDash(Dash.Dashed),\r\n      solid: () => this.setDash(Dash.Solid),\r\n\r\n      blue: () => this.setStroke(Stroke.Blue),\r\n      green: () => this.setStroke(Stroke.Green),\r\n      yellow: () => this.setStroke(Stroke.Yellow),\r\n      orange: () => this.setStroke(Stroke.Orange),\r\n      black: () => this.setStroke(Stroke.Black),\r\n\r\n      transparent: () => this.setFill(Fill.Transparent),\r\n      halfFilled: () => this.setFill(Fill.HalfSolid),\r\n      filled: () => this.setFill(Fill.Solid),\r\n\r\n      resetStyles: () =>\r\n        this.setStyle(Dash.Solid, Stroke.Black, Fill.Transparent),\r\n      help: () => globalState.toggleHelpModal?.(),\r\n      fullScreen: () =>\r\n        this.doAction(\r\n          !document.fullscreenElement\r\n            ? Action.EnterFullScreen\r\n            : Action.ExitFullScreen\r\n        ),\r\n      enterFullScreen: () => document.documentElement.requestFullscreen(),\r\n      exitFullScreen: () => document.exitFullscreen(),\r\n    };\r\n  }\r\n\r\n  doAction = (action: Action): void => this.actionMap[action]();\r\n\r\n  setDash = (dash: Dash): void => {\r\n    if (dash === this.currentStyle.dash) {\r\n      this.setStyle(Dash.Solid, null, null);\r\n    } else {\r\n      this.setStyle(dash, null, null);\r\n    }\r\n  };\r\n\r\n  setStroke = (stroke: Stroke): void => {\r\n    if (stroke === this.currentStyle.stroke) {\r\n      this.setStyle(null, Stroke.Black, null);\r\n    } else {\r\n      this.setStyle(null, stroke, null);\r\n    }\r\n  };\r\n\r\n  setFill = (fill: Fill): void => {\r\n    if (fill === this.currentStyle.fill) {\r\n      this.setStyle(null, null, Fill.Transparent);\r\n    } else {\r\n      this.setStyle(null, null, fill);\r\n    }\r\n  };\r\n\r\n  requestTeX = async (): Promise<void> => {\r\n    const text = window.prompt(\"Enter LaTeX source\");\r\n    if (text === null) return;\r\n\r\n    const img = await this.canvas.addImage(\r\n      `data:image/svg+xml,${encodeURIComponent(TeXToSVG(`\\\\text{${text}}`))}`,\r\n      {},\r\n      { scaleX: 3, scaleY: 3 }\r\n    );\r\n    this.history.add([img]);\r\n\r\n    // apparently this does something?\r\n    await this.history.undo();\r\n    await this.history.redo();\r\n  };\r\n}\r\n","import keyboardJS from \"keyboardjs\";\n\nimport { Action } from \"./action\";\n\nexport type KeyMap = {\n  [key: string]: Action;\n};\n\nexport type MirrorMap = {\n  [key: string]: string;\n};\n\nexport const defaultKeys: KeyMap = {\n  q: Action.Laser,\n  w: Action.Copy,\n  e: Action.Blue,\n  esc: Action.Deselect,\n  r: Action.Green,\n  a: Action.PreviousPage,\n  s: Action.NextPage,\n  d: Action.Pen,\n  f: Action.Undo,\n  g: Action.Paste,\n  z: Action.ResetStyles,\n  x: Action.Eraser,\n  c: Action.Line,\n  v: Action.Move,\n\n  \"shift + q\": Action.Dotted,\n  \"shift + w\": Action.Transparent,\n  \"shift + e\": Action.Ellipse,\n  \"shift + r\": Action.Rectangle,\n  \"shift + a\": Action.Dashed,\n  \"shift + s\": Action.HalfFilled,\n  \"shift + d\": Action.Black,\n  \"shift + f\": Action.Redo,\n  \"shift + z\": Action.Solid,\n  \"shift + x\": Action.Filled,\n  \"shift + c\": Action.Yellow,\n  \"shift + v\": Action.Orange,\n\n  \"ctrl + a\": Action.SelectAll,\n  \"ctrl + s\": Action.Save,\n  \"ctrl + d\": Action.Duplicate,\n  \"ctrl + z\": Action.Undo,\n  \"ctrl + x\": Action.Cut,\n  \"ctrl + c\": Action.Copy,\n\n  \"1\": Action.Help,\n  \"0\": Action.Help,\n  \"/\": Action.Help,\n  \"shift + /\": Action.Help,\n};\n\nconst mirrorMap: MirrorMap = {\n  tab: \"[\",\n  q: \"p\",\n  w: \"o\",\n  e: \"i\",\n  r: \"u\",\n  t: \"y\",\n  esc: \"'\",\n  a: \";\",\n  s: \"l\",\n  d: \"k\",\n  f: \"j\",\n  g: \"h\",\n  shift: \"shift\",\n  z: \"/\",\n  x: \".\",\n  c: \",\",\n  v: \"m\",\n  b: \"n\",\n};\n\nexport const mirror = (key: string): string => {\n  return mirrorMap[key] || key.slice(0, -1) + mirrorMap[key.slice(-1)];\n};\n\nexport default class KeyboardHandler {\n  keyMap: KeyMap = {};\n\n  constructor(\n    public doAction: (action: Action) => void,\n    public setStrict: (strict: boolean) => void,\n    public updateState: () => void\n  ) {\n    keyboardJS.bind(\n      \"shift\",\n      () => {\n        this.setStrict(true);\n      },\n      () => {\n        this.setStrict(false);\n      }\n    );\n\n    const keyMap = window.localStorage.getItem(\"keyMap\");\n    if (keyMap === null) {\n      this.reset();\n    } else {\n      this.keyMap = JSON.parse(keyMap);\n      this.bindAll();\n\n      // for backwards compatibility, ensure help is bound\n      if (\n        Object.values(this.keyMap).every((action) => action !== Action.Help)\n      ) {\n        this.bind(\"0\", Action.Help);\n        this.bind(\"1\", Action.Help);\n        this.bind(\"/\", Action.Help);\n        this.bind(\"shift + /\", Action.Help);\n      }\n    }\n  }\n\n  save = (): void => {\n    window.localStorage.setItem(\"keyMap\", JSON.stringify(this.keyMap));\n  };\n\n  bindAll = (): void => {\n    for (const [key, value] of Object.entries(this.keyMap)) {\n      this.bind(key, value);\n    }\n    this.updateState();\n  };\n\n  unbind = (key: string): void => {\n    delete this.keyMap[key];\n    keyboardJS.unbind(key);\n    keyboardJS.unbind(mirror(key));\n    this.updateState();\n    this.save();\n  };\n\n  bind = (key: string, action: Action): void => {\n    this.keyMap[key] = action;\n    keyboardJS.bind(key, () => this.doAction(this.keyMap[key]));\n    keyboardJS.bind(mirror(key), () => this.doAction(this.keyMap[key]));\n    this.updateState();\n    this.save();\n  };\n\n  reset = (): void => {\n    for (const key of Object.keys(this.keyMap)) {\n      keyboardJS.unbind(key);\n      keyboardJS.unbind(mirror(key));\n    }\n    this.keyMap = { ...defaultKeys };\n    this.bindAll();\n    this.save();\n  };\n}\n","import React, { CSSProperties } from \"react\";\r\n\r\nimport { Stroke } from \"../lib/styles\";\r\nimport { Action } from \"../lib/action\";\r\n\r\nconst fasIcon = (iconName: string, style?: CSSProperties) => (\r\n  <i className={`fas fa-${iconName}`} style={style} />\r\n);\r\n\r\nconst Icon: Record<Action, JSX.Element> & Record<string, JSX.Element> = {\r\n  close: fasIcon(\"times-circle\"),\r\n\r\n  previousPage: fasIcon(\"caret-left\"),\r\n  nextPage: fasIcon(\"caret-right\"),\r\n  addPageStart: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\r\n  addPageEnd: fasIcon(\"plus\", { transform: \"scale(0.7)\" }),\r\n\r\n  undo: fasIcon(\"undo\"),\r\n  redo: fasIcon(\"redo\"),\r\n\r\n  move: fasIcon(\"mouse-pointer\"),\r\n  pen: fasIcon(\"pen\"),\r\n  eraser: fasIcon(\"eraser\"),\r\n  laser: fasIcon(\"asterisk\"),\r\n  line: fasIcon(\"minus\", { transform: \"rotate(-45deg)\" }),\r\n  ellipse: fasIcon(\"circle\"),\r\n  rectangle: fasIcon(\"square\"),\r\n  latex: fasIcon(\"font\"),\r\n\r\n  file: fasIcon(\"file\"),\r\n  open: fasIcon(\"folder-open\"),\r\n  save: fasIcon(\"save\"),\r\n  export: fasIcon(\"file-export\"),\r\n  cut: fasIcon(\"cut\"),\r\n  copy: fasIcon(\"copy\"),\r\n  paste: fasIcon(\"paste\"),\r\n\r\n  duplicate: fasIcon(\"clone\"),\r\n\r\n  help: fasIcon(\"question\"),\r\n  fullScreen: fasIcon(\"expand\"),\r\n  enterFullScreen: fasIcon(\"expand\"),\r\n  exitFullScreen: fasIcon(\"compress\"),\r\n\r\n  black: fasIcon(\"circle\", { color: Stroke.Black }),\r\n  blue: fasIcon(\"circle\", { color: Stroke.Blue }),\r\n  green: fasIcon(\"circle\", { color: Stroke.Green }),\r\n  orange: fasIcon(\"circle\", { color: Stroke.Orange }),\r\n  yellow: fasIcon(\"circle\", { color: Stroke.Yellow }),\r\n\r\n  dotted: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  dashed: (\r\n    <svg viewBox=\"0 0 21 21\" style={{ width: \"1em\", height: \"1.1em\" }}>\r\n      <g transform=\"translate(-90 -1158)\">\r\n        <g>\r\n          <path d=\"M101,1176.92v2.021c1.735-0.192,3.319-0.878,4.613-1.913l-1.43-1.43C103.269,1176.284,102.183,1176.75,101,1176.92z\" />\r\n          <path d=\"M93.08,1171h-2.021c0.191,1.735,0.879,3.319,1.914,4.614l1.43-1.43C93.716,1173.269,93.25,1172.183,93.08,1171z\" />\r\n          <path d=\"M104.184,1164.401l1.43-1.43c-1.294-1.035-2.878-1.721-4.613-1.913v2.021    C102.184,1163.25,103.27,1163.716,104.184,1164.401z\" />\r\n          <path d=\"M106.92,1169h2.021c-0.191-1.735-0.879-3.319-1.914-4.614l-1.43,1.43C106.284,1166.731,106.75,1167.817,106.92,1169z\" />\r\n          <path d=\"M95.816,1175.599l-1.43,1.43c1.294,1.035,2.878,1.721,4.613,1.913v-2.021C97.816,1176.75,96.73,1176.284,95.816,1175.599z\" />\r\n          <path d=\"M94.401,1165.815l-1.429-1.43c-1.036,1.295-1.723,2.879-1.914,4.614h2.021    C93.25,1167.817,93.716,1166.731,94.401,1165.815z\" />\r\n          <path d=\"M99,1163.08v-2.021c-1.735,0.192-3.319,0.878-4.613,1.913l1.43,1.43C96.731,1163.716,97.817,1163.25,99,1163.08z\" />\r\n          <path d=\"M106.92,1171c-0.17,1.183-0.636,2.269-1.322,3.185l1.43,1.43c1.036-1.295,1.723-2.879,1.914-4.614H106.92z\" />\r\n        </g>\r\n      </g>\r\n    </svg>\r\n  ),\r\n  solid: <i className=\"far fa-circle\" />,\r\n\r\n  transparent: <i className=\"far fa-circle\" />,\r\n  halfFilled: (\r\n    <div style={{ height: \"0.7em\", marginRight: \"1em\", position: \"relative\" }}>\r\n      <i\r\n        className=\"fas fa-circle\"\r\n        style={{ left: \"50%\", opacity: 0.3, position: \"absolute\", top: 0 }}\r\n      />\r\n      <i\r\n        className=\"far fa-circle\"\r\n        style={{ left: \"50%\", position: \"absolute\", top: 0 }}\r\n      />\r\n    </div>\r\n  ),\r\n  filled: fasIcon(\"circle\"),\r\n\r\n  deselect: fasIcon(\"object-ungroup\"),\r\n  resetStyles: fasIcon(\"remove-format\"),\r\n  selectAll: fasIcon(\"object-group\"),\r\n};\r\n\r\nexport default Icon;\r\n","import React from \"react\";\nimport ReactTooltip from \"react-tooltip\";\n\nimport { Action, actionName } from \"../lib/action\";\n\nimport Icon from \"./Icon\";\n\nconst OverlayButton = (props: {\n  action: Action;\n  callback: (action: Action) => void;\n  className?: string;\n}): JSX.Element => {\n  return (\n    <>\n      <button\n        className={props.className}\n        data-tip\n        data-for={props.action}\n        onClick={() => props.callback(props.action)}\n      >\n        {Icon[props.action]}\n      </button>\n      <ReactTooltip\n        backgroundColor=\"#ddd\"\n        effect=\"solid\"\n        id={props.action}\n        place=\"right\"\n        textColor=\"#262626\"\n      >\n        {actionName(props.action)}\n      </ReactTooltip>\n    </>\n  );\n};\n\nexport default OverlayButton;\n","import React, { useEffect, useState } from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport OverlayButton from \"./OverlayButton\";\n\nconst Pagination = (props: {\n  loadPage: (index: number) => Promise<void | number>;\n  currentPage: number;\n  totalPages: number;\n  doAction: (action: Action) => void;\n  visibility: Visibility;\n}): JSX.Element => {\n  const [value, setValue] = useState(0);\n  const [width, setWidth] = useState(\"0.6em\");\n\n  useEffect(() => {\n    setValue(props.currentPage);\n    setWidth(`${0.6 * props.currentPage.toString().length}em`);\n  }, [props]);\n\n  const navigate = async () => {\n    if (!value) return;\n    const page = Number(value);\n    if (!page || page > props.totalPages) {\n      setValue(props.currentPage);\n    } else {\n      await props.loadPage(page - 1);\n    }\n  };\n\n  useEffect(() => void navigate(), [value]);\n\n  const onSubmit = (e) => {\n    e?.preventDefault();\n    return navigate();\n  };\n\n  const onChange = (e) => setValue(e.target.value);\n\n  return (\n    <div className={`pagination visibility-${props.visibility}`}>\n      <OverlayButton\n        action={\n          props.currentPage === 1 ? Action.AddPageStart : Action.PreviousPage\n        }\n        callback={props.doAction}\n      />\n      <form onSubmit={onSubmit}>\n        <input\n          onChange={onChange}\n          type=\"text\"\n          value={value}\n          style={{ width }}\n          tabIndex={-1}\n        />\n      </form>\n      <span className=\"total-pages\"> / {props.totalPages}</span>\n      <OverlayButton\n        action={\n          props.currentPage === props.totalPages\n            ? Action.AddPageEnd\n            : Action.NextPage\n        }\n        callback={props.doAction}\n      />\n    </div>\n  );\n};\n\nexport default Pagination;\n","import React from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport OverlayButton from \"./OverlayButton\";\n\nconst UndoRedo = (props: {\n  canUndo: boolean;\n  canRedo: boolean;\n  doAction: (action: Action) => void;\n  visibility: Visibility;\n}): JSX.Element => {\n  return (\n    <div className={`undoredo visibility-${props.visibility}`}>\n      <OverlayButton\n        action={Action.Undo}\n        callback={props.doAction}\n        className={props.canUndo ? undefined : \"disabled\"}\n      />\n      <OverlayButton\n        action={Action.Redo}\n        callback={props.doAction}\n        className={props.canRedo ? undefined : \"disabled\"}\n      />\n    </div>\n  );\n};\n\nexport default UndoRedo;\n","import React from \"react\";\n\nimport { Action } from \"../lib/action\";\nimport { Tool, Tools } from \"../lib/tools\";\n\nimport { Visibility } from \"./Overlay\";\nimport OverlayButton from \"./OverlayButton\";\n\nconst Toolbar = (props: {\n  currentTool: Tool;\n  tools: Tools;\n  doAction: (action: Action) => void;\n  visibility: Visibility;\n}): JSX.Element => {\n  const items = [\n    { tool: props.tools.Move, action: Action.Move },\n    { tool: props.tools.Pen, action: Action.Pen },\n    { tool: props.tools.Eraser, action: Action.Eraser },\n    { tool: props.tools.Laser, action: Action.Laser },\n    { tool: props.tools.Line, action: Action.Line },\n    { tool: props.tools.Rectangle, action: Action.Rectangle },\n    { tool: props.tools.Ellipse, action: Action.Ellipse },\n  ];\n\n  return (\n    <div className={`toolbar visibility-${props.visibility}`}>\n      {items.map(({ tool, action }) => (\n        <OverlayButton\n          action={action}\n          callback={props.doAction}\n          className={tool.isActive() ? \"active\" : undefined}\n          key={action}\n        />\n      ))}\n      <OverlayButton\n        action={Action.LaTeX}\n        callback={props.doAction}\n        // className={}\n      />\n    </div>\n  );\n};\n\nexport default Toolbar;\n","import React, { ReactNode } from \"react\";\n\nimport { Action } from \"../lib/action\";\n\nimport OverlayButton from \"./OverlayButton\";\n\nconst ButtonRow = (props: {\n  actions: Action[];\n  callback: (action: Action) => void;\n  className?: (action: Action, i: number) => undefined | string;\n  cName?: string;\n  outerButton?: boolean | ReactNode;\n}): JSX.Element => {\n  return (\n    <div\n      className={`button-row ${props.cName} ${\n        props.outerButton ? \"button-row-hover\" : \"\"\n      }`}\n    >\n      {props.outerButton}\n      <div className=\"button-row-inner\">\n        {props.actions.map((action, i) => (\n          <OverlayButton\n            action={action}\n            className={props.className?.(action, i)}\n            callback={props.callback}\n            key={action}\n          />\n        ))}\n      </div>\n    </div>\n  );\n};\n\nexport default ButtonRow;\n","import React from \"react\";\n\nimport { Dash, Fill, Stroke, Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport Icon from \"./Icon\";\nimport ButtonRow from \"./ButtonRow\";\n\ntype StyleOptions = {\n  callback: (action: Action) => void;\n  inContext?: boolean;\n};\n\nconst DashStyle = ({\n  dashStyle,\n  callback,\n  inContext = false,\n}: StyleOptions & { dashStyle: Dash }) => {\n  const dashes = [Action.Solid, Action.Dashed, Action.Dotted];\n  const button = (\n    <button className=\"inactive\">{Icon[dashes[dashStyle]]}</button>\n  );\n\n  return (\n    <ButtonRow\n      actions={dashes}\n      className={(action, i) => {\n        if (inContext && dashStyle === i) return \"active\";\n      }}\n      callback={callback}\n      outerButton={!inContext && button}\n    />\n  );\n};\n\nconst StrokeStyle = ({\n  strokeStyle,\n  callback,\n  inContext = false,\n}: StyleOptions & {\n  strokeStyle: string;\n}): JSX.Element => {\n  const strokes = [\n    Action.Black,\n    Action.Blue,\n    Action.Green,\n    Action.Yellow,\n    Action.Orange,\n  ];\n  const strokeMap = [\n    Stroke.Black,\n    Stroke.Blue,\n    Stroke.Green,\n    Stroke.Yellow,\n    Stroke.Orange,\n  ];\n  const button = (\n    <button className=\"inactive\">\n      <i className=\"fas fa-circle\" style={{ color: strokeStyle }} />\n    </button>\n  );\n\n  return (\n    <ButtonRow\n      actions={strokes}\n      className={(action, i) => {\n        if (inContext && strokeStyle === strokeMap[i]) return \"active\";\n      }}\n      callback={callback}\n      outerButton={!inContext && button}\n    />\n  );\n};\n\nconst FillStyle = ({\n  fillStyle,\n  callback,\n  inContext = false,\n}: StyleOptions & {\n  fillStyle: Fill;\n}): JSX.Element => {\n  const fills = [Action.Transparent, Action.Filled, Action.HalfFilled];\n  const button = <button className=\"inactive\">{Icon[fills[fillStyle]]}</button>;\n\n  return (\n    <ButtonRow\n      actions={fills}\n      className={(action, i) => {\n        if (inContext && fillStyle === i) return \"active\";\n      }}\n      callback={callback}\n      outerButton={!inContext && button}\n    />\n  );\n};\n\nconst StyleMenu = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => void;\n  inContext?: boolean;\n}): JSX.Element => {\n  return (\n    <>\n      <DashStyle\n        dashStyle={props.currentStyle.dash}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n      <StrokeStyle\n        strokeStyle={props.currentStyle.stroke}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n      <FillStyle\n        fillStyle={props.currentStyle.fill}\n        callback={props.doAction}\n        inContext={props.inContext}\n      />\n    </>\n  );\n};\n\nexport default StyleMenu;\n","import React, { useEffect, useState } from \"react\";\n\nimport { Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport { Visibility } from \"./Overlay\";\nimport ButtonRow from \"./ButtonRow\";\nimport Icon from \"./Icon\";\nimport StyleMenu from \"./StyleMenu\";\n\nconst Stylebar = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => void;\n  acceptFile: (files: FileList) => Promise<void | void[]>;\n  visibility: Visibility;\n  isMobile: boolean;\n}): JSX.Element => {\n  const fileButton = <button className=\"inactive\">{Icon.file}</button>;\n  const fileActions = [Action.Open, Action.Save, Action.Export];\n\n  const [isFullscreen, setIsFullscreen] = useState(false);\n\n  const otherActions = [\n    Action.Copy,\n    Action.Paste,\n    Action.Help,\n    !isFullscreen ? Action.EnterFullScreen : Action.ExitFullScreen,\n  ];\n\n  useEffect(() => {\n    setIsFullscreen(Boolean(document.fullscreenElement));\n    document.addEventListener(\"fullscreenchange\", () =>\n      setIsFullscreen(Boolean(document.fullscreenElement))\n    );\n  }, []);\n\n  return (\n    <div className={`stylebar visibility-${props.visibility}`}>\n      <ButtonRow\n        actions={fileActions}\n        callback={props.doAction}\n        cName=\"file-actions\"\n        outerButton={fileButton}\n      />\n      <StyleMenu currentStyle={props.currentStyle} doAction={props.doAction} />\n      <ButtonRow\n        actions={otherActions}\n        cName=\"other-actions vertical\"\n        callback={props.doAction}\n      />\n    </div>\n  );\n};\n\nexport default Stylebar;\n","import React from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action, actionName } from \"../lib/action\";\n\nimport Icon from \"./Icon\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst nonBinding: Action[] = [\n  Action.AddPageStart,\n  Action.AddPageEnd,\n  Action.EnterFullScreen,\n  Action.ExitFullScreen,\n];\n\nconst BindingModal = (props: {\n  letter: string;\n  action: Action | null;\n  close: () => void;\n  callback: (action: Action | null) => void;\n}): Partial<Modal> & JSX.Element => (\n  <Modal\n    className=\"modal\"\n    overlayClassName=\"modal-overlay binding-modal\"\n    isOpen={props.letter !== \"\"}\n  >\n    <button className=\"close\" onClick={() => props.close()}>\n      {Icon.close}\n    </button>\n    <p>\n      Changing <span className=\"binding\">{props.letter}</span> binding…\n    </p>\n    <div className=\"tools\">\n      <button\n        className={props.action === undefined ? \"active\" : undefined}\n        onClick={() => props.callback(null)}\n      >\n        <span style={{ left: \"0.25em\" }}>none</span>\n      </button>\n      {Object.values(Action)\n        .filter((action) => !nonBinding.includes(action))\n        .map((action) => (\n          <button\n            key={action}\n            className={props.action === action ? \"active\" : undefined}\n            onClick={() => props.callback(action)}\n          >\n            {Icon[action]}\n            <span style={Icon[action] ? {} : { left: \"0.25em\" }}>\n              {actionName(action)}\n            </span>\n          </button>\n        ))}\n    </div>\n  </Modal>\n);\n\nexport default BindingModal;\n","import React, { useState } from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action, actionName } from \"../lib/action\";\nimport { KeyMap, mirror } from \"../lib/keyboard\";\n\nimport Icon from \"./Icon\";\nimport BindingModal from \"./BindingModal\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst HeaderKey = (props: {\n  letter: string;\n  label?: string;\n  width: string;\n  leftHanded: boolean;\n}) => {\n  return (\n    <div className=\"key\" style={{ width: props.width }}>\n      <span className=\"letter\">\n        {props.leftHanded ? mirror(props.letter) : props.letter}\n      </span>\n      <div className=\"action\">\n        <span className=\"unassigned\">{props.label || \"\"}</span>\n      </div>\n    </div>\n  );\n};\n\nconst Key = (props: {\n  letter: string;\n  action?: Action;\n  callback: (key: string) => void;\n  leftHanded: boolean;\n}) => {\n  return (\n    <button className=\"key\" onClick={() => props.callback(props.letter)}>\n      <div className=\"action\">\n        {props.action && Icon[props.action]}\n        <span className={props.action === undefined ? \"unassigned\" : undefined}>\n          {props.action === undefined ? \"none\" : actionName(props.action)}\n        </span>\n      </div>\n      <span className=\"letter\">\n        {props.leftHanded ? mirror(props.letter) : props.letter}\n      </span>\n    </button>\n  );\n};\n\nconst Bindings = (props: {\n  bind: (key: string, action: Action) => void;\n  unbind: (key: string) => void;\n  keyMap: KeyMap;\n  modifier: string;\n  leftHanded: boolean;\n}): JSX.Element => {\n  const [bindingModalKeys, setBindingModalKeys]: [\n    string,\n    React.Dispatch<React.SetStateAction<string>>\n  ] = useState<string>(\"\");\n  const [bindingModalAction, setBindingModalAction] = useState<Action | null>(\n    null\n  );\n\n  const rows = [\n    {\n      header: (\n        <HeaderKey\n          letter=\"tab\"\n          label=\"Hide Toolbar\"\n          width=\"4.5em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"qwert\".split(\"\"),\n    },\n    {\n      header: (\n        <HeaderKey\n          letter=\"esc\"\n          label=\"Deselect\"\n          width=\"6em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"asdfg\".split(\"\"),\n    },\n    {\n      header: (\n        <HeaderKey\n          letter=\"shift\"\n          label=\"Snap\"\n          width=\"7.5em\"\n          leftHanded={props.leftHanded}\n        />\n      ),\n      letters: \"zxcvb\".split(\"\"),\n    },\n  ];\n\n  const getModified = (letter: string): string =>\n    props.modifier === \"\" ? letter : `${props.modifier} + ${letter}`;\n\n  const keyHandler = (letter: string): void => {\n    setBindingModalKeys(getModified(letter));\n    setBindingModalAction(props.keyMap[getModified(letter)]);\n  };\n\n  return (\n    <>\n      <div className=\"bindings\">\n        {rows.map(({ header, letters }, index) => (\n          <div className={`row ${props.leftHanded ? \"left\" : \"\"}`} key={index}>\n            {!props.leftHanded && header}\n            {(props.leftHanded ? letters.reverse() : letters).map((letter) => (\n              <Key\n                key={letter}\n                letter={letter}\n                action={props.keyMap[getModified(letter)]}\n                callback={keyHandler}\n                leftHanded={props.leftHanded}\n              />\n            ))}\n            {props.leftHanded && header}\n          </div>\n        ))}\n      </div>\n      <BindingModal\n        letter={bindingModalKeys}\n        action={bindingModalAction}\n        close={() => setBindingModalKeys(\"\")}\n        callback={(action) => {\n          props.unbind(bindingModalKeys);\n          if (action) props.bind(bindingModalKeys, action);\n          setBindingModalKeys(\"\");\n        }}\n      />\n    </>\n  );\n};\n\nexport default Bindings;\n","import React, { useEffect, useState } from \"react\";\nimport Modal from \"react-modal\";\n\nimport { Action } from \"../lib/action\";\nimport { KeyMap } from \"../lib/keyboard\";\n\nimport Bindings from \"./Bindings\";\nimport Icon from \"./Icon\";\n\nModal.setAppElement(\"#Overlay\");\n\nconst HelpModal = (props: {\n  bind: (key: string, action: Action) => void;\n  unbind: (key: string) => void;\n  reset: () => void;\n  keyMap: KeyMap;\n  isOpen: boolean;\n  toggleOpen: () => void;\n  isMobile: boolean;\n  // toggleMobility: () => void;\n}): JSX.Element => {\n  const [keyModifier, setKeyModifier] = useState(\"\");\n  const [leftHanded, setLeftHanded] = useState(false);\n\n  const toggleHand = (): void => {\n    setLeftHanded((wasLeftHanded: boolean) => {\n      window.localStorage.setItem(\n        \"leftHanded\",\n        wasLeftHanded ? \"false\" : \"true\"\n      );\n\n      return !wasLeftHanded;\n    });\n  };\n\n  useEffect(() => {\n    if (window.localStorage.getItem(\"leftHanded\") === \"true\") {\n      setLeftHanded(true);\n    }\n  }, []);\n\n  return (\n    <Modal\n      className=\"modal\"\n      overlayClassName=\"modal-overlay help-modal\"\n      isOpen={props.isOpen}\n    >\n      <button className=\"close\" onClick={() => props.toggleOpen()}>\n        {Icon.close}\n      </button>\n      <p>\n        <span style={{ fontSize: \"1.5em\", fontWeight: \"bold\" }}>qboard</span>{\" \"}\n        <span style={{ color: \"#666\", marginLeft: \"0.2em\" }}>\n          The efficient digital whiteboard.\n        </span>\n      </p>\n      <p>\n        Press <b>?</b> to show or hide this screen.\n      </p>\n      <p>\n        <button\n          className={keyModifier === \"\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"\")}\n        >\n          unmodified\n        </button>\n        <button\n          className={keyModifier === \"shift\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"shift\")}\n        >\n          with shift\n        </button>\n        <button\n          className={keyModifier === \"ctrl\" ? \"active\" : undefined}\n          onClick={() => setKeyModifier(\"ctrl\")}\n        >\n          with ctrl\n        </button>\n        <button onClick={() => toggleHand()}>\n          {leftHanded ? \"show left side\" : \"show right side\"}\n        </button>\n      </p>\n      <Bindings\n        bind={props.bind}\n        unbind={props.unbind}\n        keyMap={props.keyMap}\n        modifier={keyModifier}\n        leftHanded={leftHanded}\n      />\n      <p>\n        Click a key to change the binding.{\" \"}\n        <button onClick={() => props.reset()}>reset to default</button>\n      </p>\n      <p style={{ color: \"#666\" }}>\n        By <a href=\"https://cjquines.com/\">CJ Quines</a> and{\" \"}\n        <a href=\"https://pihart.github.io/\">Avi Mehra</a>. View on{\" \"}\n        <a href=\"https://github.com/cjquines/qboard\">Github</a>.\n        {/* Use{\" \"}\n        <a onClick={() => props.toggleMobility()} tabIndex={0}>\n          {props.isMobile ? \"desktop\" : \"mobile\"} site\n        </a>.*/}\n      </p>\n    </Modal>\n  );\n};\n\nexport default HelpModal;\n","import React, { useEffect, useState } from \"react\";\n\nimport { Style } from \"../lib/styles\";\nimport { Action } from \"../lib/action\";\n\nimport StyleMenu from \"./StyleMenu\";\n\nconst ContextMenu = (props: {\n  currentStyle: Style;\n  doAction: (action: Action) => void;\n}): JSX.Element | null => {\n  const [coords, setCoords] = useState<[number, number] | null>(null);\n\n  useEffect(() => {\n    document.addEventListener(\"contextmenu\", (e: MouseEvent) => {\n      if ((e.target as HTMLElement).classList.contains(\"upper-canvas\")) {\n        e.preventDefault();\n        e.stopPropagation();\n        setCoords((oldCoords) => (oldCoords ? null : [e.clientX, e.clientY]));\n      }\n    });\n    document.addEventListener(\"click\", () => setCoords(null));\n  }, []);\n\n  return coords ? (\n    <div\n      className=\"context-menu\"\n      style={{\n        top: `calc(${coords[1]}px - 2.8em)`,\n        left: `calc(${coords[0]}px - 1.1em)`,\n      }}\n    >\n      <StyleMenu\n        currentStyle={props.currentStyle}\n        doAction={(action: Action) => props.doAction(action)}\n        inContext={true}\n      />\n    </div>\n  ) : null;\n};\n\nexport default ContextMenu;\n","import React, { useRef } from \"react\";\n\n/**\n * Passed to [[`OverlayButton`]]\n */\ninterface OverlayButtonProps {\n  /**\n   * An `onChange` callback that is given the extracted `FileList` as {@param files} if and only if\n   * * it exists (is non-null), and\n   * * has at least one file.\n   * Otherwise, it is not called.\n   *\n   * Use the `onChange` attribute if you instead want the raw handler\n   */\n  acceptFiles?: (files: FileList) => void;\n\n  /**\n   * Your own callback so that you can record the reference {@param ref} to the input.\n   * That way, you can invoke `click()`, and therefore open the file dialog, programmatically.\n   */\n  captureRef?: (ref: React.RefObject<HTMLInputElement>) => void;\n}\n\nconst OverlayButton = ({\n  acceptFiles,\n  captureRef,\n  ...attrs\n}: OverlayButtonProps &\n  React.DetailedHTMLProps<\n    React.InputHTMLAttributes<HTMLInputElement>,\n    HTMLInputElement\n  >): JSX.Element => {\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  captureRef?.(fileInputRef);\n\n  return (\n    <input\n      onChange={\n        acceptFiles === undefined\n          ? undefined\n          : (e) => {\n              if (e.target.files?.length) acceptFiles(e.target.files);\n            }\n      }\n      ref={fileInputRef}\n      type=\"file\"\n      style={{ display: \"none\" }}\n      {...attrs}\n    />\n  );\n};\n\nexport default OverlayButton;\n","import React, { useEffect, useState } from \"react\";\nimport keyboardJS from \"keyboardjs\";\n\nimport QBoard, { QBoardState } from \"../lib/qboard\";\nimport { Dash, Fill, Stroke } from \"../lib/styles\";\nimport { defaultKeys } from \"../lib/keyboard\";\n\nimport Pagination from \"./Pagination\";\nimport UndoRedo from \"./UndoRedo\";\nimport Toolbar from \"./Toolbar\";\nimport Stylebar from \"./Stylebar\";\nimport HelpModal from \"./HelpModal\";\nimport ContextMenu from \"./ContextMenu\";\nimport VirtualFileInput from \"./VirtualFileInput\";\n\nexport const enum Visibility {\n  None,\n  Condensed,\n  Full,\n}\n\nconst Overlay = ({ qboard }: { qboard: QBoard }): JSX.Element => {\n  const [visibility, setVisibility] = useState<Visibility>(Visibility.Full);\n  const [helpModalOpen, setHelpModalOpen] = useState(false);\n  // const [isMobile, setMobility] = useState(false);\n  const isMobile = true;\n\n  const [state, setState]: [\n    QBoardState,\n    React.Dispatch<React.SetStateAction<QBoardState>>\n  ] = useState<QBoardState>({\n    dragActive: false,\n    currentPage: 0,\n    totalPages: 0,\n    currentStyle: {\n      dash: Dash.Solid,\n      stroke: Stroke.Black,\n      fill: Fill.Transparent,\n    },\n    canUndo: false,\n    canRedo: false,\n    keyMap: defaultKeys,\n  });\n\n  const toggleOpen = (): void => {\n    setHelpModalOpen((wasOpen) => {\n      window.localStorage.setItem(\"helpModalOpen\", wasOpen ? \"false\" : \"true\");\n      return !wasOpen;\n    });\n  };\n\n  // Code is temporarily dead as a result of https://github.com/cjquines/qboard/issues/91;\n  // Commenting so it can get erased in build\n  /*const toggleMobility = (): void => {\n    setMobility((wasMobile) => {\n      window.localStorage.setItem(\"isMobile\", wasMobile ? \"false\" : \"true\");\n      return !wasMobile;\n    });\n  };*/\n\n  useEffect(() => {\n    if (window.localStorage.getItem(\"helpModalOpen\") !== \"false\") {\n      setHelpModalOpen(true);\n    }\n    // if (window.localStorage.getItem(\"isMobile\") !== \"false\") {\n    //   setMobility(true);\n    // }\n\n    qboard.callback = setState;\n    qboard.globalState.toggleHelpModal = toggleOpen;\n    qboard.updateState();\n\n    keyboardJS.bind(\"tab\", () => {\n      setVisibility((currentVisibility) => (currentVisibility + 2) % 3);\n    });\n  }, []);\n\n  return (\n    <>\n      <VirtualFileInput\n        acceptFiles={qboard.files.acceptFile}\n        captureRef={(ref) => {\n          qboard.globalState.fileInputRef = ref;\n        }}\n        multiple\n        accept=\"application/json, application/pdf, image/*\"\n      />\n      <div className={`drop-area ${state.dragActive ? \"active\" : \"\"}`} />\n      <div className={`overlay visibility-${visibility}`}>\n        <Pagination\n          loadPage={qboard.pages.loadPage}\n          currentPage={state.currentPage}\n          totalPages={state.totalPages}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <UndoRedo\n          canUndo={state.canUndo}\n          canRedo={state.canRedo}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <Toolbar\n          currentTool={qboard.activeTool}\n          tools={qboard.tools}\n          doAction={qboard.action.doAction}\n          visibility={visibility}\n        />\n        <Stylebar\n          currentStyle={state.currentStyle}\n          doAction={qboard.action.doAction}\n          acceptFile={async (file) =>\n            qboard.history.execute(\n              (await qboard.files.acceptFile(file)).history\n            )\n          }\n          visibility={visibility}\n          isMobile={isMobile}\n        />\n        <HelpModal\n          bind={qboard.keyboard.bind}\n          unbind={qboard.keyboard.unbind}\n          reset={qboard.keyboard.reset}\n          keyMap={state.keyMap}\n          isOpen={helpModalOpen}\n          toggleOpen={toggleOpen}\n          isMobile={isMobile}\n          // toggleMobility={toggleMobility}\n        />\n      </div>\n      <ContextMenu\n        currentStyle={state.currentStyle}\n        doAction={qboard.action.doAction}\n      />\n    </>\n  );\n};\n\nexport default Overlay;\n","import { fabric } from \"fabric\";\n\nimport Page from \"./page\";\nimport ClipboardHandler from \"./clipboard\";\nimport HistoryHandler from \"./history\";\nimport { PathEvent, GuaranteedIObjectOptions } from \"../types/fabric\";\nimport AssertType from \"../types/assert\";\n\ntype Async<T = void> = T | Promise<T>;\n\nclass Behaviors {\n  // given the origin x, y, snaps the point x2, y2 to the nearest vector in dirs\n  static rectify = (\n    dirs: number[][],\n    x: number,\n    y: number,\n    x2: number,\n    y2: number\n  ): number[] => {\n    return dirs\n      .map((d) => Behaviors.project(x, y, d[0], d[1], x2, y2))\n      .reduce((acc, cur) => (acc[0] < cur[0] ? acc : cur));\n  };\n\n  // projects the point x2, y2 to the vector with origin ox, oy and direction vx, vy. returns the square distance and the coordinates of the projection.\n  private static project = (\n    ox: number,\n    oy: number,\n    vx: number,\n    vy: number,\n    x2: number,\n    y2: number\n  ): number[] => {\n    const x = x2 - ox;\n    const y = y2 - oy;\n    const side = vx * y - vy * x;\n    const sq = vx * vx + vy * vy;\n    return [\n      Math.abs(side) / sq,\n      ox + x + (vy * side) / sq,\n      oy + y - (vx * side) / sq,\n    ];\n  };\n}\n\nexport class Tool {\n  // Add type marker `boolean` so it can be overridden; otherwise takes type `false`\n  /**\n   * Make sure that no extending classes except DrawingTool set this to true;\n   * the value of this property is used as a type guard.\n   */\n  protected readonly _isDrawing: boolean = false;\n  /**\n   * Make sure that no extending classes except RequiresBaseTool set this to true;\n   * the value of this property is used as a type guard.\n   */\n  protected readonly _requiresBase: boolean = false;\n  /**\n   * Make sure that no extending classes except Brush set this to true;\n   * the value of this property is used as a type guard.\n   */\n  protected readonly _isBrush: boolean = false;\n\n  isDrawing(): this is DrawingTool {\n    return this._isDrawing;\n  }\n\n  requiresBase(): this is RequiresBase {\n    return this._requiresBase;\n  }\n\n  isBrush(): this is Brush {\n    return this._isBrush;\n  }\n\n  resize?: (\n    object: fabric.Object,\n    x2: number,\n    y2: number,\n    strict: boolean\n  ) => Async<fabric.Object>;\n\n  /**\n   * Set externally from activate() and deactivate().\n   * Set internally (from an extending class) with setActive();\n   * @private\n   */\n  private active = false;\n\n  constructor(\n    protected baseCanvas: Page,\n    protected history: HistoryHandler,\n    protected clipboard: ClipboardHandler\n  ) {}\n\n  /**\n   * @return Whether the activation was successful.\n   * Maybe want to throw error instead of return boolean.\n   */\n  activate: () => Async<boolean> = () => this.setActive(true);\n\n  /**\n   * Not allowed to fail\n   */\n  deactivate: () => void = () => this.setActive(false);\n\n  /**\n   * get this.active\n   */\n  isActive = (): boolean => this.active;\n\n  /**\n   * set this.active active\n   */\n  protected setActive = (active: boolean): boolean => (this.active = active);\n}\n\nexport abstract class DrawingTool extends Tool {\n  _isDrawing = true;\n  abstract draw: (\n    x,\n    y,\n    options,\n    x2?,\n    y2?\n  ) => fabric.Object | Promise<fabric.Object>;\n}\nexport abstract class RequiresBase extends Tool {\n  _requiresBase = true;\n}\n\nexport abstract class Brush extends RequiresBase {\n  _isBrush = true;\n\n  /**\n   * Handle the pathCreated event\n   */\n  pathCreated: (e: PathEvent) => void = () => {};\n\n  setBrush: (\n    brush: fabric.BaseBrush,\n    options: GuaranteedIObjectOptions\n  ) => void | Promise<void> = () => {};\n}\n\nexport class Move extends RequiresBase {}\n\nexport class Pen extends Brush {\n  pathCreated = (e: PathEvent): void => {\n    e.path.id = this.baseCanvas.getNextId();\n    this.history.add([e.path]);\n  };\n  setBrush = (\n    brush: fabric.BaseBrush,\n    options: GuaranteedIObjectOptions\n  ): void => {\n    brush.color = options.stroke;\n    brush.strokeDashArray = options.strokeDashArray;\n    brush.width = options.strokeWidth;\n  };\n}\n\nexport class Eraser extends Brush {\n  pathCreated = (e: PathEvent): void => {\n    const path = fabric.util.object.clone(e.path);\n    this.baseCanvas.remove(e.path);\n    const objects = this.baseCanvas\n      .getObjects()\n      .filter((object) => object.intersectsWithObject(path));\n    if (!objects.length) return;\n    this.baseCanvas.remove(...objects);\n    this.history.remove(objects);\n  };\n\n  setBrush = (\n    brush: fabric.BaseBrush,\n    options: GuaranteedIObjectOptions\n  ): void => {\n    brush.color = \"#ff005455\";\n    brush.strokeDashArray = [0, 0];\n    brush.width = 5 * options.strokeWidth;\n  };\n\n  /**\n   * Attempts to activate the current tool\n   *\n   * Default implementation:\n   * Execute cut() which attempts to cut currently selected objects if they exist.\n   * If cut() true then abort; leave current tool active.\n   * Otherwise, mark internal state as active and return true\n   *\n   * @return Whether it was able to successfully activate\n   */\n  activate = (): boolean => !this.clipboard.cut() && this.setActive(true);\n}\n\nexport class Laser extends Brush {\n  pathCreated = (e: PathEvent): void => {\n    setTimeout(() => {\n      this.baseCanvas.remove(e.path);\n      this.baseCanvas.requestRenderAll();\n    }, 1000);\n  };\n  setBrush = (\n    brush: fabric.BaseBrush,\n    options: GuaranteedIObjectOptions\n  ): void => {\n    brush.color = \"#f23523\";\n    brush.strokeDashArray = [0, 0];\n    brush.width = options.strokeWidth;\n  };\n}\n\nexport class Line extends DrawingTool {\n  x = 0;\n  y = 0;\n\n  dirs: number[][] = [\n    [1, 0],\n    [1, 1],\n    [0, 1],\n    [-1, 1],\n  ];\n\n  draw = (\n    x: number,\n    y: number,\n    options: fabric.IObjectOptions,\n    x2?: number,\n    y2?: number\n  ): fabric.Line => {\n    this.x = x;\n    this.y = y;\n\n    return new fabric.Line([x, y, x2, y2] as number[], {\n      ...options,\n      perPixelTargetFind: true,\n    });\n  };\n\n  resize = (\n    object: fabric.Object,\n    x2: number,\n    y2: number,\n    strict: boolean\n  ): fabric.Line => {\n    AssertType<fabric.Line>(object);\n\n    const [, x, y] = strict\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\n      : [undefined, x2, y2];\n    object.set({ x2: x, y2: y }).setCoords();\n    return object;\n  };\n}\n\nexport class Rectangle extends DrawingTool {\n  x = 0;\n  y = 0;\n\n  dirs: number[][] = [\n    [1, 1],\n    [-1, 1],\n  ];\n\n  draw = (\n    x: number,\n    y: number,\n    options: fabric.IObjectOptions,\n    x2?: number,\n    y2?: number\n  ): fabric.Rect => {\n    this.x = x;\n    this.y = y;\n\n    return new fabric.Rect({\n      left: x,\n      top: y,\n      width: x2,\n      height: y2,\n      ...options,\n    });\n  };\n\n  resize = (\n    object: fabric.Rect,\n    x2: number,\n    y2: number,\n    strict: boolean\n  ): fabric.Rect => {\n    const [, x, y] = strict\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\n      : [undefined, x2, y2];\n    object\n      .set({\n        originX: this.x > x ? \"right\" : \"left\",\n        originY: this.y > y ? \"bottom\" : \"top\",\n        width: Math.abs(this.x - x),\n        height: Math.abs(this.y - y),\n      })\n      .setCoords();\n\n    return object;\n  };\n}\n\nexport class Ellipse extends DrawingTool {\n  x = 0;\n  y = 0;\n\n  dirs: number[][] = [\n    [1, 1],\n    [-1, 1],\n  ];\n\n  draw = (\n    x: number,\n    y: number,\n    options: fabric.IObjectOptions,\n    x2?: number,\n    y2?: number\n  ): fabric.Ellipse => {\n    this.x = x;\n    this.y = y;\n\n    return new fabric.Ellipse({ ...options, left: x, top: y, rx: x2, ry: y2 });\n  };\n\n  resize = (\n    object: fabric.Object,\n    x2: number,\n    y2: number,\n    strict: boolean\n  ): fabric.Ellipse => {\n    AssertType<fabric.Ellipse>(object);\n\n    const [, x, y] = strict\n      ? Behaviors.rectify(this.dirs, this.x, this.y, x2, y2)\n      : [undefined, x2, y2];\n    object\n      .set({\n        originX: this.x > x ? \"right\" : \"left\",\n        originY: this.y > y ? \"bottom\" : \"top\",\n        rx: Math.abs(x - (object.left || 0)) / 2,\n        ry: Math.abs(y - (object.top || 0)) / 2,\n      })\n      .setCoords();\n\n    return object;\n  };\n}\n\nexport interface Tools {\n  Line: Line;\n  Ellipse: Ellipse;\n  Move: Move;\n  Laser: Laser;\n  Pen: Pen;\n  Rectangle: Rectangle;\n  Eraser: Eraser;\n}\n\nconst instantiateTools = (\n  baseCanvas: Page,\n  history: HistoryHandler,\n  clipboard: ClipboardHandler\n): Tools => ({\n  Move: new Move(baseCanvas, history, clipboard),\n  Pen: new Pen(baseCanvas, history, clipboard),\n  Eraser: new Eraser(baseCanvas, history, clipboard),\n  Laser: new Laser(baseCanvas, history, clipboard),\n  Line: new Line(baseCanvas, history, clipboard),\n  Rectangle: new Rectangle(baseCanvas, history, clipboard),\n  Ellipse: new Ellipse(baseCanvas, history, clipboard),\n});\n\nexport default instantiateTools;\n","import { fabric } from \"fabric\";\n\nexport type GuaranteedIObjectOptions = fabric.IObjectOptions & {\n  fill: string;\n  stroke: string;\n  strokeWidth: number;\n  selectable: boolean;\n  strokeDashArray: number[];\n  strokeUniform: boolean;\n};\n\nexport interface FabricObject extends fabric.Object {\n  clone(callback: (obj: this) => unknown, propertiesToInclude?: string[]): void;\n}\n\nexport interface ObjectId extends FabricObject {\n  id: number;\n}\n\nexport type FabricIEvent = fabric.IEvent & {\n  selected: FabricObject[];\n  target: FabricObject;\n};\n\n// don't know whether this is fabric.Path\ntype PathType = FabricObject & {\n  id: number;\n};\n\nexport type PathEvent = FabricIEvent & {\n  path: PathType;\n};\n\nexport function isFabricCollection(\n  obj: fabric.Object\n): obj is fabric.Object & fabric.ICollection<unknown> {\n  return \"_objects\" in obj;\n}\n","import { fabric } from \"fabric\";\nimport { FabricObject, isFabricCollection, ObjectId } from \"../types/fabric\";\n\nexport type Cursor = { x: number; y: number };\n\nexport default class Page extends fabric.Canvas {\n  cursor: Cursor | undefined;\n\n  // assert not undefined because fitToWindow, which is called at init, sets these\n  canvasWidth!: number;\n  canvasHeight!: number;\n\n  latestId = 0;\n  modified = false;\n\n  fitToWindow = (canvasWidth: number, canvasHeight: number): void => {\n    const widthRatio = window.innerWidth / canvasWidth;\n    const heightRatio = window.innerHeight / canvasHeight;\n    this.setZoom(Math.min(widthRatio, heightRatio));\n    this.setWidth(canvasWidth * this.getZoom());\n    this.setHeight(canvasHeight * this.getZoom());\n    this.canvasWidth = canvasWidth;\n    this.canvasHeight = canvasHeight;\n  };\n\n  deactivateSelection = (): void => {\n    this.isDrawingMode = false;\n    this.selection = false;\n    this.discardActiveObject();\n    this.forEachObject((object) => {\n      object.selectable = false;\n    });\n    this.requestRenderAll();\n  };\n\n  activateSelection = (): void => {\n    this.isDrawingMode = false;\n    this.selection = true;\n    this.forEachObject((object) => {\n      object.selectable = true;\n    });\n  };\n\n  getNextId = (): number => {\n    this.latestId += 1;\n    return this.latestId;\n  };\n\n  // kind of inefficient\n  getObjectByIds = (ids: number[]): fabric.Object[] =>\n    this.getObjects().filter((object) => ids.includes((object as ObjectId).id));\n\n  serialize = (objects: fabric.Object[]): fabric.Object[] => {\n    const selection = this.getActiveObjects();\n    const reselect =\n      selection.length > 1 && objects.some((obj) => selection.includes(obj));\n    if (reselect) {\n      this.discardActiveObject();\n      this.setActiveObject(\n        new fabric.ActiveSelection(selection, { canvas: this })\n      );\n    }\n    return objects.map((obj) => obj.toObject([\"strokeUniform\"]));\n  };\n\n  apply = (ids: number[], newObjects: fabric.Object[] | null): void => {\n    const oldObjects = this.getObjectByIds(ids);\n    if (oldObjects.length) {\n      this.remove(...oldObjects);\n    }\n    if (newObjects?.length) {\n      const addObjects = (objects) => {\n        objects.forEach((object: ObjectId, i) => {\n          object.id = ids[i];\n        });\n        this.add(...objects);\n        this.requestRenderAll();\n      };\n      fabric.util.enlivenObjects(newObjects, addObjects, \"fabric\");\n    } else {\n      this.requestRenderAll();\n    }\n  };\n\n  loadFromJSONAsync = async (json: unknown): Promise<void> =>\n    new Promise<void>((resolve) => {\n      super.loadFromJSON(json, () => {\n        resolve();\n      });\n    });\n\n  addImage = async (\n    imageURL: string,\n    cursor?: Partial<Cursor>,\n    options?: fabric.IImageOptions\n  ): Promise<fabric.Object> =>\n    new Promise<fabric.Object>((resolve) =>\n      fabric.Image.fromURL(\n        imageURL,\n        (obj) => {\n          resolve(this.placeObject(obj, cursor)[0]);\n        },\n        options\n      )\n    );\n\n  placeObject = (\n    obj: FabricObject,\n    {\n      x = this.canvasWidth / 2,\n      y = this.canvasHeight / 2,\n    }: Partial<Cursor> = this.cursor ?? {}\n  ): fabric.Object[] => {\n    this.discardActiveObject();\n    const id = this.getNextId();\n\n    (obj as ObjectId).set({\n      id,\n      left: x,\n      top: y,\n      originX: \"center\",\n      originY: \"center\",\n    });\n\n    let returnObjects = [obj];\n\n    if (isFabricCollection(obj)) {\n      obj.canvas = this;\n      obj.forEachObject((object) => {\n        (object as ObjectId).id = this.getNextId();\n        this.add(object);\n      });\n      obj.setCoords();\n\n      returnObjects = obj.getObjects();\n    } else {\n      this.add(obj);\n    }\n    this.setActiveObject(obj);\n    this.requestRenderAll();\n    return returnObjects;\n  };\n}\n","import { fabric } from \"fabric\";\r\nimport { MalformedExpressionException, RequireSubType } from \"@mehra/ts\";\r\n\r\nimport { HistoryCommand } from \"./history\";\r\nimport Pages, { PageJSON } from \"./pages\";\r\nimport { Cursor } from \"./page\";\r\n\r\nconst defaults = <T>(value: T | undefined, getDefaultValue: () => T) =>\r\n  value === undefined ? getDefaultValue() : value;\r\n\r\nexport class AsyncReader {\r\n  static readAsText = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result!);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsText(file);\r\n    });\r\n\r\n  static readAsDataURL = (file: File): Promise<string | ArrayBuffer> =>\r\n    new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.onload = () => {\r\n        resolve(reader.result!);\r\n      };\r\n      reader.onerror = reject;\r\n      reader.readAsDataURL(file);\r\n    });\r\n}\r\n\r\n/**\r\n * Common to _all_ versions of exports\r\n */\r\ninterface QboardFile {\r\n  // It is objective truth that every past and future qboard file will be an object containing this field\r\n  \"qboard-version\": number;\r\n\r\n  // If a future version removes this field, this is actually okay;\r\n  // just remove the field from this interface declaration.\r\n  // The reason for this field existing right now is that we _know_ that every qboard file has it,\r\n  // so we include it for convenience.\r\n  // However, it's not necessarily true that this field will remain the same forever.\r\n  pages: PageJSON[];\r\n}\r\n\r\n/**\r\n * Basic check to test whether {@param object} is a valid qboard file at any version,\r\n * i.e. does it have type [[`QboardFile`]]?\r\n *\r\n * Not a deep check;\r\n * all valid qboard files will pass (return `true`) but not all invalid qboard files will fail (return `false`)\r\n */\r\nconst isValidQboardFile = (object: unknown): object is QboardFile => {\r\n  if (object instanceof Object) {\r\n    return \"qboard-version\" in object;\r\n  }\r\n  return false;\r\n};\r\n\r\n/**\r\n * The current qboard file format\r\n */\r\ninterface CurrentQboardFile {\r\n  \"qboard-version\": 1;\r\n  pages: PageJSON[];\r\n}\r\n\r\n/**\r\n * @Test Ensure that [[`CurrentQboardFile`]] is a subtype of [[`QboardFile`]]\r\n *\r\n * This means that every qboard file format (tested by strong induction) actually satisfies the contract we expect it to.\r\n */\r\n{\r\n  // We need to write our own test because ts doesn't let an interface implement another interface\r\n\r\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n  type T = RequireSubType<CurrentQboardFile, QboardFile>;\r\n}\r\n\r\n/**\r\n * A file, supposedly serialized from qboard, doesn't adhere to any version of the qboard file spec\r\n */\r\nexport class InvalidQboardFileException extends MalformedExpressionException {\r\n  constructor(message = \"Invalid qboard file\") {\r\n    super(message);\r\n  }\r\n}\r\n\r\n// manages version compatibility with old document formats\r\n// change the signature and usages to accommodate new data; this will fill in sample data for missing fields\r\nexport class JSONReader {\r\n  /**\r\n   * Get the `pagesJSON` data from a qboard file\r\n   * @param json A JSON-serialized qboard file\r\n   * @throws {InvalidQboardFileException} if {@param json} doesn't represent a valid qboard file\r\n   */\r\n  static read(json: string | ArrayBuffer): PageJSON[] {\r\n    const object: unknown = JSON.parse(json.toString());\r\n    return JSONReader.readParsed(object);\r\n  }\r\n\r\n  /**\r\n   * Get the `pagesJSON` data from a parsed qboard file\r\n   * @param object A parsed serialized qboard file\r\n   * @throws {InvalidQboardFileException} if {@param object} doesn't represent a valid qboard file\r\n   */\r\n  static readParsed(object: unknown): PageJSON[] {\r\n    if (!isValidQboardFile(object)) throw new InvalidQboardFileException();\r\n\r\n    const {\r\n      // output is same regardless of version due to forwards compatibility\r\n      // \"qboard-version\": version,\r\n      pages,\r\n    } = object;\r\n    return pages;\r\n  }\r\n}\r\n\r\nexport class JSONWriter {\r\n  private readonly sourceJSON: CurrentQboardFile;\r\n  private asString?: string;\r\n  private asBlob?: Blob;\r\n  private asUrl?: string;\r\n\r\n  constructor(pagesJSON: PageJSON[]) {\r\n    this.sourceJSON = {\r\n      \"qboard-version\": 1,\r\n      pages: pagesJSON,\r\n    };\r\n  }\r\n\r\n  toString = (): string =>\r\n    (this.asString = defaults(this.asString, () =>\r\n      JSON.stringify(this.sourceJSON)\r\n    ));\r\n\r\n  toBlob = (): Blob =>\r\n    (this.asBlob = defaults(\r\n      this.asBlob,\r\n      () => new Blob([this.toString()], { type: \"application/json\" })\r\n    ));\r\n\r\n  toURL = (): [string, () => void] => {\r\n    this.asUrl = defaults(this.asUrl, () =>\r\n      window.URL.createObjectURL(this.toBlob())\r\n    );\r\n    const revoke = () => {\r\n      if (this.asUrl === undefined) return;\r\n\r\n      window.URL.revokeObjectURL(this.asUrl);\r\n      this.asUrl = undefined;\r\n    };\r\n    return [this.asUrl, revoke];\r\n  };\r\n\r\n  download = (filename = \"qboard-file\"): void => {\r\n    const [fileURL, revokeURL] = this.toURL();\r\n\r\n    const elt = document.createElement(\"a\");\r\n    elt.style.display = \"none\";\r\n    elt.href = fileURL;\r\n    elt.download = filename;\r\n    document.body.appendChild(elt);\r\n    elt.click();\r\n    elt.remove();\r\n\r\n    revokeURL();\r\n  };\r\n}\r\n\r\nexport type FileHandlerResponse = {\r\n  action: \"none\" | \"image\" | \"json\";\r\n  history?: HistoryCommand;\r\n};\r\n\r\nexport default class FileHandler {\r\n  constructor(public pages: Pages) {}\r\n\r\n  processFiles = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<HistoryCommand> => {\r\n    const images: fabric.Object[] = [];\r\n    await Promise.all(\r\n      [...files].map(async (file) => {\r\n        if (file.type.startsWith(\"image/\")) {\r\n          images.push(await this.handleImage(file, cursor));\r\n        }\r\n        if (file.type === \"application/json\") {\r\n          return this.handleJSON(file);\r\n        }\r\n      })\r\n    );\r\n    return {\r\n      add: images.flat(),\r\n    };\r\n  };\r\n\r\n  acceptFile = async (\r\n    files: FileList,\r\n    cursor?: Cursor\r\n  ): Promise<FileHandlerResponse> => {\r\n    if (!files.length) return { action: \"none\" };\r\n    const [file] = files;\r\n\r\n    if (file.type.startsWith(\"image/\")) {\r\n      return {\r\n        action: \"image\",\r\n        history: { add: [await this.handleImage(file, cursor)] },\r\n      };\r\n    }\r\n\r\n    if (file.type === \"application/json\") {\r\n      await this.openFile(file);\r\n      return {\r\n        action: \"json\",\r\n        history: { clear: [true] },\r\n      };\r\n    }\r\n\r\n    // unsupported file\r\n    return { action: \"none\" };\r\n  };\r\n\r\n  openFile = async (file: File): Promise<boolean> => {\r\n    this.pages.savePage();\r\n    return this.pages.overwritePages(\r\n      JSONReader.read(await AsyncReader.readAsText(file))\r\n    );\r\n  };\r\n\r\n  private handleImage = async (\r\n    file: File,\r\n    cursor?: Cursor\r\n  ): Promise<fabric.Object> =>\r\n    AsyncReader.readAsDataURL(file)\r\n      .then((result) => this.pages.canvas.addImage(result.toString(), cursor))\r\n      .then((img) => {\r\n        const maxWidth = 0.8;\r\n        const maxHeight = 0.8;\r\n\r\n        const [w_i = 0, w_c = 0, h_i = 0, h_c = 0] = [\r\n          img.width,\r\n          this.pages.canvas.width,\r\n          img.height,\r\n          this.pages.canvas.height,\r\n        ];\r\n\r\n        if (w_i > maxWidth * w_c || h_i > maxHeight * h_c)\r\n          img.scaleToWidth(\r\n            Math.min(maxWidth * w_c, (maxHeight * h_c * w_i) / h_i)\r\n          );\r\n\r\n        return img;\r\n      });\r\n\r\n  private handleJSON = async (file: File): Promise<number> => {\r\n    const pages = JSONReader.read(await AsyncReader.readAsText(file));\r\n    return this.pages.insertPagesAfter(pages);\r\n  };\r\n}\r\n","import pdfMake from \"pdfmake/build/pdfmake\";\nimport { TDocumentDefinitions } from \"pdfmake/interfaces\";\nimport { fabric } from \"fabric\";\n\nimport Page from \"./page\";\nimport { JSONWriter } from \"./files\";\n\nexport type PageJSON = {\n  version: string;\n  objects: fabric.Object[];\n  background: string;\n};\n\nconst defaultPageJSON: PageJSON = {\n  version: \"4.2.0\",\n  objects: [],\n  background: \"white\",\n};\n\n/**\n * @return The current local time in the form `YYYY-MM-DD-HH-mm`\n */\nconst timeString = (): string => {\n  const offset = new Date().getTimezoneOffset() * 60000;\n  return new Date(Date.now() - offset)\n    .toISOString()\n    .slice(0, -8)\n    .replace(/\\D/g, \"-\");\n};\n\nexport default class Pages {\n  currentIndex = 0;\n\n  constructor(\n    public canvas: Page,\n    public canvasWidth: number,\n    public canvasHeight: number,\n    public updateState: () => void,\n    public pagesJSON: PageJSON[] = [defaultPageJSON]\n  ) {}\n\n  savePage = (): void => {\n    this.pagesJSON[this.currentIndex] = this.canvas.toObject([\n      \"id\",\n      \"strokeUniform\",\n    ]);\n  };\n\n  /**\n   * Safe method to load \"move to\"/\"switch to\" a specific page in UI.\n   * Will not do anything if `{@param index} === this.currentIndex && {@param saveExisting}`.\n   *\n   * @param index The 0-based index of the page to load\n   * @param saveExisting\n   * Whether to save the contents on the current page to memory before switching pages.\n   * Forces an unconditional re-render when set to `false`,\n   * as opposed to not doing anything if the current page is {@param index}.\n   * May need to set to `false` if directly manipulating the internal array to prevent an override.\n   * @return\n   * The index of the loaded page.\n   * This equals {@param index}.\n   */\n  // TODO: Should saveExisting be renamed and negated to force?\n  loadPage = async (index: number, saveExisting = true): Promise<number> => {\n    if (saveExisting) this.savePage();\n    if (index === this.currentIndex && saveExisting) return index;\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[index]);\n    this.currentIndex = index;\n    this.updateState();\n    return index;\n  };\n\n  /**\n   * Safely move back one page, creating a blank page if necessary.\n   * @return The index of the loaded page.\n   */\n  previousOrNewPage = (): Promise<number> => {\n    if (this.currentIndex === 0) {\n      return this.insertPagesBefore([defaultPageJSON], true);\n    }\n    return this.loadPage(this.currentIndex - 1);\n  };\n\n  /**\n   * Safely move forward one page, creating a blank page if necessary.\n   * @return The index of the loaded page.\n   */\n  nextOrNewPage = (): Promise<number> => {\n    if (this.currentIndex === this.pagesJSON.length - 1) {\n      return this.insertPagesAfter([defaultPageJSON], true);\n    }\n    return this.loadPage(this.currentIndex + 1);\n  };\n\n  /**\n   * Safely convert the existing pages to PDF, and initiate a download.\n   * The filename is of the form `qboard-YYYY-MM-DD-HH-mm.pdf` in local time.\n   */\n  export = async (): Promise<void> => {\n    this.savePage();\n    const ratio = 2;\n    const content: { svg: string; width: number }[] = [];\n    const currentIndexCopy = this.currentIndex;\n    // Load each page and then record it as svg\n    for (const page of this.pagesJSON) {\n      // As of now, each page needs to be individually loaded, so we await each load\n      // eslint-disable-next-line no-await-in-loop\n      await this.canvas.loadFromJSONAsync(page);\n      content.push({\n        svg: this.canvas.toSVG(),\n        width: this.canvasWidth / ratio,\n      });\n    }\n\n    const docDefinition: TDocumentDefinitions = {\n      pageSize: {\n        width: this.canvasWidth / ratio,\n        height: this.canvasHeight / ratio,\n      },\n      pageMargins: [0, 0],\n      content,\n    };\n\n    pdfMake.createPdf(docDefinition).download(`qboard-${timeString()}.pdf`);\n\n    await this.canvas.loadFromJSONAsync(this.pagesJSON[currentIndexCopy]);\n  };\n\n  /**\n   * Safely convert the existing pages to qboard JSON, and initiate a download.\n   * The filename is of the form `qboard-YYYY-MM-DD-HH-mm.json` in local time.\n   */\n  saveFile = (): void => {\n    this.savePage();\n    new JSONWriter(this.pagesJSON).download(`qboard-${timeString()}.json`);\n    this.canvas.modified = false;\n  };\n\n  /**\n   * Replace the entire board with different data,\n   * after prompting (window.confirm) the user for confirmation.\n   * @param pages an array of page data in the internal format\n   * @return Whether the pages were successfully overwritten.\n   * This is the same as whether the user accepted the prompt.\n   */\n  overwritePages = async (\n    pages: PageJSON[] = [defaultPageJSON]\n  ): Promise<boolean> => {\n    const response =\n      !this.canvas.modified ||\n      this.pagesJSON.every((page) => page.objects.length === 0) ||\n      window.confirm(\n        \"Your work will be overwritten. Are you sure you wish to continue?\"\n      );\n    if (!response) return false;\n\n    this.pagesJSON = pages;\n    await this.loadPage(0, false);\n    this.canvas.modified = false;\n    return true;\n  };\n\n  /**\n   * Add the content of {@param pages} to the pages list before the current page.\n   * @param isNonModifying `true` if you don't want to mark the board as modified due to this change.\n   * Generally set when inserting blank pages, which don't contain any objects.\n   */\n  insertPagesBefore = async (\n    pages: PageJSON[],\n    isNonModifying = false\n  ): Promise<number> => {\n    this.savePage();\n    this.pagesJSON.splice(this.currentIndex, 0, ...pages);\n    // make sure not to do\n    // this.canvas.modified = !isNonModifying\n    // because that marks an already modified board as unmodified\n    if (!isNonModifying) {\n      this.canvas.modified = true;\n    }\n    // you have already saved the pages via splice;\n    // if you saveExisting then you will be saving to the wrong index\n    return this.loadPage(this.currentIndex, false);\n  };\n\n  /**\n   * Add the content of {@param pages} to the pages list after the current page.\n   * @param isNonModifying `true` if you don't want to mark the board as modified due to this change.\n   * Generally set when inserting blank pages, which don't contain any objects.\n   */\n  insertPagesAfter = async (\n    pages: PageJSON[],\n    isNonModifying = false\n  ): Promise<number> => {\n    this.pagesJSON.splice(this.currentIndex + 1, 0, ...pages);\n    // make sure not to do\n    // this.canvas.modified = !isNonModifying\n    // because that marks an already modified board as unmodified\n    if (!isNonModifying) {\n      this.canvas.modified = true;\n    }\n    // you can saveExisting because you're only updating indices _after_ the current page.\n    // you can also saveExisting before the splice\n    return this.loadPage(this.currentIndex + 1, true);\n  };\n}\n","import { fabric } from \"fabric\";\n\nimport Page from \"./page\";\nimport Pages from \"./pages\";\nimport { ObjectId } from \"../types/fabric\";\n\ninterface HistoryItem {\n  ids: number[];\n  oldObjects: fabric.Object[] | null;\n  newObjects: fabric.Object[] | null;\n  page: number;\n}\n\nexport type HistoryCommand = {\n  add?: fabric.Object[];\n  remove?: fabric.Object[];\n  clear?: [boolean];\n};\n\nexport default class HistoryHandler {\n  history: HistoryItem[] = [];\n  redoStack: HistoryItem[] = [];\n  selection: fabric.Object[] | null = null;\n  locked = false;\n\n  constructor(\n    public canvas: Page,\n    public pages: Pages,\n    public updateState: () => void\n  ) {}\n\n  execute = (command: HistoryCommand = {}): void => {\n    if (command.clear) this.clear(command.clear[0]);\n    this.add(command.add);\n    this.remove(command.remove);\n  };\n\n  add = (objects?: fabric.Object[]): void => {\n    if (objects?.length) this.save({ newObjects: objects });\n  };\n\n  remove = (objects?: fabric.Object[]): void => {\n    if (objects?.length) this.save({ oldObjects: objects });\n  };\n\n  clear = (clearRedo = false): void => {\n    this.history = [];\n    if (clearRedo) this.redoStack = [];\n    this.updateState();\n  };\n\n  store = (objects: fabric.Object[]): void => {\n    if (this.locked) return;\n    this.locked = true;\n    this.selection = this.canvas.serialize(objects);\n    this.locked = false;\n  };\n\n  modify = (objects: fabric.Object[]): void =>\n    this.save({ oldObjects: this.selection, newObjects: objects });\n\n  save = ({\n    oldObjects,\n    newObjects,\n  }:\n    | { oldObjects: fabric.Object[]; newObjects? }\n    | {\n        oldObjects?;\n        newObjects: fabric.Object[];\n      }): void => {\n    if (this.locked) return;\n    const basis = newObjects || oldObjects;\n    this.locked = true;\n    this.history.push({\n      ids: basis.map((object) => (object as ObjectId).id),\n      oldObjects: newObjects ? oldObjects : this.canvas.serialize(oldObjects),\n      newObjects: newObjects && this.canvas.serialize(newObjects),\n      page: this.pages.currentIndex,\n    });\n    this.locked = false;\n    this.redoStack = [];\n    this.canvas.modified = true;\n    this.updateState();\n  };\n\n  undo = async (): Promise<void> => {\n    if (!this.history.length) return;\n    this.canvas.discardActiveObject();\n    await this.move(this.history, this.redoStack, true);\n  };\n\n  redo = async (): Promise<void> => {\n    if (!this.redoStack.length) return;\n    await this.move(this.redoStack, this.history, false);\n  };\n\n  private move = async (\n    from: HistoryItem[],\n    to: HistoryItem[],\n    isUndo: boolean\n  ): Promise<void> => {\n    if (!from.length) return;\n    this.locked = true;\n    const last = from.pop()!;\n    await this.pages.loadPage(last.page);\n    this.canvas.apply(last.ids, isUndo ? last.oldObjects : last.newObjects);\n    to.push(last);\n    this.locked = false;\n    this.canvas.modified = true;\n    this.updateState();\n  };\n}\n","import { fabric } from \"fabric\";\n\nimport { FabricObject, isFabricCollection } from \"../types/fabric\";\nimport AssertType from \"../types/assert\";\n\nimport Page from \"./page\";\nimport Pages from \"./pages\";\nimport FileHandler from \"./files\";\nimport HistoryHandler from \"./history\";\n\nexport default class ClipboardHandler {\n  clipboard?: FabricObject;\n\n  constructor(\n    public canvas: Page,\n    public pages: Pages,\n    public files: FileHandler,\n    public history: HistoryHandler,\n    public canvasWidth: number,\n    public canvasHeight: number\n  ) {\n    document.addEventListener(\"paste\", this.pasteExternal);\n  }\n\n  copy = (): fabric.Object | null => {\n    const activeObject = this.canvas.getActiveObject();\n    if (!activeObject) return null;\n\n    // Add missing type information\n    AssertType<FabricObject>(activeObject);\n\n    activeObject.clone((clone) => {\n      this.clipboard = clone;\n    });\n    return activeObject;\n  };\n\n  /**\n   * Cuts currently selected objects, if any\n   * @return Whether there were objects to cut\n   */\n  cut = (): boolean => {\n    const activeObject = this.copy();\n    if (!activeObject) return false;\n\n    this.canvas.discardActiveObject();\n    if (isFabricCollection(activeObject)) {\n      activeObject.forEachObject((object) => {\n        this.canvas.remove(object);\n      });\n      this.history.remove(activeObject.getObjects());\n    } else {\n      this.canvas.remove(activeObject);\n      this.history.remove([activeObject]);\n    }\n    this.canvas.requestRenderAll();\n\n    return true;\n  };\n\n  paste = (): void => {\n    if (this.clipboard === undefined) return;\n\n    return this.clipboard.clone((clone) =>\n      this.history.add(this.canvas.placeObject(clone))\n    );\n  };\n\n  pasteExternal = async (e: ClipboardEvent): Promise<void> => {\n    const historyCommand = await this.files.processFiles(\n      e.clipboardData!.files\n    );\n    this.history.execute(historyCommand);\n  };\n}\n","import { fabric } from \"fabric\";\n\nexport const enum Dash {\n  Solid,\n  Dashed,\n  Dotted,\n}\n\nexport const enum Stroke {\n  Black = \"#000000\",\n  Blue = \"#0097f6\",\n  Green = \"#00b253\",\n  Yellow = \"#ffbf00\",\n  Orange = \"#ff2600\",\n}\n\nexport const enum Fill {\n  Transparent,\n  Solid,\n  HalfSolid,\n}\n\nexport interface Style {\n  dash: Dash;\n  stroke: Stroke;\n  fill: Fill;\n}\n\nconst dashMap = [\n  [0, 0],\n  [20, 15],\n  [5, 10],\n];\n\nexport default class StyleHandler {\n  constructor(\n    public currentStyle: Style,\n    public drawerOptions: fabric.IObjectOptions,\n    public freeDrawingBrush: fabric.BaseBrush,\n    public updateState: () => void\n  ) {}\n\n  set = (dash: Dash | null, stroke: Stroke | null, fill: Fill | null): void => {\n    if (dash !== null) {\n      this.currentStyle.dash = dash;\n      this.drawerOptions.strokeDashArray = dashMap[dash];\n      this.freeDrawingBrush.strokeDashArray = dashMap[dash];\n    }\n\n    if (stroke !== null) {\n      this.currentStyle.stroke = stroke;\n      this.drawerOptions.stroke = stroke;\n      this.freeDrawingBrush.color = stroke;\n    }\n\n    if (fill !== null) {\n      this.currentStyle.fill = fill;\n    }\n\n    if (stroke !== null || fill !== null) {\n      switch (this.currentStyle.fill) {\n        case Fill.Transparent: {\n          this.drawerOptions.fill = \"transparent\";\n          break;\n        }\n        case Fill.Solid: {\n          this.drawerOptions.fill = this.currentStyle.stroke;\n          break;\n        }\n        case Fill.HalfSolid: {\n          this.drawerOptions.fill = `${this.currentStyle.stroke}11`;\n          break;\n        }\n      }\n    }\n\n    this.updateState();\n  };\n}\n","import React from \"react\";\r\nimport ReactDOM from \"react-dom\";\r\n\r\nimport Overlay from \"./components/Overlay\";\r\nimport QBoard from \"./lib/qboard\";\r\n\r\nimport \"./main.scss\";\r\n\r\n// The live [[`QBoard`]] instance, exposed to the public as a basic developer interface.\r\n// Technically, the developer-user gets less control over private fields,\r\n// but from a power user standpoint this is likely not an issue;\r\n// no user should be writing scripts that depend on private fields.\r\nwindow.qboard = new QBoard(\r\n  document.querySelector(\"#QBoard\"),\r\n  document.querySelector(\"#BaseQBoard\"),\r\n  1600,\r\n  900\r\n);\r\n\r\nReactDOM.render(\r\n  <Overlay qboard={window.qboard} />,\r\n  document.querySelector(\"#Overlay\")\r\n);\r\n","import { fabric } from \"fabric\";\r\nimport { Network } from \"@mehra/ts\";\r\n\r\nimport instantiateTools, { Tool, Tools } from \"./tools\";\r\nimport Page from \"./page\";\r\nimport Pages from \"./pages\";\r\nimport FileHandler, { JSONReader } from \"./files\";\r\nimport HistoryHandler from \"./history\";\r\nimport ClipboardHandler from \"./clipboard\";\r\nimport StyleHandler, { Dash, Fill, Stroke, Style } from \"./styles\";\r\nimport ActionHandler from \"./action\";\r\nimport KeyboardHandler, { KeyMap } from \"./keyboard\";\r\nimport { HTMLChildElement } from \"../types/html\";\r\nimport {\r\n  FabricIEvent,\r\n  GuaranteedIObjectOptions,\r\n  isFabricCollection,\r\n  ObjectId,\r\n  PathEvent,\r\n} from \"../types/fabric\";\r\n\r\ntype Async<T = void> = T | Promise<T>;\r\n\r\ntype FabricHandler<T extends fabric.IEvent = fabric.IEvent> = (e: T) => Async;\r\nimport AssertType from \"../types/assert\";\r\n\r\nexport interface QBoardState {\r\n  dragActive: boolean;\r\n  currentPage: number;\r\n  totalPages: number;\r\n  currentStyle: Style;\r\n  canUndo: boolean;\r\n  canRedo: boolean;\r\n  keyMap: KeyMap;\r\n}\r\n\r\nexport default class QBoard {\r\n  baseCanvas: Page;\r\n  canvas: Page;\r\n  pages: Pages;\r\n  files: FileHandler;\r\n  history: HistoryHandler;\r\n  clipboard: ClipboardHandler;\r\n  style: StyleHandler;\r\n  action: ActionHandler;\r\n  keyboard: KeyboardHandler;\r\n\r\n  tools: Tools;\r\n  activeTool: Tool;\r\n  currentStyle: Style = {\r\n    dash: Dash.Solid,\r\n    stroke: Stroke.Black,\r\n    fill: Fill.Transparent,\r\n  };\r\n  readonly drawerOptions: GuaranteedIObjectOptions = {\r\n    fill: \"transparent\",\r\n    stroke: \"#000000\",\r\n    strokeWidth: 4,\r\n    selectable: false,\r\n    strokeDashArray: [0, 0],\r\n    strokeUniform: true,\r\n  };\r\n\r\n  resizeCooldown: NodeJS.Timeout | undefined;\r\n  currentObject: fabric.Object | undefined;\r\n  dragActive = false;\r\n  isDown = false;\r\n  strict = false;\r\n  callback: ((state: QBoardState) => void) | undefined;\r\n\r\n  /**\r\n   * Intentionally mutable global state object\r\n   */\r\n  public globalState: {\r\n    /**\r\n     * A ref to the global input element used for file input\r\n     */\r\n    fileInputRef?: React.RefObject<HTMLInputElement>;\r\n    toggleHelpModal?: () => void;\r\n  } = {};\r\n\r\n  constructor(\r\n    public canvasElement: HTMLCanvasElement & HTMLChildElement,\r\n    public baseCanvasElement: HTMLCanvasElement & HTMLChildElement,\r\n    public canvasWidth: number,\r\n    public canvasHeight: number\r\n  ) {\r\n    const queryParams = new URLSearchParams(window.location.search);\r\n\r\n    this.baseCanvas = new Page(baseCanvasElement, {\r\n      backgroundColor: \"white\",\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n      targetFindTolerance: 15,\r\n    });\r\n    this.canvas = new Page(canvasElement, {\r\n      renderOnAddRemove: false,\r\n      selection: false,\r\n    });\r\n    this.pages = new Pages(\r\n      this.baseCanvas,\r\n      this.canvasWidth,\r\n      this.canvasHeight,\r\n      this.updateState\r\n    );\r\n\r\n    {\r\n      const jsonLink = queryParams.get(\"json\");\r\n      if (jsonLink !== null)\r\n        Network.loadJSON(jsonLink)\r\n          .then(JSONReader.readParsed)\r\n          .then(this.pages.overwritePages)\r\n          // eslint-disable-next-line no-console\r\n          .catch(console.error);\r\n    }\r\n\r\n    this.files = new FileHandler(this.pages);\r\n    this.history = new HistoryHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.updateState\r\n    );\r\n    this.clipboard = new ClipboardHandler(\r\n      this.baseCanvas,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.canvasWidth,\r\n      this.canvasHeight\r\n    );\r\n    this.style = new StyleHandler(\r\n      this.currentStyle,\r\n      this.drawerOptions,\r\n      this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n      this.updateState\r\n    );\r\n    this.tools = instantiateTools(\r\n      this.baseCanvas,\r\n      this.history,\r\n      this.clipboard\r\n    );\r\n    this.action = new ActionHandler(\r\n      this.switchTool,\r\n      this.tools,\r\n      this.currentStyle,\r\n      this.pages,\r\n      this.files,\r\n      this.history,\r\n      this.clipboard,\r\n      this.style.set,\r\n      this.globalState\r\n    );\r\n    this.keyboard = new KeyboardHandler(\r\n      this.action.doAction,\r\n      (strict: boolean) => (this.strict = strict),\r\n      this.updateState\r\n    );\r\n\r\n    // an instance which has no effect (deactivate method is trivial)\r\n    this.activeTool = new Tool(this.baseCanvas, this.history, this.clipboard);\r\n    void this.switchTool();\r\n\r\n    void this.windowResize();\r\n\r\n    window.onresize = this.windowResize;\r\n    window.onbeforeunload = () => this.baseCanvas.modified || null;\r\n    {\r\n      /* eslint-disable @typescript-eslint/ban-ts-comment */\r\n      this.canvas.on(\"mouse:down\", this.mouseDown);\r\n      this.canvas.on(\"mouse:move\", this.mouseMove);\r\n      this.canvas.on(\"mouse:up\", this.mouseUp);\r\n\r\n      this.baseCanvas.on(\"dragenter\", () => this.setDragActive(true));\r\n      this.baseCanvas.on(\"dragleave\", () => this.setDragActive(false));\r\n      this.baseCanvas.on(\"drop\", this.drop);\r\n\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"path:created\", this.pathCreated);\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"selection:created\", this.selectionCreated);\r\n      // @ts-ignore\r\n      this.baseCanvas.on(\"object:modified\", this.objectModified);\r\n      this.baseCanvas.on(\"mouse:move\", this.updateCursor);\r\n      /* eslint-enable @typescript-eslint/ban-ts-comment */\r\n    }\r\n  }\r\n\r\n  updateState = (): void => {\r\n    this?.callback?.({\r\n      dragActive: this.dragActive,\r\n      currentPage: this.pages.currentIndex + 1,\r\n      totalPages: this.pages.pagesJSON.length,\r\n      currentStyle: this.currentStyle,\r\n      canUndo: this.history.history.length > 0,\r\n      canRedo: this.history.redoStack.length > 0,\r\n      keyMap: this.keyboard.keyMap,\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Assumes no two instances are the same tool\r\n   */\r\n  switchTool = async (tool: Tool = this.tools.Move): Promise<void> => {\r\n    // Reference equality because of assumption\r\n    if (tool === this.activeTool || !(await tool.activate())) return;\r\n\r\n    this.activeTool.deactivate();\r\n\r\n    if (tool.isBrush() || tool.requiresBase()) {\r\n      this.baseCanvas.activateSelection();\r\n      this.canvasElement.parentElement.style.display = \"none\";\r\n    } else {\r\n      this.baseCanvas.deactivateSelection();\r\n      this.canvasElement.parentElement.style.display = \"block\";\r\n    }\r\n\r\n    if (tool.isBrush()) {\r\n      await tool.setBrush(\r\n        this.baseCanvas.freeDrawingBrush as fabric.BaseBrush,\r\n        this.drawerOptions\r\n      );\r\n    }\r\n\r\n    this.activeTool = tool;\r\n\r\n    this.baseCanvas.isDrawingMode = this.activeTool.isBrush();\r\n\r\n    this.updateState();\r\n  };\r\n\r\n  windowResize = (): void => {\r\n    if (this.resizeCooldown !== undefined) clearTimeout(this.resizeCooldown);\r\n    this.resizeCooldown = setTimeout(() => {\r\n      this.canvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n      this.baseCanvas.fitToWindow(this.canvasWidth, this.canvasHeight);\r\n    }, 100);\r\n  };\r\n\r\n  mouseDown: FabricHandler = async (e) => {\r\n    if (!this.activeTool.isDrawing()) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n    this.isDown = true;\r\n    this.currentObject = await this.activeTool.draw(x, y, this.drawerOptions);\r\n    (this.currentObject as ObjectId).id = this.baseCanvas.getNextId();\r\n    this.canvas.add(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseMove: FabricHandler = async (e) => {\r\n    if (!(this.activeTool.isDrawing() && this.isDown)) return;\r\n\r\n    const { x, y } = this.canvas.getPointer(e.e);\r\n\r\n    if (this.currentObject !== undefined)\r\n      await this.activeTool.resize?.(this.currentObject, x, y, this.strict);\r\n\r\n    this.canvas.requestRenderAll();\r\n  };\r\n\r\n  mouseUp: FabricHandler = () => {\r\n    if (!this.activeTool.isDrawing()) return;\r\n\r\n    this.isDown = false;\r\n    this.baseCanvas.add(fabric.util.object.clone(this.currentObject));\r\n    this.baseCanvas.requestRenderAll();\r\n\r\n    AssertType<fabric.Object>(this.currentObject); // can do this because mouseDown sets this\r\n\r\n    this.canvas.remove(this.currentObject);\r\n    this.canvas.requestRenderAll();\r\n    this.history.add([this.currentObject]);\r\n  };\r\n\r\n  setDragActive = (state: boolean): void => {\r\n    this.dragActive = state;\r\n    this.updateState();\r\n  };\r\n\r\n  drop: FabricHandler = async (iEvent) => {\r\n    iEvent.e.stopPropagation();\r\n    iEvent.e.preventDefault();\r\n    await this.updateCursor(iEvent);\r\n    this.setDragActive(false);\r\n\r\n    const historyCommand = await this.files.processFiles(\r\n      (iEvent.e as DragEvent).dataTransfer!.files\r\n    );\r\n    this.history.execute(historyCommand);\r\n  };\r\n\r\n  pathCreated: FabricHandler<PathEvent> = (e) => {\r\n    if (this.activeTool.isBrush()) this.activeTool.pathCreated(e);\r\n  };\r\n\r\n  selectionCreated: FabricHandler<FabricIEvent> = (e) => {\r\n    if (this.history.locked) return;\r\n    return this.history.store(e.selected);\r\n  };\r\n\r\n  objectModified: FabricHandler<FabricIEvent> = (e) => {\r\n    const objects = isFabricCollection(e.target)\r\n      ? e.target.getObjects()\r\n      : [e.target];\r\n    this.history.modify(objects);\r\n    this.history.store(objects);\r\n  };\r\n\r\n  updateCursor: FabricHandler = (iEvent) => {\r\n    const { x, y } = this.baseCanvas.getPointer(iEvent.e);\r\n    this.baseCanvas.cursor = { x, y };\r\n  };\r\n}\r\n"],"sourceRoot":""}